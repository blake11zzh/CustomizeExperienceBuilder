"use strict";(self.webpackChunkarcgis_experience_builder_design_system=self.webpackChunkarcgis_experience_builder_design_system||[]).push([[4572],{"../jimu-data-source/index.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Vp:()=>SceneLayerDataSourceImpl,Ay:()=>jimu_data_source});var jimu_core=__webpack_require__("../jimu-core/index.tsx");class abstract_data_record_AbstractDataRecord{clone(deep){const shallowClone=jimu_core.CM0.clone(this);return deep?(shallowClone.setData(jimu_core.CM0.cloneDeep(this.getData())),shallowClone):shallowClone}getFieldValue(jimuFieldName){return this.getData()[jimuFieldName]}getDateFieldValue(jimuFieldName){return this.getFieldValue(jimuFieldName)}getFormattedFieldValue(jimuFieldName,intl){const field=this.dataSource.getSchema().fields[jimuFieldName];if(!field)return this.getFieldValue(jimuFieldName);if(field.format)switch(field.type){case jimu_core.Eo3.Date:return this.formatDateField(this.getDateFieldValue(jimuFieldName),field.format.dateFormat,intl);case jimu_core.Eo3.Number:return this.formatNumberField(this.getFieldValue(jimuFieldName),field.format.places,field.format.digitSeparator,intl);default:return this.getFieldValue(jimuFieldName)}else switch(field.type){case jimu_core.Eo3.Date:return this.formatDateField(this.getDateFieldValue(jimuFieldName),null,intl);case jimu_core.Eo3.Number:return null!==this.getFieldValue(jimuFieldName)&&void 0!==this.getFieldValue(jimuFieldName)?intl.formatNumber(this.getFieldValue(jimuFieldName)):null;default:return this.getFieldValue(jimuFieldName)}}convertBeforeMappingDataToData(dataBeforeMapping){const reversedData={},reversedSchema=this.dataSource.getReversedConfigSchema();return Object.keys(dataBeforeMapping).forEach((fieldName=>{const fields=reversedSchema&&reversedSchema.fields&&reversedSchema.fields[fieldName];fields?fields.forEach((f=>{reversedData[f.jimuName]=dataBeforeMapping[fieldName]})):reversedData[fieldName]=dataBeforeMapping[fieldName]})),reversedData}convertDataToDataBeforeMapping(data){const dataBeforeMapping={},schema=this.dataSource.getSchema();return Object.keys(data).forEach((jimuFieldName=>{const fieldName=schema&&schema.fields&&schema.fields[jimuFieldName]?schema.fields[jimuFieldName].name:jimuFieldName;dataBeforeMapping[fieldName]=data[jimuFieldName]})),dataBeforeMapping}getFormattedData(intl){const ret={};return Object.keys(this.getData()).forEach((fieldName=>{ret[fieldName]=this.getFormattedFieldValue(fieldName,intl)})),ret}formatDateField(value,esriDateFormat,intl){if(!value)return null;let label="";return label=esriDateFormat?jimu_core.sUN.formatDateValueByEsriFormat(value,esriDateFormat,intl):intl.formatDate(value,{dateStyle:"short",timeStyle:"short"}),label}formatNumberField(value,places,digitSeparator,intl){if(null==value)return null;const num=new Number(value);return digitSeparator?intl.formatNumber(value,{maximumFractionDigits:places,minimumFractionDigits:places}):num.toFixed(places)}set dataSource(d){this._dataSource=d}get dataSource(){return this._dataSource}}class SimpleDataRecordImpl extends abstract_data_record_AbstractDataRecord{constructor(data,dataSource,isBeforeMappingData=!0){super(),this.dataSource=dataSource,this.data=isBeforeMappingData?this.convertBeforeMappingDataToData(data):data}getData(){return this.data}setData(data){this.data=data}getDataBeforeMapping(){return this.convertDataToDataBeforeMapping(this.data)}toJson(){return this.data}getId(){return this.data.id}setId(){return null}getGeometry(){return null}getRawGeometry(){return null}setGeometry(geo){return null}}var __awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class FeatureDataRecordImpl extends abstract_data_record_AbstractDataRecord{constructor(feature,dataSource,options){super(),this._id=null,this.dataSource=dataSource,null==feature.attributes[dataSource.getIdField()]&&(this._id=(0,jimu_core.nms)()),!1!==(null==options?void 0:options.isBeforeMappingData)?(feature.attributes=this.convertBeforeMappingDataToData(feature.attributes),this.feature=feature):this.feature=feature,this.hasFullGeometry=!1!==(null==options?void 0:options.hasFullGeometry),this.setProxyForData(),this.fillGeometry()}setProxyForData(){var _a;if(!(null===(_a=this.feature)||void 0===_a?void 0:_a.attributes)||!this.dataSource)return;if(this.feature.attributes.is_record_data_a_proxy&&this.feature.attributes.data_source_id_for_record===this.dataSource.id)return;const dataSource=this.dataSource;this.feature.attributes=new Proxy(this.feature.attributes.is_record_data_a_proxy?Object.assign({},this.feature.attributes):this.feature.attributes,{get(target,prop){var _a;let value;return prop in target?value=target[prop]:"string"==typeof prop&&(null===(_a=dataSource.getSchema())||void 0===_a?void 0:_a.fields)&&prop in dataSource.getSchema().fields?dataSource.loadMissingFields(Object.assign(Object.assign({},dataSource.getCurrentQueryParams()),{outFields:[prop]}),!0):"data_source_id_for_record"===prop?value=dataSource.id:"is_record_data_a_proxy"===prop&&(value=!0),value}})}set dataSource(d){this._dataSource=d,this.setProxyForData()}get dataSource(){return this._dataSource}fillGeometry(){var _a,_b;if(!this.feature.geometry)return;const ds=this.dataSource;this.feature.geometry.spatialReference||(this.feature.geometry.spatialReference=null===(_b=null===(_a=ds.getLayerDefinition())||void 0===_a?void 0:_a.extent)||void 0===_b?void 0:_b.spatialReference)}queryAttachments(attachmentTypes){let featureLayerUrl=null;const featureLayerDs=this.dataSource;if(featureLayerUrl=featureLayerDs&&featureLayerDs.getMainDataSource().url,!featureLayerUrl)return Promise.resolve([]);const attachmentQuery={attachmentTypes,url:featureLayerUrl,featureId:this.getId()};return this._queryAllAttachmentsPromise||(this._queryAllAttachmentsPromise=jimu_core.ZkX.queryAllAttachments(attachmentQuery)),this._queryAllAttachmentsPromise.then((attachmentInfos=>__awaiter(this,void 0,void 0,(function*(){return this.attachmentInfos=attachmentInfos,jimu_core.ZkX.filterAttachments(attachmentInfos,attachmentQuery)}))))}fetchSymbolPreviewHTML(){return this._isGraphicFeature()?(this._getSymbolPreviewHTMLPromise||(this._getSymbolPreviewHTMLPromise=(0,jimu_core.e$n)(["esri/symbols/support/symbolUtils"]).then((modules=>{let symbolUtils=null;return[symbolUtils]=modules,symbolUtils.getDisplayedSymbol(this.feature).then((symbol=>{const nodeHtml=document.createElement("div");return nodeHtml.className="w-100 h-100 d-flex justify-content-center align-items-center",symbolUtils.renderPreviewHTML(symbol,{node:nodeHtml})}))}))),this._getSymbolPreviewHTMLPromise):Promise.resolve(null)}getData(){return this.feature.attributes}setData(data){this.feature.attributes=data,this.setProxyForData(),this._getSymbolPreviewHTMLPromise=null,this._queryAllAttachmentsPromise=null}clone(deep){const shallowClone=jimu_core.CM0.clone(this);return deep?("esri.Graphic"===this.feature.declaredClass?shallowClone.feature=this.feature.clone():shallowClone.feature=jimu_core.CM0.cloneDeep(this.feature),shallowClone):shallowClone}getDateFieldValue(jimuFieldName){const value=this.getFieldValue(jimuFieldName);return jimu_core.ZkX.getDateFieldValue(value,this.dataSource)}getFormattedFieldValue(jimuFieldName,intl){const ds=this.dataSource,layerDefinition=ds&&ds.getLayerDefinition&&ds.getLayerDefinition();if(!layerDefinition)return super.getFormattedFieldValue(jimuFieldName,intl);const valueObj=jimu_core.ZkX.getDisplayValueForCodedValueOrSubtype(layerDefinition,jimuFieldName,this.getData());return valueObj.isCodedValueOrSubtype?valueObj.displayValue:super.getFormattedFieldValue(jimuFieldName,intl)}getDataBeforeMapping(){return this.convertDataToDataBeforeMapping(this.getData())}getOriginData(){const cloneFeature=Object.assign({},this.feature);return cloneFeature.attributes=this.convertDataToDataBeforeMapping(this.getData()),cloneFeature}toJson(){return this.feature}getId(){return this._id||this.feature.attributes[this.dataSource.getIdField()]+""}setId(id){}getGeometry(){var _a;return"esri.Graphic"===this.feature.declaredClass?null===(_a=this.feature.geometry)||void 0===_a?void 0:_a.toJSON():this.feature.geometry}getRawGeometry(){return this.feature.geometry}setGeometry(geo){var _a,_b,_c;if("esri.Graphic"===(null===(_a=this.feature)||void 0===_a?void 0:_a.declaredClass)){const Geometry=jimu_core.SRz.getModuleSync("esri/geometry/Geometry");this.feature.geometry=(null===(_b=null==geo?void 0:geo.declaredClass)||void 0===_b?void 0:_b.includes("esri.geometry"))?geo:(null==Geometry?void 0:Geometry.fromJSON(geo))||geo}else this.feature.geometry=(null===(_c=null==geo?void 0:geo.declaredClass)||void 0===_c?void 0:_c.includes("esri.geometry"))?geo.toJSON():geo}setFeature(feature){this.feature=feature,this.fillGeometry()}getFeature(){return this.feature}getJSAPIGraphic(){return jimu_core.ZkX.changeToJSAPIGraphic(this.feature)}_isGraphicFeature(){var _a;return!!(null===(_a=null==this?void 0:this.feature)||void 0===_a?void 0:_a.layer)}}var abstract_data_source_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class abstract_data_source_AbstractDataSource{constructor(options){if(this.records=[],this.dataSourceManager=options.dataSourceManager,Object.assign(this,options),this.originDataSourceJson=options.dataSourceJson,options.dataSourceJson)this.isDataView=!1,this.isLocal=!1,options.dataSourceJson.url&&(this.url=options.dataSourceJson.url);else{if(!options.belongToDataSource)return void console.error("bad DataSourceConstructorOptions.");options.localId?(this.isLocal=!0,this.isDataView=!1):(this.isLocal=!1,this.isDataView=!0)}this.getDataSourceJson().isDataInDataSourceInstance&&(this.sourceRecords=options.sourceRecords,this.url=null),this.isLocal?this.listenSelection=!1:this.listenSelection=!0}ready(){return Promise.resolve()}isDataSourceSet(){return!!this.getChildDataSources}get url(){return this._url}set url(u){this.getDataSourceJson().isDataInDataSourceInstance||(this._url=u)}isInAppConfig(){var _a,_b;return!!(null===(_a=(0,jimu_core.Vp3)().getState().appConfig.dataSources)||void 0===_a?void 0:_a[(null===(_b=this.getRootDataSource())||void 0===_b?void 0:_b.id)||this.getMainDataSource().id])}getLabel(){if(this.isLocal)return this.belongToDataSource.getLabel();if(this.isDataView){if(this.dataViewId===jimu_core.aH5.VA&&this.getDataSourceJson().isOutputFromWidget)return jimu_core.Ruy.getIntl().formatMessage({id:"outputView"},{dataSourceLabel:this.belongToDataSource.getLabel()});const mainDsJson=this.getMainDataSource().getDataSourceJson(),dataViewJson=(null==mainDsJson?void 0:mainDsJson.dataViews)&&mainDsJson.dataViews[this.dataViewId];return(null==dataViewJson?void 0:dataViewJson.label)||this.belongToDataSource.getLabel()}return this.getDataSourceJson().label||this.getSchema().label||this.getDataSourceJson().sourceLabel}getDataSourceJson(){if(this.isDataView||this.isLocal){let dsJson=this.getMainDataSource().getDataSourceJson();return this.dataViewId===jimu_core.aH5.W7&&(dsJson=dsJson.set("isDataInDataSourceInstance",!0)),dsJson}return this.dataSourceJson}setDataSourceJson(dsJson){dsJson?this.dataSourceJson?this.dataSourceJson=this.traverseToMergeDataSourceJson(this.dataSourceJson,dsJson):this.dataSourceJson=dsJson:this.dataSourceJson=this.originDataSourceJson}traverseToMergeDataSourceJson(baseDsJson,newDsJson){if(!baseDsJson&&!newDsJson)return null;if(!baseDsJson)return newDsJson;if(!newDsJson)return baseDsJson;const currentDs=this.dataSourceManager.getDataSource(baseDsJson.id);if(!currentDs)return baseDsJson;let mergedDsJson=baseDsJson.merge(newDsJson.asMutable({deep:!0}));return["label","isHidden","useFields","query","dataViews","childDataSourceJsons","schema","url","itemId","portalUrl"].forEach((key=>{newDsJson[key]||(mergedDsJson=mergedDsJson.without(key)),newDsJson[key]&&"schema"===key&&(mergedDsJson=mergedDsJson.set("schema",newDsJson.schema)),!newDsJson[key]||"url"!==key&&"portalUrl"!==key&&"itemId"!==key||(mergedDsJson=mergedDsJson.set(key,newDsJson[key]),currentDs[key]=newDsJson[key],currentDs.canSaveSourceRecords()&&currentDs.getAllDerivedDataSources().forEach((ds=>{ds[key]=newDsJson[key]}))),baseDsJson[key]&&"useFields"===key&&(mergedDsJson=newDsJson.schema?mergedDsJson.set("useFields",baseDsJson.useFields.filter((jimuName=>{var _a;return!!(null===(_a=newDsJson.schema.fields)||void 0===_a?void 0:_a[jimuName])}))):mergedDsJson.set("useFields",baseDsJson.useFields))})),mergedDsJson.childDataSourceJsons&&Object.keys(mergedDsJson.childDataSourceJsons).forEach((jimuChildId=>{var _a;const mergedChildDsJson=currentDs.traverseToMergeDataSourceJson(null===(_a=null==baseDsJson?void 0:baseDsJson.childDataSourceJsons)||void 0===_a?void 0:_a[jimuChildId],newDsJson.childDataSourceJsons[jimuChildId]);mergedChildDsJson&&(mergedDsJson=mergedDsJson.setIn(["childDataSourceJsons",jimuChildId],mergedChildDsJson))})),mergedDsJson}getSchema(){return this.isDataView||this.isLocal?this.getMainDataSource().getSchema():this.schema||{}}getSelectedFields(){var _a,_b,_c,_d;let outFields;if(this.isLocal)return this.belongToDataSource.getSelectedFields();if(this.isSelectionView()||this.dataViewId===jimu_core.aH5.VA)return this.getMainDataSource().getSelectedFields();const allFields=(null===(_a=this.getSchema())||void 0===_a?void 0:_a.fields)?Object.keys(this.getSchema().fields):[];if(outFields=this.isDataView?null===(_c=null===(_b=this.getDataSourceJson().dataViews)||void 0===_b?void 0:_b[this.dataViewId])||void 0===_c?void 0:_c.outFields:null===(_d=this.getDataSourceJson().query)||void 0===_d?void 0:_d.outFields,!outFields&&!this.selectedFields)return allFields;let realSelectedFields=allFields;return outFields&&(realSelectedFields=realSelectedFields.filter((fName=>outFields.includes(fName)))),this.selectedFields&&(realSelectedFields=realSelectedFields.filter((fName=>this.selectedFields.includes(fName)))),realSelectedFields}getAllUsedFields(options){let usedFields;return usedFields="*"===this.getLoadOnDemandUsedFields()?this.getLoadOnDemandUsedFields(options):this.mergeUsedFields(this.getLoadOnDemandUsedFields(options),this.getConfigUsedFields(options)),"debug"===(null==options?void 0:options.logLevel)&&"*"===usedFields&&console.warn("All used fields are * since used fields length equals schema fields length."),usedFields}_printUsedFieldsDetail(options){this.getAllUsedFields(Object.assign({logLevel:"debug",excludeWidgetsDoNotUseDsToQuery:!0},options))}getLoadOnDemandUsedFields(options){return"debug"===(null==options?void 0:options.logLevel)&&console.log("Load on demand fields are:",this.loadOnDemandFields),this.loadOnDemandFields}getConfigUsedFields(options){var _a,_c,_d,_e,_f,_g;if(this.isLocal)return[];let addedFieldsInPopupInfo=!1;const addPopupInfoFields=(usedFields,widgetId)=>{var _b;if(addedFieldsInPopupInfo)return;addedFieldsInPopupInfo=!0;const popupInfoFields=(null===(_b=this.getPopupInfoFields)||void 0===_b?void 0:_b.call(this))||[];popupInfoFields.length>0?usedFields.push(...popupInfoFields):("debug"===(null==options?void 0:options.logLevel)&&console.warn("Config used fields are * since widget uses popup info fields, but can not find them.",widgetId),usedFields.push("*"))};if(!this.isInAppConfig()){const usedFields=[];return addPopupInfoFields(usedFields),0===usedFields.length?"*":usedFields}if(this.dataViewId===jimu_core.aH5.kf)return window.jimuConfig.isInBuilder?"*":null===(_a=this.getMainDataSource().getDataView(jimu_core.aH5.W7))||void 0===_a?void 0:_a.getAllUsedFields();"debug"===(null==options?void 0:options.logLevel)&&console.group("Config used fields");let hasWidgetsSyncWithMap=!1;const rootDs=this.getRootDataSource()||(null===(_e=null===(_d=null===(_c=this.getAssociatedDataSource)||void 0===_c?void 0:_c.call(this))||void 0===_d?void 0:_d.getRootDataSource)||void 0===_e?void 0:_e.call(_d)),widgets=null===(_f=(0,jimu_core.Vp3)().getState().appConfig)||void 0===_f?void 0:_f.widgets,messages=null===(_g=(0,jimu_core.Vp3)().getState().appConfig)||void 0===_g?void 0:_g.messageConfigs;let actionsArr=[];messages&&Object.values(messages).forEach((m=>{var _a,_b;m.actions&&(actionsArr=actionsArr.concat(null===(_b=(_a=m.actions).asMutable)||void 0===_b?void 0:_b.call(_a)))}));const widgetsArr=(widgets?Object.values(widgets):[]).filter((w=>{var _a;return null===(_a=w.useDataSourcesEnabled)||void 0===_a||_a})),jsonsWithUseDss=widgetsArr.concat(actionsArr),usedFields=[];jsonsWithUseDss.every((w=>{var _a,_b,_c;!hasWidgetsSyncWithMap&&(null==rootDs?void 0:rootDs.map)&&(null===(_a=w.useMapWidgetIds)||void 0===_a?void 0:_a.some((mapWidgetId=>{var _a,_b;return null===(_b=null===(_a=null==widgets?void 0:widgets[mapWidgetId])||void 0===_a?void 0:_a.useDataSources)||void 0===_b?void 0:_b.some((u=>u.dataSourceId===rootDs.id))})))&&(hasWidgetsSyncWithMap=!0);const excludeTheWidgetForCurrentDs=(null==options?void 0:options.excludeWidgetsDoNotUseDsToQuery)&&(null===(_c=null===(_b=w.manifest)||void 0===_b?void 0:_b.properties)||void 0===_c?void 0:_c.notAutoLoadUsedFieldsData);return w.useDataSources&&w.useDataSources.every((u=>{var _a,_b,_c,_e,_f;if((null==u?void 0:u.dataSourceId)!==(null===(_a=this.getSelectionDataView())||void 0===_a?void 0:_a.id)&&excludeTheWidgetForCurrentDs)return!0;const useCurrentDataSource=(null==u?void 0:u.dataSourceId)===this.id,useSelectionViewOfCurrentDataSource=(null==u?void 0:u.dataSourceId)===(null===(_b=this.getSelectionDataView())||void 0===_b?void 0:_b.id),useOtherViewsDerivedFromSameMainDsWithSelectionView=this.isSelectionView()&&(null==u?void 0:u.mainDataSourceId)===this.getMainDataSource().id,useOriginDataSource=this.getDataSourceJson().isOutputFromWidget&&!this.getDataSourceJson().schema&&1===(null===(_c=this.getDataSourceJson().originDataSources)||void 0===_c?void 0:_c.length)&&(null==u?void 0:u.dataSourceId)===this.getDataSourceJson().originDataSources[0].dataSourceId,useOutputView=this.getDataSourceJson().isOutputFromWidget&&!this.isDataView&&(null==u?void 0:u.mainDataSourceId)===this.getMainDataSource().id,useAssociatedDataSource=(null==u?void 0:u.dataSourceId)===(null===(_f=null===(_e=this.getAssociatedDataSource)||void 0===_e?void 0:_e.call(this))||void 0===_f?void 0:_f.id);return(useCurrentDataSource||useSelectionViewOfCurrentDataSource||useOtherViewsDerivedFromSameMainDsWithSelectionView||useOriginDataSource||useOutputView||useAssociatedDataSource)&&(u.fields&&usedFields.push(...u.fields),u.useFieldsInPopupInfo&&addPopupInfoFields(usedFields,w.id||w.actionId),u.useFieldsInSymbol&&("debug"===(null==options?void 0:options.logLevel)&&console.warn("Config used fields are * since widget uses symbol fields.",w.id||w.actionId),usedFields.push("*"))),!usedFields.includes("*")})),"debug"===(null==options?void 0:options.logLevel)&&console.log("Accumulated config used fields are:",usedFields,w.id||w.actionId),!usedFields.includes("*")})),hasWidgetsSyncWithMap&&(addPopupInfoFields(usedFields),"debug"===(null==options?void 0:options.logLevel)&&console.log("Add popup info fields because widgets sync with the map that is the root data source of the current data source,",usedFields));let configUsedFields=usedFields.includes("*")?"*":Array.from(new Set(usedFields));return"*"!==configUsedFields&&(configUsedFields=configUsedFields.filter((f=>{var _a,_b;return!!(null===(_b=null===(_a=this.getSchema())||void 0===_a?void 0:_a.fields)||void 0===_b?void 0:_b[f])}))),"debug"===(null==options?void 0:options.logLevel)&&(console.log("Final config used fields are:",usedFields),console.groupEnd()),configUsedFields}updateLoadOnDemandFields(usedFields){usedFields&&(this.loadOnDemandFields=this.mergeUsedFields(this.loadOnDemandFields,this.findMissingFields(usedFields,this.getConfigUsedFields())),"*"!==this.loadOnDemandFields&&(this.loadOnDemandFields=this.loadOnDemandFields.filter((f=>{var _a,_b;return!!(null===(_b=null===(_a=this.getSchema())||void 0===_a?void 0:_a.fields)||void 0===_b?void 0:_b[f])}))))}mergeUsedFields(baseUsedFields,newUsedFields){if("*"===baseUsedFields||"*"===newUsedFields)return"*";if(Array.isArray(baseUsedFields)&&Array.isArray(newUsedFields)){let res=Array.from(new Set(baseUsedFields.concat(newUsedFields))).filter((f=>!!f));return res.length===Object.keys(this.getSchema().fields).length&&(res="*"),res}return baseUsedFields||newUsedFields||[]}missingSomeFields(usedFields,currentFields){return"*"!==currentFields&&this.findMissingFields(usedFields,currentFields).length>0}findMissingFields(usedFields,currentFields){const selectedFields=this.getSelectedFields(),f1="*"===usedFields?selectedFields:usedFields,f2="*"===currentFields?selectedFields:currentFields,missingFields=[];return null==f1||f1.forEach((f=>{(null==f2?void 0:f2.includes(f))||missingFields.push(f)})),missingFields}findJimuFieldName(originFieldName){const schema=this.getSchema();let jimuFieldName=null;return(null==schema?void 0:schema.fields)&&(jimuFieldName=Object.keys(schema.fields).find((jimuFieldName=>schema.fields[jimuFieldName].name===originFieldName))),jimuFieldName}setSelectedFields(jimuNames){this.selectedFields=jimuNames}setSchema(schema){this.schema=schema}fetchSchema(){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){return yield Promise.resolve((0,jimu_core.J3Z)({}))}))}getFetchedSchema(){return this.isDataView||this.isLocal?this.getMainDataSource().getFetchedSchema():this.fetchedSchema}setFetchedSchema(fetchedSchema){this.fetchedSchema=fetchedSchema}getGeometryType(){return null}getReversedConfigSchema(){if(this.isDataView||this.isLocal)return this.getMainDataSource().getReversedConfigSchema();if(this.reverseSchema)return this.reverseSchema;if(this.isDataSourceSet()){const schema=this.getDataSourceJson().schema,rSchema={childSchemas:{}};if(!schema)return(0,jimu_core.J3Z)({});if(!schema.childSchemas)return(0,jimu_core.J3Z)({label:schema.label,childId:schema.childId,jimuChildId:schema.jimuChildId});Object.keys(schema.childSchemas).forEach((jimuChildId=>{const actualChildId=schema.childSchemas[jimuChildId].childId;rSchema.childSchemas[actualChildId]?rSchema.childSchemas[actualChildId].push(this.getOneReversedConfigSchema(schema.childSchemas[jimuChildId])):rSchema.childSchemas[actualChildId]=[this.getOneReversedConfigSchema(schema.childSchemas[jimuChildId])]})),this.reverseSchema=(0,jimu_core.J3Z)(rSchema)}else this.reverseSchema=this.getOneReversedConfigSchema(this.getDataSourceJson().schema);return this.reverseSchema}setRecords(records){this.records=records,this.addVersion()}getOneReversedConfigSchema(schema){const reversedSchema={};return schema?(reversedSchema.fields={},Object.keys(schema.fields).forEach((jimuName=>{const field=schema.fields[jimuName].asMutable({deep:!0});reversedSchema.fields[field.name]?reversedSchema.fields[field.name].push(field):reversedSchema.fields[field.name]=[field]})),schema.childId&&(reversedSchema.childId=schema.childId),schema.jimuChildId&&(reversedSchema.jimuChildId=schema.jimuChildId),(0,jimu_core.J3Z)(reversedSchema)):(0,jimu_core.J3Z)(reversedSchema)}getStatus(){return(0,jimu_core.Vp3)().getState().dataSourcesInfo[this.id]&&(0,jimu_core.Vp3)().getState().dataSourcesInfo[this.id].status}setStatus(status){(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.dataSourceStatusChanged(this.id,status))}getCountStatus(){return(0,jimu_core.Vp3)().getState().dataSourcesInfo[this.id]&&(0,jimu_core.Vp3)().getState().dataSourcesInfo[this.id].countStatus}setCountStatus(status){(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.dataSourceCountStatusChanged(this.id,status))}getVersion(){var _a;return null===(_a=(0,jimu_core.Vp3)().getState().dataSourcesInfo[this.id])||void 0===_a?void 0:_a.version}addVersion(){(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.dataSourceVersionAdded(this.id))}getSourceVersion(){var _a;return this.canSaveSourceRecords()?null===(_a=(0,jimu_core.Vp3)().getState().dataSourcesInfo[this.id])||void 0===_a?void 0:_a.sourceVersion:this.getMainDataSource().getSourceVersion()}addSourceVersion(){this.canSaveSourceRecords()&&(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.dataSourceSourceVersionAdded(this.id))}getSelectedRecordIdsFromInfo(){var _a,_b;return(null===(_b=null===(_a=(0,jimu_core.Vp3)().getState().dataSourcesInfo)||void 0===_a?void 0:_a[this.id])||void 0===_b?void 0:_b.selectedIds)||(0,jimu_core.J3Z)([])}getSelectOptionsFromInfo(){var _a,_b;return null===(_b=null===(_a=(0,jimu_core.Vp3)().getState().dataSourcesInfo)||void 0===_a?void 0:_a[this.id])||void 0===_b?void 0:_b.selectOptions}updateSelectionInfo(options,triggerDataSource){options&&(this.getListenSelection()||this.id===(null==triggerDataSource?void 0:triggerDataSource.id))&&(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.dataSourceSelectionChanged(this.id,options))}buildRecord(data){return new SimpleDataRecordImpl(data,this)}getRecords(){return this.records}getRecordsWithSelection(){return this.concatRecordsAndSelection(this.getSelectedRecords(),this.getRecords())}concatRecordsAndSelection(selectRecords,records){var _a;const newRecords=records||[];return null===(_a=null==selectRecords?void 0:selectRecords.reverse())||void 0===_a||_a.forEach((selectedRecord=>{(null==records?void 0:records.some((r=>(null==r?void 0:r.getId())===(null==selectedRecord?void 0:selectedRecord.getId()))))||newRecords.unshift(selectedRecord)})),newRecords}clearSourceRecordsNotAddVersion(){this.clearRecordsNotAddVersion(),this.sourceRecords=[]}clearSourceRecords(){this.clearSourceRecordsNotAddVersion(),this.addSourceVersion(),this.addVersion()}setSourceRecords(records){if(this.canSaveSourceRecords()){this.clearRecordsNotAddVersion();const resetSelectionInfo=!this.isSelectionView();resetSelectionInfo&&jimu_core.CM0.defer((()=>{this.updateSelectionInfo({widgetId:null,ids:[]},this.getMainDataSource())})),this.sourceRecords=records.filter((r=>!!r)).map((r=>(r.dataSource=this,r))),this.getAllDerivedDataSources().forEach((ds=>{ds.clearRecords(),resetSelectionInfo&&jimu_core.CM0.defer((()=>{ds.updateSelectionInfo({widgetId:null,ids:[]},ds.getMainDataSource())}))})),this.addSourceVersion(),this.addVersion()}}getSourceRecords(){var _a;if(!this.canSaveSourceRecords())return this.isLocalViewOfSelectionView()?this.belongToDataSource.getSourceRecords():this.getMainDataSource().getSourceRecords();let sourceRecords=this.sourceRecords||[];if(this.useNoSelectionView(this)){const noSelectionView=this.getMainDataSource().getDataView(jimu_core.aH5.kf);noSelectionView&&(sourceRecords=null===(_a=noSelectionView.getRecords())||void 0===_a?void 0:_a.map((r=>(r.dataSource=this,r))))}return sourceRecords}useNoSelectionView(dataSource=this){if(!(this.getMainDataSource().id===dataSource.getMainDataSource().id&&this.isDataView&&this.dataViewId===jimu_core.aH5.kf?this:dataSource.getMainDataSource().getDataView(jimu_core.aH5.kf)))return!1;const sourceRecords=dataSource.sourceRecords||[];return dataSource.isDataView&&dataSource.dataViewId===jimu_core.aH5.W7&&0===sourceRecords.length&&0===dataSource.getMainDataSource().getSelectedRecordIds().filter((id=>!!id)).length}canSaveSourceRecords(){return!this.isDataView&&!this.isLocal||this.isSelectionView()}getSelectionDataView(){const mainDsId=this.isDataView||this.isLocal?this.getMainDataSource().id:this.id;return this.dataSourceManager.getDataViewDataSource(mainDsId,jimu_core.aH5.W7)}getSelectedRecords(){const selectionDv=this.getSelectionDataView(),allSelectedRecords=selectionDv?selectionDv.getRecords():[],selectedRecordIdsInCurrentDs=this.getSelectedRecordIds();return allSelectedRecords.filter((r=>selectedRecordIdsInCurrentDs.includes(r.getId())))}getSelectedRecordIndexes(){if(!(0,jimu_core.Vp3)().getState().dataSourcesInfo[this.id])return[];const dsId=this.isDataView||this.isLocal?this.getMainDataSource().id:this.id;return(0,jimu_core.Vp3)().getState().dataSourcesInfo[dsId].selectedIds?(0,jimu_core.Vp3)().getState().dataSourcesInfo[dsId].selectedIds.asMutable().map((id=>this.getRecords().findIndex((record=>record.getId()===id)))):[]}getSelectedRecordIds(){return this.isSelectionView()?this.getMainDataSource().getSelectedRecordIdsFromInfo().asMutable():this.getSelectedRecordIdsFromInfo().asMutable()}nextRecord(){if(this.getSelectedRecordIndexes().length>1)return console.warn('method "nextRecord" only works when single record is selected'),null;if(this.getSelectedRecordIndexes().indexOf(this.getRecords().length-1))throw Error("Reach the end of data.");return(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.dataSourceSelectedIndexesChanged(this.id,[this.getSelectedRecordIndexes()[0]++])),this.getSelectedRecords()[0]}prevRecord(){if(this.getSelectedRecordIndexes().length>1)return console.warn('method "prevRecord" only works when single record is selected'),null;if(this.getSelectedRecordIndexes().indexOf(0))throw Error("Reach the start of data.");return(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.dataSourceSelectedIndexesChanged(this.id,[this.getSelectedRecordIndexes()[0]--])),this.getSelectedRecords()[0]}getRecord(index){return this.getRecords()[index]}getSourceRecord(index){return this.getSourceRecords()[index]}getRecordById(id){return this.getRecords().filter((record=>record&&record.getId()===id))[0]}getSourceRecordById(id){return this.getSourceRecords().filter((record=>record&&record.getId()===id))[0]}clearSelection(){this.copySelectionToDataView([]),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:[]})}updateSelectionInfoOfDerivedDssAndChangeUrl(options,triggerDataSource,forceCheck){const mainDs=this.getMainDataSource();triggerDataSource=triggerDataSource||mainDs,this.updateSelectionInfoOfDerivedDss(options,triggerDataSource,forceCheck),triggerDataSource.id===mainDs.id&&this.changeSelectionInUrl(options)}updateSelectionInfoOfDerivedDss(options,triggerDataSource,forceCheck){const mainDs=this.getMainDataSource();null==triggerDataSource||triggerDataSource.getAllDerivedDataSources().forEach((ds=>{ds.id!==this.dataSourceManager.getDataViewDataSourceId(mainDs.id,jimu_core.aH5.W7)&&ds.id!==this.dataSourceManager.getDataViewDataSourceId(mainDs.id,jimu_core.aH5.kf)&&ds.updateSelectionInfo(options,this,forceCheck)})),null==triggerDataSource||triggerDataSource.updateSelectionInfo(options,this,forceCheck)}changeSelectionInUrl(options){const mainDs=this.getMainDataSource();jimu_core.V08.getInstance().changeHashObjectByDataSourceSelection(mainDs.id,options)}selectRecord(index){const record=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecord(index):this.getRecord(index);record&&(this.copySelectionToDataView([record]),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:[record.getId()]}))}selectRecords(options){let selectRecords=[];if(null==options?void 0:options.records)selectRecords=options.records;else if(null==options?void 0:options.ids){const allRecords=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords();selectRecords=options.ids.map((id=>allRecords.find((r=>(null==r?void 0:r.getId())===id))))}return this.copySelectionToDataView(selectRecords),this.updateSelectionInfoOfDerivedDssAndChangeUrl(options),Promise.resolve({records:selectRecords})}selectRecordById(id,record){if(this.getSelectedRecordIds().find((_id=>_id===id)))return;let selectRecord;selectRecord=this.getDataSourceJson().isDataInDataSourceInstance?record||id&&this.getSourceRecordById(id):record||id&&this.getRecordById(id),selectRecord?(this.copySelectionToDataView([selectRecord]),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:[id]})):(this.copySelectionToDataView([]),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:[]}))}selectRecordsByIds(ids,records){const allRecords=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),selectRecords=records||ids.map((id=>allRecords.find((r=>(null==r?void 0:r.getId())===id))));this.copySelectionToDataView(selectRecords),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids})}copySelectionToDataView(selection){const selectionDv=this.getSelectionDataView();if(!selectionDv)return;const clonedSelection=selection.filter((r=>!!r)).map((r=>r.clone()));selectionDv.setSourceRecords(clonedSelection),selectionDv.setRecords(clonedSelection)}getInfo(){return(0,jimu_core.Vp3)().getState().dataSourcesInfo[this.id]||(0,jimu_core.J3Z)({})}clearRecords(){this.clearRecordsNotAddVersion(),this.addVersion()}clearRecordsNotAddVersion(){!this.isSelectionView()&&this.getSelectedRecords().length>0&&this.copySelectionToDataView([]),this.records=[]}getIdField(){return this.getSchema()&&this.getSchema().idField||"id"}getRootDataSource(){if(this.isDataView||this.isLocal)return this.getMainDataSource().getRootDataSource();let rootDs=this.parentDataSource;for(;rootDs&&rootDs.parentDataSource;)rootDs=rootDs.parentDataSource;return rootDs}getOriginDataSources(){return this.isDataView||this.isLocal?this.getMainDataSource().getOriginDataSources():this.getDataSourceJson().originDataSources&&0!==this.getDataSourceJson().originDataSources.length?this.getDataSourceJson().originDataSources.asMutable().map((useDs=>this.dataSourceManager.getDataSource(useDs.dataSourceId))):[]}getMainDataSource(){var _a;return this.belongToDataSource?null!==(_a=this.belongToDataSource.belongToDataSource)&&void 0!==_a?_a:this.belongToDataSource:this}getDataViews(){return this.getMainDataSource()!==this?[]:this.dataSourceManager.getDataSourcesAsArray().filter((ds=>ds.belongToDataSource===this&&ds.isDataView))}getDataView(dataViewId){return this.getDataViews().find((dv=>dv.dataViewId===dataViewId))}getDataViewConfig(){return this.isLocal?this.belongToDataSource.getDataViewConfig():this.isDataView?this.getDataSourceJson().dataViews&&this.getDataSourceJson().dataViews[this.dataViewId]:this.getDataSourceJson().query}getLocalDataSources(){return this.isLocal?[]:this.dataSourceManager.getDataSourcesAsArray().filter((ds=>ds.belongToDataSource===this&&ds.isLocal))}getLocalDataSource(localId){return this.getLocalDataSources().find((dv=>dv.localId===localId))}getAllDerivedDataSources(){let dss=[];const dvs=this.getDataViews(),locals=this.getLocalDataSources();return dss=dvs.concat(locals),dvs.forEach((dv=>{dss=dss.concat(dv.getLocalDataSources())})),dss}getSaveStatus(){var _a;return null===(_a=(0,jimu_core.Vp3)().getState().dataSourcesInfo[this.id])||void 0===_a?void 0:_a.saveStatus}setSaveStatus(status){(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.dataSourceSaveStatusChanged(this.id,status))}setListenSelection(listen){this.listenSelection=listen}getListenSelection(){return this.listenSelection}isSelectionView(){return this.isDataView&&this.dataViewId===jimu_core.aH5.W7}isLocalViewOfSelectionView(){return this.isLocal&&this.dataViewId===jimu_core.aH5.W7}addRecord(record){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){return record?(this.setSaveStatus(jimu_core.e3_.Saving),yield this.doAddRecord(record).then((record=>(this.setSaveStatus(jimu_core.e3_.Saved),record)),(error=>abstract_data_source_awaiter(this,void 0,void 0,(function*(){return this.setSaveStatus(jimu_core.e3_.SaveError),yield Promise.reject(error)}))))):yield Promise.reject("No record passed in.")}))}doAddRecord(record){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doAddRecordToSourceRecords(record):yield Promise.reject("Editing source is not ready yet.")}))}updateRecord(record){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){return yield this.updateRecords([record])}))}updateRecords(records){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){return records&&0!==records.length?(this.setSaveStatus(jimu_core.e3_.Saving),yield this.doUpdateRecords(records).then((isDone=>(this.setSaveStatus(jimu_core.e3_.Saved),isDone)),(error=>abstract_data_source_awaiter(this,void 0,void 0,(function*(){return this.setSaveStatus(jimu_core.e3_.SaveError),yield Promise.reject(error)}))))):yield Promise.reject("No records passed in.")}))}doUpdateRecords(records){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doUpdateRecordsInSourceRecords(records):yield Promise.reject("Editing source is not ready yet.")}))}deleteRecord(index){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){const record=this.getRecords()[index];return yield this.deleteOneRecord(record)}))}deleteRecordById(id){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){const record=this.getRecordById(id);return yield this.deleteOneRecord(record)}))}deleteOneRecord(record){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){return record?(this.setSaveStatus(jimu_core.e3_.Saving),yield this.doDeleteOneRecord(record).then((isDone=>(this.setSaveStatus(jimu_core.e3_.Saved),isDone)),(error=>abstract_data_source_awaiter(this,void 0,void 0,(function*(){return this.setSaveStatus(jimu_core.e3_.SaveError),yield Promise.reject(error)}))))):yield Promise.reject("No record passed in.")}))}doDeleteOneRecord(record){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doDeleteOneRecordFromSourceRecords(record):yield Promise.reject("Editing source is not ready yet.")}))}doDeleteOneRecordFromSourceRecords(record){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){return this.sourceRecords=this.sourceRecords.filter((r=>r.getId()!==record.getId())),Promise.resolve(!0)}))}doAddRecordToSourceRecords(record){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){return this.sourceRecords=this.sourceRecords.concat(record),yield Promise.resolve(record)}))}doUpdateRecordsInSourceRecords(records){return abstract_data_source_awaiter(this,void 0,void 0,(function*(){return records.forEach((r=>{const index=this.sourceRecords.findIndex((or=>or.getId()===r.getId()));index>-1&&(this.sourceRecords[index]=r)})),Promise.resolve(!0)}))}afterUpdateRecords(records){if(!records||0===records.filter((r=>!!r)).length)return;const dssWhichLoadedRecordsAreUpdated=[];records.forEach((r=>{[this.getMainDataSource()].concat(this.getMainDataSource().getAllDerivedDataSources()).forEach((ds=>{this.updateOneLoadedRecord(ds,r)&&(dssWhichLoadedRecordsAreUpdated.some((d=>d.id===ds.id))||dssWhichLoadedRecordsAreUpdated.push(ds))}))})),dssWhichLoadedRecordsAreUpdated.forEach((ds=>{ds.addVersion()})),this.getMainDataSource().addSourceVersion()}afterUpdateRecord(record){if(!record)return;const dssWhichLoadedRecordsAreUpdated=[];[this.getMainDataSource()].concat(this.getMainDataSource().getAllDerivedDataSources()).forEach((ds=>{this.updateOneLoadedRecord(ds,record)&&dssWhichLoadedRecordsAreUpdated.push(ds)})),dssWhichLoadedRecordsAreUpdated.forEach((ds=>{ds.addVersion()})),this.getMainDataSource().addSourceVersion()}updateOneLoadedRecord(ds,record){const existingRecord=ds.getRecordById(record.getId());return!(!existingRecord||!record)&&(existingRecord.setData(record.getData()),existingRecord.setGeometry(record.getRawGeometry()),!0)}afterAddRecord(record){if(!record)return;[this.getMainDataSource()].concat(this.getMainDataSource().getAllDerivedDataSources()).forEach((ds=>{ds.dataViewId!==jimu_core.aH5.W7&&ds.setRecords(ds.getRecords().concat(record))})),this.getMainDataSource().addSourceVersion()}afterDeleteRecordsByIds(ids){if(!(null==ids?void 0:ids.length))return;const dssWhichLoadedRecordsAreDeleted=[];ids.forEach((id=>{this.deleteOneSelectedRecordById(id);[this.getMainDataSource()].concat(this.getMainDataSource().getAllDerivedDataSources()).filter((ds=>ds.dataViewId!==jimu_core.aH5.W7)).forEach((ds=>{this.deleteOneLoadedRecordById(ds,id)&&(dssWhichLoadedRecordsAreDeleted.some((d=>d.id===ds.id))||dssWhichLoadedRecordsAreDeleted.push(ds))}))})),dssWhichLoadedRecordsAreDeleted.forEach((ds=>{ds.addVersion()})),this.getMainDataSource().addSourceVersion()}afterDeleteRecordById(id){if(!id)return;const dssWhichLoadedRecordsAreDeleted=[];this.deleteOneSelectedRecordById(id);[this.getMainDataSource()].concat(this.getMainDataSource().getAllDerivedDataSources()).filter((ds=>ds.dataViewId!==jimu_core.aH5.W7)).forEach((ds=>{this.deleteOneLoadedRecordById(ds,id)&&dssWhichLoadedRecordsAreDeleted.push(ds)})),dssWhichLoadedRecordsAreDeleted.forEach((ds=>{ds.addVersion()})),this.getMainDataSource().addSourceVersion()}deleteOneSelectedRecordById(id){return!!this.getMainDataSource().getSelectedRecordIds().includes(id)&&(this.getMainDataSource().selectRecordsByIds(this.getMainDataSource().getSelectedRecordIds().filter((selectedId=>selectedId!==id)),this.getMainDataSource().getSelectedRecords().filter((r=>r.getId()!==id))),!0)}deleteOneLoadedRecordById(ds,id){const index=ds.getRecords().findIndex((r=>(null==r?void 0:r.getId())===id));return"number"==typeof index&&index>-1&&(ds.getRecords().splice(index,1),null!=ds.count&&ds.count--,!0)}destroy(){if(this.parentDataSource){const dsId=this.type===jimu_core.hg5.Error?this.dataSourceManager.restoreErrorDataSourceId(this.id):this.id;this.parentDataSource.clearChildDataSourcePromise(dsId)}}}var abstract_loadable_data_source_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class AbstractLoadableDataSource extends abstract_data_source_AbstractDataSource{load(){return abstract_loadable_data_source_awaiter(this,void 0,void 0,(function*(){return this.setStatus(jimu_core.e3_.Loading),yield this.doLoad().then((records=>(this.records=records,this.setStatus(jimu_core.e3_.Loaded),this.records)))}))}}const fetchItemDataPromises={},fetchItemInfoPromises={},item_mixin_ItemMixinImpl=Base=>class ItemMixinImpl extends Base{get itemId(){return this._itemId}set itemId(itemId){this._itemId!==itemId&&(this._itemId=itemId,this.clearData())}get portalUrl(){return this._portalUrl}set portalUrl(portalUrl){this._portalUrl!==portalUrl&&(this._portalUrl=portalUrl,this.clearData())}getItemData(){return this.itemData}setItemData(itemData){this.itemData=itemData}setItemInfo(itemInfo){this.itemInfo=itemInfo}getItemInfo(){return this.itemInfo}fetchItemData(){return this.portalUrl&&this.itemId?this.itemData?Promise.resolve(this.itemData):(fetchItemDataPromises[getCacheId(this.portalUrl,this.itemId)]||(fetchItemDataPromises[getCacheId(this.portalUrl,this.itemId)]=jimu_core.Le1.requestWrapper(this.portalUrl,(session=>jimu_core._2M.restPortal.getItemData(this.itemId,{portal:jimu_core.zJ_.getPortalRestUrl(this.portalUrl),authentication:session})))),fetchItemDataPromises[getCacheId(this.portalUrl,this.itemId)].then((itemData=>{var _a,_b,_c,_d,_e,_f;const parentDataSource=this.parentDataSource;if(parentDataSource){const itemDataFromParent=null===(_d=null===(_c=null===(_b=(_a=parentDataSource).getItemData)||void 0===_b?void 0:_b.call(_a))||void 0===_c?void 0:_c.layers)||void 0===_d?void 0:_d.find((l=>l.id===this.jimuChildId));if(itemDataFromParent){const layerId=this.layerId,index=null===(_f=null===(_e=null==itemData?void 0:itemData.layers)||void 0===_e?void 0:_e.findIndex)||void 0===_f?void 0:_f.call(_e,(l=>`${l.id}`===layerId));index>-1?itemData.layers[index]=Object.assign(Object.assign(Object.assign({},itemData.layers[index]),itemDataFromParent),{id:parseInt(layerId)}):itemData=Object.assign(Object.assign({},itemData),{layers:((null==itemData?void 0:itemData.layers)||[]).concat(Object.assign(Object.assign({},itemDataFromParent),{id:parseInt(layerId)}))})}}return this.itemData=itemData,this.itemData}))):Promise.resolve(null)}fetchItemInfo(){return this.portalUrl&&this.itemId?this.itemInfo?Promise.resolve(this.itemInfo):(fetchItemInfoPromises[getCacheId(this.portalUrl,this.itemId)]||(fetchItemInfoPromises[getCacheId(this.portalUrl,this.itemId)]=jimu_core.Le1.requestWrapper(this.portalUrl,(session=>jimu_core._2M.restPortal.getItem(this.itemId,{portal:jimu_core.zJ_.getPortalRestUrl(this.portalUrl),authentication:session})))),fetchItemInfoPromises[getCacheId(this.portalUrl,this.itemId)].then((itemInfo=>(this.itemInfo=itemInfo,this.itemInfo)))):Promise.resolve(null)}clearData(){this.itemData=null,this.itemInfo=null}};function getCacheId(portalUrl,itemId){return`${portalUrl}-${itemId}`}var js_api_layer_mixin_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};const js_api_layer_mixin_JSAPILayerMixinImpl=Base=>class JSAPILayerMixinImpl extends Base{get jimuLayerId(){return this.layer&&!this._jimuLayerId&&(this._jimuLayerId=jimu_core.ZkX.getJimuLayerIdByJSAPILayer(this.layer)),this._jimuLayerId}createJSAPILayerByDataSource(dataSource_1){return js_api_layer_mixin_awaiter(this,arguments,void 0,(function*(dataSource,useDataSourceQueryParams=!0,throwError=!1){var _a;const createdBy=dataSource||this;let layer;if(createdBy.dataViewId===jimu_core.aH5.W7&&createdBy.useNoSelectionView()){const noSelectionView=createdBy.getMainDataSource().getDataView(jimu_core.aH5.kf);if(noSelectionView){return(yield jimu_core.ZkX.createJSAPIFeatureLayerByRecords(noSelectionView,noSelectionView.getRecords())).layer}}if(this.canCacheLayer(createdBy)&&(null===(_a=createdBy.layer||createdBy.cachedLayer)||void 0===_a?void 0:_a.clone))try{layer=(createdBy.layer||createdBy.cachedLayer).clone()}catch(_b){layer=yield this.createNewJSAPILayerByDataSource(createdBy,throwError)}else layer=yield this.createNewJSAPILayerByDataSource(createdBy,throwError);return layer&&useDataSourceQueryParams&&this.syncQueryParams(layer,createdBy),this.afterCreateJSAPILayer(layer,createdBy),layer}))}supportSpatialInfo(){const ds=jimu_core.zAk.getInstance().getDataSource(this.id);return(null==ds?void 0:ds.isDataSourceSet())?0===ds.getChildDataSources().length||ds.getChildDataSources().some((ds=>{var _a;return null===(_a=null==ds?void 0:ds.supportSpatialInfo)||void 0===_a?void 0:_a.call(ds)})):this.layer||this.cachedLayer?!(this.layer||this.cachedLayer).isTable:this.type===jimu_core.hg5.SceneLayer||!!(null==ds?void 0:ds.getGeometryType())}createNewJSAPILayerByDataSource(createdBy,throwError){return js_api_layer_mixin_awaiter(this,void 0,void 0,(function*(){var _a,_b,_c,_d,_e,_f;let layer;try{if(createdBy.getDataSourceJson().isDataInDataSourceInstance)layer=yield jimu_core.ZkX.createJSAPIFeatureLayerByRecords(createdBy,createdBy.getSourceRecords()).then((res=>null==res?void 0:res.layer));else if(createdBy.type!==jimu_core.hg5.FeatureLayer||createdBy.url||createdBy.itemId||!createdBy.layer){const options=this.getLayerConstructorOptions(createdBy);if(JSAPILayerClassesCanNotBeAutomaticallyRecognized[this.type]){layer=new(yield(0,jimu_core.p8A)(JSAPILayerClassesCanNotBeAutomaticallyRecognized[this.type]))(options)}else{const Layer=yield(0,jimu_core.p8A)("esri/layers/Layer");if(createdBy.url){if(layer=yield Layer.fromArcGISServerUrl(options),options.portalItem){const PortalItem=yield(0,jimu_core.p8A)("esri/portal/PortalItem");layer.portalItem=new PortalItem(options.portalItem),layer.layers?layer.layers=null:layer.sublayers&&(layer.sublayers=null)}}else if(createdBy.portalUrl&&createdBy.itemId)layer=yield Layer.fromPortalItem(options);else if(createdBy.layerId&&createdBy.parentDataSource){let parentWithUrl=createdBy.parentDataSource;for(;parentWithUrl&&!parentWithUrl.url;)parentWithUrl=parentWithUrl.parentDataSource;layer=yield null===(_a=parentWithUrl.createJSAPILayerByDataSource)||void 0===_a?void 0:_a.call(parentWithUrl)}}}else{const FeatureLayer=yield(0,jimu_core.p8A)("esri/layers/FeatureLayer"),fs=createdBy;layer=new FeatureLayer({source:fs.layer.source.clone(),objectIdField:fs.layer.objectIdField,geometryType:fs.layer.geometryType,sourceJSON:fs.layer.sourceJSON,fields:fs.layer.fields,customParameters:fs.layer.customParameters||{},outFields:["*"]})}}catch(err){if(throwError)throw err;console.error("Failed to create JS API layer. ",err,this.id)}if(layer){const capabilitiesBeforeLoad=null===(_b=layer.sourceJSON)||void 0===_b?void 0:_b.capabilities;yield layer.loadAll?layer.loadAll():null===(_d=(_c=layer).load)||void 0===_d?void 0:_d.call(_c),capabilitiesBeforeLoad&&layer.sourceJSON&&(layer.sourceJSON.capabilities=capabilitiesBeforeLoad);const childLayers=(null===(_e=layer.layers)||void 0===_e?void 0:_e.toArray())||(null===(_f=layer.allSublayers)||void 0===_f?void 0:_f.toArray()),supportedChildLayers=null==childLayers?void 0:childLayers.filter((l=>Object.values(jimu_core.QBT).some((supportedType=>supportedType===l.type)))),hasSupportedChildLayers=!!(null==supportedChildLayers?void 0:supportedChildLayers.length),hasChildDss=createdBy.isDataSourceSet(),layerIdsAreTheSame=!createdBy.layerId||`${layer.layerId}`===createdBy.layerId;hasSupportedChildLayers&&(!hasChildDss||!layerIdsAreTheSame)&&(layer=supportedChildLayers.find((l=>`${l.layerId}`===createdBy.layerId||`${l.id}`===createdBy.layerId||jimu_core.ZkX.fixLayerId(l.title)===jimu_core.ZkX.fixLayerId(createdBy.getMainDataSource().getDataSourceJson().sourceLabel))))}return layer&&!this.cachedLayer&&this.canCacheLayer(createdBy)&&(this.cachedLayer=layer),layer}))}setJimuChildIdAsLayerId(layer,ds){var _a,_b;if(!layer||!ds)return;try{layer.id=ds.jimuChildId||ds.id}catch(_c){}layer[jimu_core.yC0.EXB_DATA_SOURCE_ID_SET_TO_CREATED_JS_API_LAYER]=ds.id;const checkedChildDsIds=[],childLayers=(null===(_a=layer.layers)||void 0===_a?void 0:_a.toArray())||(null===(_b=layer.sublayers)||void 0===_b?void 0:_b.toArray());if((null==childLayers?void 0:childLayers.length)&&ds.isDataSourceSet()){let childDs;childLayers.forEach((l=>{childDs=ds.getChildDataSources().filter((d=>!checkedChildDsIds.includes(d.id))).find((d=>jimu_core.ZkX.getWhetherDataSourceHasSameSourceWithJSAPILayer(d,l))),childDs&&(checkedChildDsIds.push(childDs.id),this.setJimuChildIdAsLayerId(l,childDs))}))}}canCacheLayer(createdBy){return(null==createdBy?void 0:createdBy.id)===this.id&&!createdBy.getDataSourceJson().isDataInDataSourceInstance}getLayerConstructorOptions(createdBy){var _a,_b;if(!createdBy)return null;const options={};createdBy.url&&(options.url=createdBy.url),createdBy.itemId&&createdBy.portalUrl&&(options.portalItem={id:createdBy.itemId,portal:{url:createdBy.portalUrl}});const layerId=+createdBy.layerId;isNaN(layerId)||(options.layerId=layerId);const cachedLayer=createdBy.layer||(this.canCacheLayer(createdBy)?createdBy.layer||createdBy.cachedLayer:null);return(null==cachedLayer?void 0:cachedLayer.sourceJSON)&&(options.sourceJSON=cachedLayer.sourceJSON),(null==cachedLayer?void 0:cachedLayer.customParameters)&&(options.customParameters=cachedLayer.customParameters),(null===(_a=null==cachedLayer?void 0:cachedLayer.source)||void 0===_a?void 0:_a.clone)&&(options.source=cachedLayer.source.clone().toJSON(),options.source.length&&(options.outFields=["*"])),(null===(_b=null==cachedLayer?void 0:cachedLayer.portalItem)||void 0===_b?void 0:_b.clone)&&(options.portalItem=cachedLayer.portalItem.clone().toJSON()),options}syncQueryParams(layer,dataSource){var _a,_b,_c,_d,_e,_f,_g,_h;"definitionExpression"in layer&&(layer.definitionExpression=null===(_c=null===(_b=(_a=dataSource).getCurrentQueryParams)||void 0===_b?void 0:_b.call(_a))||void 0===_c?void 0:_c.where),"gdbVersion"in layer&&(layer.gdbVersion=null===(_e=(_d=dataSource).getGDBVersion)||void 0===_e?void 0:_e.call(_d)),"timeExtent"in layer&&(layer.timeExtent=jimu_core.ZkX.changeJimuTimeToJSAPITimeExtent(null===(_h=null===(_g=(_f=dataSource).getCurrentQueryParams)||void 0===_g?void 0:_g.call(_f))||void 0===_h?void 0:_h.time))}afterCreateJSAPILayer(layer,dataSource){if(!layer||!dataSource)return;const label=dataSource.getLabel()||this.getDataSourceJson().sourceLabel;layer.title!==label&&(layer.title=label),this.setJimuChildIdAsLayerId(layer,this),(dataSource.layer||dataSource.cachedLayer)&&(layer.id=(dataSource.layer||dataSource.cachedLayer).id)}},JSAPILayerClassesCanNotBeAutomaticallyRecognized={[jimu_core.hg5.CSV]:"esri/layers/CSVLayer",[jimu_core.hg5.GeoJSON]:"esri/layers/GeoJSONLayer",[jimu_core.hg5.KML]:"esri/layers/KMLLayer",[jimu_core.hg5.WFS]:"esri/layers/WFSLayer",[jimu_core.hg5.WMS]:"esri/layers/WMSLayer",[jimu_core.hg5.WMTS]:"esri/layers/WMTSLayer",[jimu_core.hg5.VectorTileService]:"esri/layers/VectorTileLayer",[jimu_core.hg5.SubtypeGroupLayer]:"esri/layers/SubtypeGroupLayer"};var csv_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class CSVDataSourceImpl extends(js_api_layer_mixin_JSAPILayerMixinImpl(item_mixin_ItemMixinImpl(AbstractLoadableDataSource))){constructor(options){super(options),this.type=jimu_core.hg5.CSV;const dsJson=this.getDataSourceJson();dsJson.data?(this.records=dsJson.data.asMutable().map((d=>new SimpleDataRecordImpl(d,this))),this.setStatus(jimu_core.e3_.Loaded)):this.url=dsJson.url,this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId,this.url&&jimu_core.Le1.registerCacheableUrl(this.url)}ready(){return csv_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}doLoad(){return csv_data_source_impl_awaiter(this,void 0,void 0,(function*(){return yield fetch(this.url).then((res=>csv_data_source_impl_awaiter(this,void 0,void 0,(function*(){return yield res.json()})))).then((data=>data.map((d=>new SimpleDataRecordImpl(d,this)))))}))}}class CapabilitiesImpl{constructor(options){Object.assign(this,options)}getQueryCapabilities(){return{maxPageSize:null}}}var abstract_queriable_data_source_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__rest=function(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(t[p[i]]=s[p[i]])}return t};const{Rn:DEFAULT_QUERY_PAGE_SIZE,kf:DATA_VIEW_ID_FOR_NO_SELECTION,VA:OUTPUT_DATA_VIEW_ID,W7:SELECTION_DATA_VIEW_ID}=jimu_core.aH5;class AbstractQueriableDataSource extends abstract_data_source_AbstractDataSource{constructor(options){super(options),this.pages={},this.pagePromises={},this.loadMissingFieldsByPagePromises={},this.throttleQueryRecordsByIdWithCurrentQueryParams=jimu_core.CM0.throttle(this.queryRecordsByIdWithCurrentQueryParams.bind(this),200),this.setCapabilities(new CapabilitiesImpl({})),this.url=this.getDataSourceJson().url,this.isSqlCaseSensitive=!!this.getDataSourceJson().isDataInDataSourceInstance||!jimu_core.ZkX.isAGOLHostedService(this.getDataSourceJson().url)}ready(){if(this.isSelectionView()){const mainDsId=this.getMainDataSource().id,{allSelectedRecordIds,allSelectOptions}=this.getSelectedIdsAndSelectOptionsFromUrl(),querySelectedRecords=()=>{if(0===allSelectedRecordIds.length&&0===Object.keys(allSelectOptions).length)return Promise.resolve({});const queryByIdsPromise=allSelectedRecordIds.length>0?this.queryRecordsByIdWithCurrentQueryParams(allSelectedRecordIds,this.getMainDataSource(),{returnGeometry:!0,outFields:this.getAllUsedFields()}).then((res=>{var _a;this.getMainDataSource().selectRecordsByIds(null===(_a=res.records)||void 0===_a?void 0:_a.map((r=>r.getId())),res.records)})):null,queryBySelectOptionsPromises=Object.keys(allSelectOptions).map((dsId=>{var _a,_b,_c;if(null===(_b=null===(_a=allSelectOptions[dsId])||void 0===_a?void 0:_a.ids)||void 0===_b?void 0:_b.length)return this.queryRecordsByIdWithCurrentQueryParams(allSelectOptions[dsId].ids,this.getMainDataSource(),{returnGeometry:!0,outFields:this.getAllUsedFields()}).then((res=>{this.getMainDataSource().selectRecords(Object.assign(Object.assign({},allSelectOptions[dsId]),{records:res.records}))}));if(null===(_c=allSelectOptions[dsId])||void 0===_c?void 0:_c.queryParams){const dataViewId=dsId===mainDsId?null:dsId.replace(`${mainDsId}-`,""),ds=dataViewId?this.dataSourceManager.createDataView(this.getMainDataSource(),dataViewId):this.getMainDataSource();return null==ds?void 0:ds.queryAll(Object.assign(Object.assign({},allSelectOptions[dsId].queryParams),{returnGeometry:!0,outFields:this.getAllUsedFields()})).then((res=>{ds.selectRecords(Object.assign(Object.assign({},allSelectOptions[dsId]),{records:res.records}))}))}return null}));this.pendingPromiseToQuerySelectedRecordsPresetBeforeDsReady=Promise.allSettled([queryByIdsPromise,...queryBySelectOptionsPromises].filter((p=>!!p))).then((()=>null)).finally((()=>{this.pendingPromiseToQuerySelectedRecordsPresetBeforeDsReady=null}))};return this.getMainDataSource().getDataSourceJson().isDataInDataSourceInstance?this.getMainDataSource().setOnceSetSourceRecords(querySelectedRecords):querySelectedRecords(),Promise.resolve()}return this.isDataView&&this.dataViewId===DATA_VIEW_ID_FOR_NO_SELECTION?(this.loadNoSelectionView(),Promise.resolve()):Promise.resolve()}loadNoSelectionView(){const noSelectionView=this.isDataView&&this.dataViewId===DATA_VIEW_ID_FOR_NO_SELECTION?this:this.getMainDataSource().getDataView(DATA_VIEW_ID_FOR_NO_SELECTION);return noSelectionView&&this.useNoSelectionView(this.getSelectionDataView())?Promise.allSettled([noSelectionView.load({returnGeometry:!0},{widgetId:DATA_VIEW_ID_FOR_NO_SELECTION}),noSelectionView.loadCount({},{widgetId:DATA_VIEW_ID_FOR_NO_SELECTION})]).then((()=>{var _a,_b,_c,_d;const{allSelectedRecordIds:selectedRecordIdsInUrl,allSelectOptions:selectOptionsInUrl}=this.getSelectedIdsAndSelectOptionsFromUrl();this.getMainDataSource().getSelectedRecordIds().length||selectedRecordIdsInUrl.length||Object.keys(selectOptionsInUrl).length||(null===(_a=this.getMainDataSource().getDataView(SELECTION_DATA_VIEW_ID))||void 0===_a||_a.clearRecords(),null===(_c=null===(_b=this.getMainDataSource().getDataView(SELECTION_DATA_VIEW_ID))||void 0===_b?void 0:_b.getAllDerivedDataSources())||void 0===_c||_c.forEach((ds=>{null==ds||ds.clearRecords()})),null===(_d=this.getMainDataSource().getDataView(SELECTION_DATA_VIEW_ID))||void 0===_d||_d.addSourceVersion())})):Promise.resolve()}getSelectedIdsAndSelectOptionsFromUrl(){const mainDsId=this.getMainDataSource().id,urlManager=jimu_core.V08.getInstance(),dsInfos=jimu_core.v6q.getDataSourceInfosFromUrlParams(urlManager.getQueryObject(),urlManager.getHashObject());let allSelectedRecordIds=[];const allSelectOptions={};return dsInfos&&Object.keys(dsInfos).forEach((dsId=>{var _a,_b,_c,_d,_e;(dsId===mainDsId||jimu_core.ZkX.isDerivedFrom(mainDsId,dsId))&&(Array.isArray(null===(_a=dsInfos[dsId])||void 0===_a?void 0:_a.selection)&&(null===(_b=dsInfos[dsId])||void 0===_b?void 0:_b.selection).length?allSelectedRecordIds=allSelectedRecordIds.concat(null===(_c=dsInfos[dsId])||void 0===_c?void 0:_c.selection):(null===(_e=null===(_d=dsInfos[dsId])||void 0===_d?void 0:_d.selection)||void 0===_e?void 0:_e.widgetId)&&(allSelectOptions[dsId]=dsInfos[dsId].selection))})),allSelectedRecordIds=Array.from(new Set(allSelectedRecordIds)),{allSelectedRecordIds,allSelectOptions}}get isSqlCaseSensitive(){return this._isSqlCaseSensitive}set isSqlCaseSensitive(isCaseSensitive){this._isSqlCaseSensitive=isCaseSensitive}getCurrentQueryParams(options){return this.getCurrentQueryParamsWithSpecificWidgetQueries(options,this.getInfo().widgetQueries)}getRuntimeQueryParams(excludeWidgetIds){return this.getRuntimeQueryParamsWithSpecificWidgetQueries(excludeWidgetIds,this.getInfo().widgetQueries)}getCurrentQueryParamsWithSpecificWidgetQueries(options,widgetQueries){const excludeWidgetIds=this.getWidgetIdsFromWidgetDataSourcePairs(null==options?void 0:options.exclude),runtimeQuery=this.getRuntimeQueryParamsWithSpecificWidgetQueries(excludeWidgetIds,widgetQueries);return this.getCurrentQueryParamsByQuery(runtimeQuery,options)}getRuntimeQueryParamsWithSpecificWidgetQueries(excludeWidgetIds,widgetQueries){const queries=excludeWidgetIds?null==widgetQueries?void 0:widgetQueries.without(...[].concat(excludeWidgetIds)):widgetQueries;return this.getMergedWidgetQueries(queries)}getCurrentQueryParamsByQuery(runtimeQuery,options){let query;return this.isLocal?query=this.mergeQueryParams(this.belongToDataSource.getCurrentQueryParams(options),runtimeQuery):this.isDataView?(query=this.mergeQueryParams(this.getConfigQueryParams(),runtimeQuery),query=this.mergeQueryParams(this.getMainDataSource().getCurrentQueryParams(Object.assign(Object.assign({},options),{dataSourceToFormatSql:this})),query)):(query=this.mergeQueryParams(this.getConfigQueryParams(),runtimeQuery),query=this.mergeQueryParams(this.getRemoteQueryParams(),query)),query}getMergedWidgetQueries(widgetQueries){let widgetIds=widgetQueries&&Object.keys(widgetQueries)||[];return widgetIds=widgetIds.sort(((a,b)=>a.localeCompare(b,"en",{numeric:!0,sensitivity:"base"}))),this.mergeQueryParams(...widgetIds.map((widgetId=>widgetQueries[widgetId])))}getWidgetIdsFromWidgetDataSourcePairs(pair){return pair?Array.isArray(pair)?pair.filter((e=>e.dataSourceId===this.id)).map((e=>e.widgetId)):pair.dataSourceId===this.id?[pair.widgetId]:null:null}getCurrentQueryId(){return this.lastQueryId}getRealQueryParams(query,flag,options){let realQuery;if("query"===flag)options&&options.scope?options.scope===jimu_core.pQB.InAllData?realQuery=query:options.scope===jimu_core.pQB.InRemoteConfigView?realQuery=this.mergeQueryParams(this.getRemoteQueryParams(),query):options.scope===jimu_core.pQB.InConfigView?(realQuery=this.mergeQueryWithConfigQuery(query),realQuery=this.mergeQueryParams(this.getRemoteQueryParams(),realQuery)):realQuery=options.scope===jimu_core.pQB.InRuntimeView?this.mergeQueryParams(this.getCurrentQueryParamsWithSpecificWidgetQueries({exclude:options.excludeQuery,dataSourceToFormatSql:options.dataSourceToFormatSql},this.getInfo().widgetQueries),query):query:realQuery=this.mergeQueryParams(this.getCurrentQueryParamsWithSpecificWidgetQueries({exclude:null==options?void 0:options.excludeQuery,dataSourceToFormatSql:null==options?void 0:options.dataSourceToFormatSql},this.getInfo().widgetQueries),query);else{if(!options||!options.widgetId)return console.error("Please pass widget id for load."),null;const widgetQueries=(this.getInfo().widgetQueries||(0,jimu_core.J3Z)({})).set(options.widgetId,query);options&&options.scope?options.scope===jimu_core.pQB.InAllData?realQuery=query:options.scope===jimu_core.pQB.InRemoteConfigView?realQuery=this.mergeQueryParams(this.getRemoteQueryParams(),query):options.scope===jimu_core.pQB.InConfigView?(realQuery=this.mergeQueryWithConfigQuery(query),realQuery=this.mergeQueryParams(this.getRemoteQueryParams(),realQuery)):realQuery=options.scope===jimu_core.pQB.InRuntimeView?this.getCurrentQueryParamsWithSpecificWidgetQueries({exclude:options.excludeQuery,dataSourceToFormatSql:options.dataSourceToFormatSql},widgetQueries):query:realQuery=this.getCurrentQueryParamsWithSpecificWidgetQueries({exclude:null==options?void 0:options.excludeQuery,dataSourceToFormatSql:null==options?void 0:options.dataSourceToFormatSql},widgetQueries)}return realQuery}mergeQueryWithConfigQuery(query){let newQuery;return this.isLocal?this.belongToDataSource.isDataView?(newQuery=this.mergeQueryParams(this.belongToDataSource.getConfigQueryParams(),query),newQuery=this.mergeQueryParams(this.getMainDataSource().getConfigQueryParams(),newQuery)):newQuery=this.mergeQueryParams(this.getConfigQueryParams(),query):this.isDataView?(newQuery=this.mergeQueryParams(this.getConfigQueryParams(),query),newQuery=this.mergeQueryParams(this.getMainDataSource().getConfigQueryParams(),newQuery)):newQuery=this.mergeQueryParams(this.getConfigQueryParams(),query),newQuery}updateQueryParams(query,widgetId){var _a;query=this.getQueryWithoutPage(query),jimu_core.WpD.isDeepEqual(query||{},(null===(_a=this.getInfo().widgetQueries)||void 0===_a?void 0:_a[widgetId])||{})||(this.updateWidgetQueries(query,widgetId),this.isSelectionView()?(this.load({returnGeometry:!0,pageSize:this.getSourceRecords().length},{widgetId:SELECTION_DATA_VIEW_ID}),this.loadCount({},{widgetId:SELECTION_DATA_VIEW_ID})):(this.handleSelectionOnQueryParamChanges(),this.id===this.getMainDataSource().id&&this.loadNoSelectionView()))}updateWidgetQueries(query,widgetId){(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.updateWidgetQuery(this.id,widgetId,query))}getQueryPageSize(){var _a;const configuredPageSize=(null===(_a=this.getDataViewConfig())||void 0===_a?void 0:_a.pageSize)||DEFAULT_QUERY_PAGE_SIZE,serviceMaxPageSize=this.getMaxQueryPageSize()||1/0;return Math.min(configuredPageSize,serviceMaxPageSize)}getMaxQueryPageSize(){var _a,_b;return null===(_b=null===(_a=this.getCapabilities())||void 0===_a?void 0:_a.getQueryCapabilities())||void 0===_b?void 0:_b.maxPageSize}getMaxRecordCount(){var _a;return(null===(_a=this.getDataViewConfig())||void 0===_a?void 0:_a.maximum)||null}getQueryWithoutPage(query){if(!query)return null;const{pageSize,page}=query;return __rest(query,["pageSize","page"])}checkClearLocalCache(query,lastQuery,type,options){const queryWithoutPage=this.getQueryWithoutPage(query),realQueryWithoutPage=this.getRealQueryParams(queryWithoutPage,"load",options),realQueryWithoutPageOrUsedFields=this.applyUsedFields(realQueryWithoutPage,"*"),lastQueryWithoutPageOrUsedFields=this.applyUsedFields(lastQuery,"*");"loadCount"===type&&jimu_core.ZkX.NON_COUNT_AFFECTING_QUERY_PARAMS_KEYS.forEach((k=>{delete realQueryWithoutPageOrUsedFields[k],delete lastQueryWithoutPageOrUsedFields[k]}));const refresh=options.refresh||this.getInfo().needRefresh;return!(jimu_core.WpD.isDeepEqual(realQueryWithoutPageOrUsedFields,lastQueryWithoutPageOrUsedFields)&&!refresh)&&(this.getInfo().needRefresh&&this.setNeedRefresh(!1),!0)}selectRecords(options,signal,progressCallback){const _super=Object.create(null,{selectRecords:{get:()=>super.selectRecords}});return abstract_queriable_data_source_awaiter(this,void 0,void 0,(function*(){if(this.clearPendingSelect(),(null==options?void 0:options.records)||(null==options?void 0:options.ids)){const result=yield _super.selectRecords.call(this,options);return Promise.resolve(Object.assign(Object.assign({},result),{queryParams:(0,jimu_core.J3Z)(null==options?void 0:options.queryParams)}))}if(null==options?void 0:options.queryParams){const controller=new AbortController;return signal&&(signal.onabort=e=>{controller.abort()}),this.abortControllerOfPendingPromiseToQuerySelectedRecordsBySelectOptions=controller,this.queryAll(Object.assign(Object.assign({},options.queryParams),{returnGeometry:!0}),this.abortControllerOfPendingPromiseToQuerySelectedRecordsBySelectOptions.signal,progressCallback).then((result=>(result.isAborted&&!(null==signal?void 0:signal.aborted)||_super.selectRecords.call(this,Object.assign(Object.assign({},options),{records:result.records})),result))).catch((err=>(console.error("Failed to select by options. ",err),{records:[],queryParams:(0,jimu_core.J3Z)(options.queryParams)})))}return Promise.resolve({records:[],queryParams:null})}))}selectAllLoadedRecords(){const loadedRecords=this.getAllLoadedRecords();this.selectRecordsByIds(loadedRecords.map((r=>r.getId())),loadedRecords)}copySelectionToDataView(selection){this.clearPendingSelect(),super.copySelectionToDataView(selection)}clearPendingSelect(){var _a;null===(_a=this.abortControllerOfPendingPromiseToQuerySelectedRecordsBySelectOptions)||void 0===_a||_a.abort(),this.abortControllerOfPendingPromiseToQuerySelectedRecordsBySelectOptions=null}getRecordsByPage(page,pageSize){const records=[],pages=Object.assign({},this.pages),maxPage=Object.keys(pages).map((p=>parseInt(p))).sort(((a,b)=>b-a))[0],{start,end}=this.getStartAndEndForPage(page,pageSize);if(null===start||null===end)return[];let currentPageSize,accumulator=0;for(let i=1;i<=maxPage;i++){currentPageSize=this.getRealPageSize(i);const pageStart=accumulator;if(accumulator+=currentPageSize,!(pageStart+currentPageSize-1<start||pageStart>end)&&pages[i])for(let pi=0;pi<pages[i].length;pi++)pageStart+pi<start||pageStart+pi>end||records.push(pages[i][pi])}return records}getRecordsByPageWithSelection(page,pageSize){return this.concatRecordsAndSelection(this.getSelectedRecords(),this.getRecordsByPage(page,pageSize))}getPagesData(){return this.pages}setPagesData(pages){this.pages=pages}clearRecordsNotAddVersion(){!this.isSelectionView()&&this.getSelectedRecords().length>0&&this.copySelectionToDataView([]),this.pages={},this.pagePromises={},this.loadMissingFieldsByPagePromises={},this.loadMissingFieldsForAllPagePromise=null,this.count=null,this.countPromise=null,this.byIdPromise=null}clearCountNotAddVersion(){this.count=null,this.countPromise=null}clearQueryByIdNotAddVersion(){this.byIdPromise=null}getRecords(){let records=[];const pages=[];for(let i=1;i<=Object.keys(this.pages).length&&this.pages[i];i++)pages.push(i);return pages.forEach((page=>{records=records.concat(this.pages[page])})),null!==this.getMaxRecordCount()&&this.getMaxRecordCount()<records.length?records.slice(0,this.getMaxRecordCount()):records}getAllLoadedRecords(){let records=[];return Object.keys(this.pages).forEach((pageId=>{this.pages[pageId]&&(records=records.concat(this.pages[pageId]))})),null!==this.getMaxRecordCount()&&this.getMaxRecordCount()<records.length?records.slice(0,this.getMaxRecordCount()):records}setRecords(records){const pages={},pageSize=this.getQueryPageSize();records.forEach(((r,i)=>{const newPageNumber=Math.ceil((i+1)/pageSize);pages[newPageNumber]||(pages[newPageNumber]=[]),pages[newPageNumber][i%pageSize]=r})),this.setPagesData(pages),this.addVersion()}setSourceRecords(records){if(super.setSourceRecords(records),this.canSaveSourceRecords()&&this.onceSetSourceRecords){const onceSetSourceRecords=this.onceSetSourceRecords;this.setOnceSetSourceRecords(null),jimu_core.CM0.defer((()=>{onceSetSourceRecords()}))}}get count(){return this._count}set count(c){this._count=c}getRealQueryPages(page,pageSize){const{start,end}=this.getStartAndEndForPage(page,pageSize);if(null===start||null===end)return[];let currentPage,previousPage,startPage,endPage,accumulator=0;const loadedPages=Object.keys(this.pages).map((pi=>parseInt(pi))).sort(((a,b)=>a-b));for(let i=0;i<loadedPages.length;i++){if(previousPage=currentPage||0,currentPage=loadedPages[i],accumulator=accumulator+this.getRealPageSize(currentPage)+(currentPage-previousPage-1)*this.getQueryPageSize(),!startPage&&start<accumulator){let c=accumulator,p=currentPage;for(;start<c;)c-=this.getRealPageSize(p),p--;startPage=p+1}if(!endPage&&end<accumulator){let c=accumulator,p=currentPage;for(;end<c;)c-=this.getRealPageSize(p),p--;endPage=p+1}if(startPage&&endPage)break}if(!startPage||!endPage){const maxPage=loadedPages.length?loadedPages[loadedPages.length-1]:0;startPage=startPage||maxPage+Math.floor((start-accumulator)/this.getQueryPageSize())+1,endPage=endPage||maxPage+Math.floor((end-accumulator)/this.getQueryPageSize())+1}const pages=[];for(let i=startPage;i<=endPage;i++)pages.push(i);return pages}getStartAndEndForPage(page,pageSize){if("number"!=typeof page||"number"!=typeof pageSize)return{start:null,end:null};const start=pageSize*(page-1);let end=start+pageSize-1;const maxCount=this.getMaxRecordCount();return null!==maxCount&&(end=Math.min(end,maxCount-1)),start<=end?{start,end}:{start:null,end:null}}haveMorePages(page,pageSize){var _a;if(page<1||pageSize<1)return"unknown";const haveMorePagesByCount=count=>count>page*pageSize,maxCount=this.getMaxRecordCount();if(!("number"==typeof maxCount?haveMorePagesByCount(maxCount):"unknown"))return!1;if("number"==typeof this.count&&jimu_core.WpD.isDeepEqual((0,jimu_core.J3Z)(this.lastCountQueryParams||{}).without(...jimu_core.ZkX.NON_COUNT_AFFECTING_QUERY_PARAMS_KEYS),(0,jimu_core.J3Z)(this.lastQueryParams||{}).without(...jimu_core.ZkX.NON_COUNT_AFFECTING_QUERY_PARAMS_KEYS)))return haveMorePagesByCount(this.count);{const loadedPages=Object.keys(this.pagePromises).map((pageId=>parseInt(pageId)));if(!loadedPages.length&&1===page)return!0;const maxLoadedPage=Math.max(...loadedPages);if(!(null===(_a=this.pagePromises[maxLoadedPage])||void 0===_a?void 0:_a.exceededTransferLimit)&&!!this.pages[maxLoadedPage]){return haveMorePagesByCount(loadedPages.reduce(((accumulator,currentPage,i)=>{const previousPage=loadedPages[i-1]||0;return accumulator+(Array.isArray(this.pages[currentPage])?this.pages[currentPage].length:this.getQueryPageSize())+(currentPage-previousPage-1)*this.getQueryPageSize()}),0))}{const queryPages=this.getRealQueryPages(page,pageSize);return Math.max(...queryPages)<=maxLoadedPage||"unknown"}}}load(query,options={}){var _a;if(this.getStatus()===jimu_core.e3_.NotReady)return Promise.resolve([]);(query=Object.assign({},query)).page||(query.page=1),query.pageSize||(query.pageSize=this.getQueryPageSize());const queryPages=this.getRealQueryPages(query.page,query.pageSize);this.checkClearLocalCache(query,this.lastQueryParams,"load",options)&&(Object.keys(this.pages).forEach((p=>{queryPages.includes(parseInt(p))||delete this.pages[p]})),this.pagePromises={},this.loadMissingFieldsByPagePromises={},this.loadMissingFieldsForAllPagePromise=null);const queryWithoutPage=this.getQueryWithoutPage(query);jimu_core.WpD.isDeepEqual(queryWithoutPage||{},(null===(_a=this.getInfo().widgetQueries)||void 0===_a?void 0:_a[options.widgetId])||{})||this.updateWidgetQueries(queryWithoutPage,options.widgetId);let realQuery=this.getRealQueryParams(queryWithoutPage,"load",options);const usedFields=this.getAllUsedFields({queryParams:realQuery,excludeWidgetsDoNotUseDsToQuery:!0});realQuery=this.applyUsedFields(realQuery,usedFields),this.loadMissingFields(realQuery);const pagePromises=queryPages.filter((page=>this.pagePromises[page])).map((page=>this.pagePromises[page].promise));return pagePromises.length===queryPages.length?Promise.all(pagePromises).then((()=>this.getRecordsByPageAndLoadMoreIfExceededTransferLimit(query,queryPages,options))):(this.lastQueryParams=realQuery,this.setStatus(jimu_core.e3_.Loading),this.setNeedRefresh(!1),Promise.all(queryPages.map((page=>this.loadByPage(realQuery,query,usedFields,page)))).then((results=>results.find((r=>r))?(this.handleSelectionOnQueryParamChanges(),this.lastRefreshTime=new Date,this.setStatus(jimu_core.e3_.Loaded),window.jimuConfig.isInBuilder&&(0,jimu_core.Vp3)().getState().appRuntimeInfo.appMode===jimu_core.$0N.Design||this.startAutoRefresh(),this.getRecordsByPageAndLoadMoreIfExceededTransferLimit(query,queryPages,options)):null),(err=>(console.error(err),this.setStatus(jimu_core.e3_.LoadError),null))))}loadAll(query,signal,progressCallback,options){return this.loadOrQueryAll("load",query,signal,progressCallback,options).then((r=>r.records))}getRecordsByPageAndLoadMoreIfExceededTransferLimit(query,queryPages,options){var _a;const pageRecords=this.getRecordsByPage(query.page,query.pageSize),maxRecordCount=this.getMaxRecordCount();return pageRecords.length<query.pageSize&&(null===(_a=this.pagePromises[Math.max(...queryPages)])||void 0===_a?void 0:_a.exceededTransferLimit)&&(!maxRecordCount||this.getAllLoadedRecords().length<maxRecordCount)?this.load(query,options):Promise.resolve(pageRecords)}getRealPageSize(page){var _a;return(null===(_a=this.pagePromises[page])||void 0===_a?void 0:_a.exceededTransferLimit)&&Array.isArray(this.pages[page])?this.pages[page].length:this.getQueryPageSize()}loadMissingFields(realQuery,delay=!1){jimu_core.CM0.defer((()=>{const usedFields=this.getAllUsedFields({queryParams:realQuery,excludeWidgetsDoNotUseDsToQuery:!0});if(this.updateLoadOnDemandFields(usedFields),delay){if(this.usedFieldsInTimeWindow=this.mergeUsedFields(this.usedFieldsInTimeWindow,usedFields),this.loadMissingFieldsTimer)return;this.loadMissingFieldsTimer=setTimeout((()=>{this.doLoadMissingFields(realQuery,this.usedFieldsInTimeWindow),clearTimeout(this.loadMissingFieldsTimer),this.loadMissingFieldsTimer=null,this.usedFieldsInTimeWindow=[]}),500)}else this.doLoadMissingFields(realQuery,usedFields)}))}doLoadMissingFields(realQuery,usedFields){var _a;if(this.isSelectionView()){const records=this.getRecords(),notLoadedSourceRecords=this.getSourceRecords().filter((sR=>!records.some((r=>r.getId()===sR.getId())))),allRecords=records.concat(notLoadedSourceRecords),missingFields=[];if(allRecords.forEach((r=>{this.findMissingFields(usedFields,Object.keys(r.getData())).forEach((f=>{missingFields.includes(f)||missingFields.push(f)}))})),0===missingFields.length)return;if(!this.loadMissingFieldsByPagePromises[SELECTION_DATA_VIEW_ID]||this.missingSomeFields(missingFields,this.loadMissingFieldsByPagePromises[SELECTION_DATA_VIEW_ID].fields)){const ids=records.map((r=>r.getId())),fieldSchema=null===(_a=this.getSchema())||void 0===_a?void 0:_a.fields,promise=this.queryRecordsByIdWithCurrentQueryParams(ids,this.getMainDataSource(),this.applyUsedFields(realQuery,missingFields)).then((res=>{var _a;if(fieldSchema!==(null===(_a=this.getSchema())||void 0===_a?void 0:_a.fields))return!1;const records=this.getRecords(),sourceRecords=this.getSourceRecords();return res.records.forEach((newRecord=>{const prevRecord=records.find((r=>r.getId()===newRecord.getId()));prevRecord&&prevRecord.setData(Object.assign(Object.assign({},prevRecord.getData()),newRecord.getData()));const prevSourceRecord=sourceRecords.find((r=>r.getId()===newRecord.getId()));prevSourceRecord&&prevSourceRecord.setData(Object.assign(Object.assign({},prevSourceRecord.getData()),newRecord.getData()))})),this.addSourceVersion(),this.addVersion(),!0})).catch((err=>(console.error("Failed to load missing fields, ",err),!1)));this.loadMissingFieldsByPagePromises[SELECTION_DATA_VIEW_ID]={promise,fields:missingFields}}}else{if(!Object.values(this.pagePromises).some((p=>this.missingSomeFields(usedFields,p.fields))))return;const missingFieldsByPage={};if(Object.keys(this.pagePromises).forEach((pageId=>{const page=parseInt(pageId),missingFieldsInPage=this.findMissingFields(usedFields,this.pagePromises[page].fields);missingFieldsByPage[page]=missingFieldsInPage})),!this.loadMissingFieldsForAllPagePromise||Object.keys(this.pagePromises).some((pageId=>this.missingSomeFields(missingFieldsByPage[pageId],this.loadMissingFieldsForAllPagePromise.fields[pageId])))){const loadMissingFieldsByPagePromises=[];Object.keys(this.pagePromises).forEach((pageId=>{const page=parseInt(pageId),missingFieldsInPage=missingFieldsByPage[page],p=this.loadMissingFieldsByPage(realQuery,missingFieldsInPage,page);loadMissingFieldsByPagePromises.push(p)}));const promise=Promise.all(loadMissingFieldsByPagePromises).then((results=>(results.find((r=>r))&&this.addVersion(),!0))).catch((err=>(console.error("Failed to load missing fields, ",err),!1)));this.loadMissingFieldsForAllPagePromise={promise,fields:missingFieldsByPage}}}}loadMissingFieldsByPage(realQuery,missingFields,page){var _a;if(!missingFields||0===missingFields.length||"*"===this.pagePromises[page].fields)return Promise.resolve(!0);if(!this.loadMissingFieldsByPagePromises[page]||this.missingSomeFields(missingFields,this.loadMissingFieldsByPagePromises[page].fields)){const realQueryWithPage=Object.assign(Object.assign({},realQuery),{page,pageSize:this.getQueryPageSize()}),fieldSchema=null===(_a=this.getSchema())||void 0===_a?void 0:_a.fields,promise=this.query(this.applyUsedFields(realQueryWithPage,missingFields),{scope:jimu_core.pQB.InAllData}).then((result=>{var _a,_b;return fieldSchema===(null===(_a=this.getSchema())||void 0===_a?void 0:_a.fields)&&(this.pagePromises[result.queryParams.page].fields=this.pagePromises[result.queryParams.page].fields.concat(missingFields),null===(_b=result.records)||void 0===_b||_b.forEach((newRecord=>{var _a,_b,_c;const prevRecord=null===(_a=this.pages[result.queryParams.page])||void 0===_a?void 0:_a.find((r=>r.getId()===newRecord.getId()));prevRecord&&prevRecord.setData(Object.assign(Object.assign({},prevRecord.getData()),newRecord.getData()));const prevRecordInSelection=null===(_c=null===(_b=this.getSelectionDataView())||void 0===_b?void 0:_b.getSourceRecords())||void 0===_c?void 0:_c.find((r=>r.getId()===newRecord.getId()));prevRecordInSelection&&prevRecordInSelection.setData(Object.assign(Object.assign({},prevRecordInSelection.getData()),newRecord.getData()))})),!0)}));this.loadMissingFieldsByPagePromises[page]={promise,fields:missingFields}}return this.loadMissingFieldsByPagePromises[page].promise}handleSelectionOnQueryParamChanges(){var _a,_b;if(this.useNoSelectionView(this.getSelectionDataView()))return;if(this.getSelectionDataView().pendingPromiseToQuerySelectedRecordsPresetBeforeDsReady)return;const isNoSelectionView=this.isDataView&&this.dataViewId===DATA_VIEW_ID_FOR_NO_SELECTION,isSelectionView=this.isSelectionView(),isLocalViewOfSelectionView=this.isLocalViewOfSelectionView();if(!isNoSelectionView&&!isSelectionView&&!isLocalViewOfSelectionView){const records=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords();let selectedRecordsNotInSelectionView=[];this.getSelectedRecordIds().forEach((id=>{const isInSelectionView=this.getSelectionDataView().getSourceRecords().some((r=>r.getId()===id)),r=records.find((r=>(null==r?void 0:r.getId())===id));!isInSelectionView&&r&&(selectedRecordsNotInSelectionView=selectedRecordsNotInSelectionView.concat(r))})),selectedRecordsNotInSelectionView.length>0&&this.copySelectionToDataView(this.getSelectionDataView().getSourceRecords().concat(selectedRecordsNotInSelectionView)),this.updateSelectionInfoOfDerivedDssAndChangeUrl(Object.assign(Object.assign({},null===(_a=this.getSelectOptionsFromInfo())||void 0===_a?void 0:_a.asMutable({deep:!0})),{ids:this.getSelectionDataView().getRecords().map((r=>r.getId()))}),this,!0)}else isSelectionView&&this.getMainDataSource().updateSelectionInfoOfDerivedDssAndChangeUrl(Object.assign(Object.assign({},null===(_b=this.getMainDataSource().getSelectOptionsFromInfo())||void 0===_b?void 0:_b.asMutable({deep:!0})),{ids:this.getRecords().map((r=>r.getId()))}))}loadByPage(realQuery,originQuery,usedFields,page){if(this.pagePromises[page])return this.pagePromises[page].promise;if(this.getDataSourceJson().isDataInDataSourceInstance&&this.sourceRecordsMissingFields(this.getSourceRecords(),usedFields))return Promise.resolve(!1);const realQueryWithPage=Object.assign(Object.assign({},realQuery),{page,pageSize:this.getQueryPageSize()});this.pagePromises[page]={promise:null,fields:usedFields};const promise=this.doQuery((0,jimu_core.J3Z)(realQueryWithPage),(0,jimu_core.J3Z)(originQuery)).then((result=>{const resultQueryWithoutPage=this.getQueryWithoutPage(result.queryParams);return!!jimu_core.WpD.isDeepEqual(resultQueryWithoutPage,this.lastQueryParams)&&("number"==typeof result.sourceVersion&&result.sourceVersion!==this.getSourceVersion()?(delete this.pagePromises[page],this.loadByPage(realQuery,originQuery,usedFields,page)):(this.pages[result.queryParams.page]=result.records,this.pagePromises[result.queryParams.page]&&(this.pagePromises[result.queryParams.page].exceededTransferLimit=result.exceededTransferLimit),!0))}));return this.pagePromises[page].promise=promise,this.pagePromises[page].promise}sourceRecordsMissingFields(sourceRecords,usedFields){return!(!sourceRecords||!usedFields)&&sourceRecords.some((r=>this.missingSomeFields(usedFields,Object.keys(r.getData()))))}loadCount(query,options={}){if(this.getCountStatus()===jimu_core.e3_.NotReady)return Promise.resolve(0);if(!this.checkClearLocalCache(query,this.lastCountQueryParams,"loadCount",options)&&this.countPromise)return null!=this.count?Promise.resolve(this.count):this.countPromise;const realQuery=this.getRealQueryParams(this.getQueryWithoutPage(query),"load",options);return this.lastCountQueryParams=realQuery,this.setCountStatus(jimu_core.e3_.Loading),this.count=null,this.countPromise=this.doQueryCount((0,jimu_core.J3Z)(realQuery)).then((result=>jimu_core.WpD.isDeepEqual(result.queryParams,this.lastCountQueryParams)?"number"==typeof result.sourceVersion&&result.sourceVersion!==this.getSourceVersion()?(delete this.countPromise,this.loadCount(query,options)):(null===this.getMaxRecordCount()?this.count=result.count:this.count=Math.min(result.count,this.getMaxRecordCount()),this.setCountStatus(jimu_core.e3_.Loaded),this.count):null),(err=>(console.error(err),this.setCountStatus(jimu_core.e3_.LoadError),null))),this.countPromise}loadById(id,refresh){return this.getStatus()===jimu_core.e3_.NotReady?Promise.resolve(null):(id===this.lastQueryId&&!refresh&&this.byIdPromise||(this.lastQueryId=id,this.setStatus(jimu_core.e3_.Loading),this.byIdPromise=this.doQueryById(id).then((record=>(this.setStatus(jimu_core.e3_.Loaded),record)),(err=>(console.error(err),this.setStatus(jimu_core.e3_.LoadError),null)))),this.byIdPromise)}query(query,options){if(this.getStatus()===jimu_core.e3_.NotReady)return Promise.resolve({queryParams:(0,jimu_core.J3Z)(query),records:[],fields:[],sourceVersion:this.getSourceVersion()});const realQuery=this.getRealQueryParams(query,"query",options);return this.doQuery((0,jimu_core.J3Z)(realQuery),(0,jimu_core.J3Z)(query)).then((result=>{const maxCount=this.getMaxRecordCount();if(null===maxCount)return result;const page=result.queryParams.page||1,pageSize=result.queryParams.pageSize;return 1!==page&&pageSize?(page-1)*pageSize>maxCount?result.records=[]:(page-1)*pageSize+result.records.length>maxCount&&(result.records=result.records.slice(0,(page-1)*pageSize+result.records.length-maxCount)):result.records.length>maxCount&&(result.records=result.records.slice(0,maxCount)),result}))}queryCount(query,options){if(this.getCountStatus()===jimu_core.e3_.NotReady)return Promise.resolve({queryParams:(0,jimu_core.J3Z)(query),count:0,sourceVersion:this.getSourceVersion()});if(this.useNoSelectionView()){const noSelectionView=this.getMainDataSource().getDataView(DATA_VIEW_ID_FOR_NO_SELECTION);if(noSelectionView)return noSelectionView.queryCount(query,options)}const realQuery=this.getRealQueryParams(query,"query",options);return this.doQueryCount((0,jimu_core.J3Z)(realQuery)).then((result=>(null===this.getMaxRecordCount()||(result.count=Math.min(result.count,this.getMaxRecordCount())),result)))}queryIds(query,options){if(this.getCountStatus()===jimu_core.e3_.NotReady)return Promise.resolve({queryParams:(0,jimu_core.J3Z)(query),ids:[],sourceVersion:this.getSourceVersion()});if(this.useNoSelectionView()){const noSelectionView=this.getMainDataSource().getDataView(DATA_VIEW_ID_FOR_NO_SELECTION);if(noSelectionView)return noSelectionView.queryIds(query,options)}const realQuery=this.getRealQueryParams(query,"query",options);return this.doQueryIds((0,jimu_core.J3Z)(realQuery)).then((result=>{if(null===this.getMaxRecordCount())return result;{const maxCount=Math.min(result.ids.length,this.getMaxRecordCount());return result.ids.splice(maxCount),result}}))}loadOrQueryAll(type,query,signal,progressCallback,options){const q=Object.assign({},query),result={queryParams:(0,jimu_core.J3Z)(q).without("page").without("pageSize"),records:[]},setIsAborted=result=>(result.isAborted=!0,result),loadOrQueryByPage=(pageSize,pageCount,result,signal,progressCallback)=>abstract_queriable_data_source_awaiter(this,void 0,void 0,(function*(){if(pageCount>0)for(let i=1;i<=pageCount;i++){if(null==signal?void 0:signal.aborted)return setIsAborted(result);q.page=i,q.pageSize=pageSize;const records="query"===type?yield this.query(q,options).then((res=>res.records)):yield this.load(q,options);(null==records?void 0:records.length)>0&&result.records.push(...records),null==progressCallback||progressCallback(i/pageCount,result)}return result}));return(null==signal?void 0:signal.aborted)?Promise.resolve(setIsAborted(result)):(null==progressCallback||progressCallback(0,result),new Promise(((resolve,reject)=>{signal&&(signal.onabort=e=>{resolve(setIsAborted(result))});("query"===type?this.queryCount(q,options).then((res=>res.count)):this.loadCount(q,options)).then((count=>{const totalCount=count,maxCount=null!==this.getMaxRecordCount()?Math.min(totalCount,this.getMaxRecordCount()):totalCount,pageSize=this.getMaxQueryPageSize()||this.getQueryPageSize(),pageCount=Math.ceil(maxCount/pageSize);loadOrQueryByPage(pageSize,pageCount,result,signal,progressCallback).then((r=>{resolve(r)})).catch((err=>{reject(err)}))})).catch((err=>{reject(err)}))})))}queryAll(query,signal,progressCallback,options){return this.loadOrQueryAll("query",query,signal,progressCallback,options)}queryById(id,fields){return abstract_queriable_data_source_awaiter(this,void 0,void 0,(function*(){return this.getStatus()===jimu_core.e3_.NotReady?yield Promise.resolve(null):yield this.doQueryById(id,fields)}))}getAutoRefreshInterval(){const ds=this.getMainDataSource();let interval=ds.getDataViewConfig()&&ds.getDataViewConfig().refreshInterval;return 0===interval?0:(null==interval&&(interval=ds.getSchema().refreshInterval),interval)}getLastRefreshTime(){return this.lastRefreshTime}startAutoRefresh(){const interval=this.getAutoRefreshInterval();interval&&(this.autoRefreshHandle||(this.setNeedRefresh(!1),this.autoRefreshHandle=setInterval((()=>{this.setNeedRefresh(!0),jimu_core.CM0.defer((()=>{this.setNeedRefresh(!1)}))}),1e3*interval)))}stopAutoRefresh(){this.autoRefreshHandle&&(this.setNeedRefresh(!1),clearInterval(this.autoRefreshHandle),this.autoRefreshHandle=null)}setNeedRefresh(needRefresh){this.getInfo().needRefresh!==needRefresh&&(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.setDataNeedRefresh(this.id,needRefresh))}setCapabilities(cap){this.capabilities=cap}getCapabilities(){return this.canSaveSourceRecords()?this.capabilities:this.getMainDataSource().getCapabilities()}getMainDataSource(){return super.getMainDataSource()}getDataViews(){return super.getDataViews()}getDataView(dataViewId){return super.getDataView(dataViewId)}updateSelectionInfo(options,triggerDataSource,forceCheck){var _a;if(!(null==options?void 0:options.ids)&&!(null==options?void 0:options.records))return;if(!(this.getListenSelection()||this.id===(null==triggerDataSource?void 0:triggerDataSource.id)))return;const isMainDataSource=!this.isLocal&&!this.isDataView,isOutputView=this.dataViewId===OUTPUT_DATA_VIEW_ID,isSubset=!isMainDataSource&&!isOutputView,ids=(null===(_a=options.records)||void 0===_a?void 0:_a.map((r=>r.getId())))||options.ids;if(!((forceCheck||isSubset)&&ids.length>0))return void this.changeSelectedRecordIdsOfDsInfo(options);const records=this.getRecords(),currentSelectedIds=this.getSelectedRecordIds();let idsNotInLoadedRecords=[],idsInLoadedRecords=[];const recordIdsMap={};records.forEach((r=>{if(r){const id=r.getId();recordIdsMap[id]=!0}}));const currentSelectedIdsMap={};currentSelectedIds.forEach((currentSelectedId=>{currentSelectedIdsMap[currentSelectedId]=!0})),ids.forEach((id=>{recordIdsMap[id]||!forceCheck&&currentSelectedIdsMap[id]?idsInLoadedRecords=idsInLoadedRecords.concat(id):idsNotInLoadedRecords=idsNotInLoadedRecords.concat(id)})),idsInLoadedRecords.length!==ids.length?this.throttleQueryRecordsByIdWithCurrentQueryParams(idsNotInLoadedRecords).then((res=>{var _a,_b;const prevSelectedIds=currentSelectedIds,curSelectedIds=this.getSelectedRecordIds();if(curSelectedIds.length===prevSelectedIds.length&&curSelectedIds.every((curId=>prevSelectedIds.some((prevId=>prevId===curId))))){const resRecordIdsMap={};(null===(_a=null==res?void 0:res.records)||void 0===_a?void 0:_a.length)>0&&res.records.forEach((r=>{if(r){const recordId=r.getId();resRecordIdsMap[recordId]=!0}}));const idsMatchQueryParamsNotInLoadedRecords=idsNotInLoadedRecords.filter((id=>resRecordIdsMap[id])),ids=idsInLoadedRecords.concat(idsMatchQueryParamsNotInLoadedRecords);this.changeSelectedRecordIdsOfDsInfo(Object.assign(Object.assign({},options),{ids,records:null===(_b=options.records)||void 0===_b?void 0:_b.filter((r=>ids.includes(r.getId())))}))}})).catch((err=>{console.error(`Failed to check whether selected records in ${this.id}. `,err)})):this.changeSelectedRecordIdsOfDsInfo(options)}changeSelectedRecordIdsOfDsInfo(options){var _a;(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.dataSourceSelectionChanged(this.id,options)),this.getMainDataSource().id===this.id&&(null===(_a=this.getSelectionDataView())||void 0===_a||_a.addVersion(),this.useNoSelectionView(this.getSelectionDataView())&&this.getSelectionDataView().addSourceVersion())}queryRecordsByIdWithCurrentQueryParams(ids,dataSource,queryParams){return abstract_queriable_data_source_awaiter(this,void 0,void 0,(function*(){const objectIds=ids,checkRecordsQueryParams=this.mergeQueryParams(queryParams,{objectIds});return dataSource?dataSource.queryAll(checkRecordsQueryParams):this.queryAll(checkRecordsQueryParams)}))}deleteOneLoadedRecordById(ds,id){const pages=ds.getPagesData();return Object.keys(pages).some((pId=>{var _a;const index=null===(_a=pages[pId])||void 0===_a?void 0:_a.findIndex((r=>(null==r?void 0:r.getId())===id));return"number"==typeof index&&index>-1&&(pages[pId].splice(index,1),null!=ds.count&&ds.count--,!0)}))}setOnceSetSourceRecords(func){this.onceSetSourceRecords=func}getAllUsedFields(options){return super.getAllUsedFields(options)}getExportOptions(){return jimu_core.ZkX.getExportOptions(this)}}const QueryCapabilitiesOfClientSideFeatureLayer={maxPageSize:1e3,supportsStatistics:!0,supportsPagination:!0,supportsOrderBy:!0,supportsDistinct:!0,supportsPaginationOnDistinct:!0,supportsPaginationOnStatisticsWithGroupBy:!1,supportsPaginationOnAggregatedQueries:!0,supportsOrderByOnlyOnLayerFields:!0,supportsPercentileStatistics:!0,supportsReturningQueryExtent:!0,supportedQueryFormats:"JSON, geoJSON"};class ArcGISCapabilitiesImpl extends CapabilitiesImpl{getQueryCapabilities(){var _a,_b,_c,_d,_e,_f,_g,_h,_j;return this.isClientSide||!this.layerDefinition?QueryCapabilitiesOfClientSideFeatureLayer:{maxPageSize:this.layerDefinition.maxRecordCount,supportsStatistics:!!(null===(_a=this.layerDefinition.advancedQueryCapabilities)||void 0===_a?void 0:_a.supportsStatistics),supportsPagination:!!(null===(_b=this.layerDefinition.advancedQueryCapabilities)||void 0===_b?void 0:_b.supportsPagination),supportsOrderBy:!!(null===(_c=this.layerDefinition.advancedQueryCapabilities)||void 0===_c?void 0:_c.supportsOrderBy),supportsDistinct:!!(null===(_d=this.layerDefinition.advancedQueryCapabilities)||void 0===_d?void 0:_d.supportsDistinct),supportsPaginationOnDistinct:!1!==(null===(_e=this.layerDefinition.advancedQueryCapabilities)||void 0===_e?void 0:_e.supportsPaginationOnAggregatedQueries),supportsPaginationOnStatisticsWithGroupBy:!!(null===(_f=this.layerDefinition.advancedQueryCapabilities)||void 0===_f?void 0:_f.supportsPaginationOnAggregatedQueries),supportsOrderByOnlyOnLayerFields:!!(null===(_g=this.layerDefinition.advancedQueryCapabilities)||void 0===_g?void 0:_g.supportsOrderByOnlyOnLayerFields),supportsPercentileStatistics:!!(null===(_h=this.layerDefinition.advancedQueryCapabilities)||void 0===_h?void 0:_h.supportsPercentileStatistics),supportedQueryFormats:this.layerDefinition.supportedQueryFormats,supportsReturningQueryExtent:!1!==(null===(_j=this.layerDefinition.advancedQueryCapabilities)||void 0===_j?void 0:_j.supportsReturningQueryExtent)}}}var abstract_arcgis_queriable_data_source_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class AbstractArcGISQueriableDataSource extends(js_api_layer_mixin_JSAPILayerMixinImpl(item_mixin_ItemMixinImpl(AbstractQueriableDataSource))){constructor(options){var _a;super(options);const dsJson=this.getDataSourceJson();this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId,this.layerId=dsJson.layerId,options.layer?this.layer=options.layer:options.belongToDataSource&&options.belongToDataSource.layer&&(this.layer=options.belongToDataSource.layer),this.getDataSourceJson().isDataInDataSourceInstance&&(this.url=null,this.itemId=null,this.portalUrl=null),this.url||this.setCapabilities(new ArcGISCapabilitiesImpl({layerDefinition:null,isClientSide:!0})),(null===(_a=this.layer)||void 0===_a?void 0:_a.portalItem)&&this.setItemInfo(this.layer.portalItem.sourceJSON)}getIdField(){return this.getSchema().idField}getGeometryType(){const layerDef=this.getLayerDefinition();return(null==layerDef?void 0:layerDef.type)===jimu_core.OhU.Table?null:this.getDataSourceJson().geometryType||(null==layerDef?void 0:layerDef.geometryType)}queryExtent(query,options){if(this.getCountStatus()===jimu_core.e3_.NotReady)return Promise.resolve({queryParams:(0,jimu_core.J3Z)(query),extent:null,sourceVersion:this.getSourceVersion()});if(this.useNoSelectionView()){const noSelectionView=this.getMainDataSource().getDataView(jimu_core.aH5.kf);if(noSelectionView)return noSelectionView.queryExtent(query,options)}const realQuery=this.getRealQueryParams(query,"query",options);return this.doQueryExtent((0,jimu_core.J3Z)(realQuery))}doQuery(realQuery,originQuery){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){var _a,_b,_c;if(this._printUseAllFieldsWarning(realQuery.outFields),!this.getCapabilities())return Promise.reject("Unable to perform query. Waiting for layer capabilities.");if(!realQuery||!originQuery)return Promise.reject("Unable to perform query. Query parameter is null.");let result=null,errorMsg="";const cap=this.getCapabilities().getQueryCapabilities(),originQueryWithOtherQueriesInDs=realQuery.merge(originQuery);if(realQuery.outStatistics){if(realQuery.outStatistics.some((stat=>stat.statisticType.includes("percentile")))?cap.supportsStatistics&&cap.supportsPercentileStatistics:cap.supportsStatistics){let fixedQuery=realQuery;if((null===(_a=realQuery.groupByFieldsForStatistics)||void 0===_a?void 0:_a.length)>0){if(cap.supportsPaginationOnStatisticsWithGroupBy||(fixedQuery=fixedQuery.without("page").without("pageSize")),(null===(_b=fixedQuery.orderByFields)||void 0===_b?void 0:_b.length)>0){let matchStatOrderBy=!1;if(cap.supportsOrderBy)if(cap.supportsOrderByOnlyOnLayerFields){matchStatOrderBy=!fixedQuery.orderByFields.some((oField=>realQuery.outStatistics.map((stat=>stat.outStatisticFieldName)).some((outStatName=>oField.split(" ").includes(outStatName)))))}else matchStatOrderBy=!0;matchStatOrderBy||(fixedQuery=fixedQuery.without("orderByFields"))}}else fixedQuery=realQuery.without("page").without("pageSize").without("orderByFields");result=yield this.doQueryByCapabilities(fixedQuery),result=this.enhanceStatisticQueryResult(result,fixedQuery,originQueryWithOtherQueriesInDs)}else errorMsg="Do not support statistic query."}else{const matchOrderBy=!((null===(_c=realQuery.orderByFields)||void 0===_c?void 0:_c.length)>0)||cap.supportsOrderBy,matchDistinct=!realQuery.returnDistinctValues||cap.supportsDistinct&&!!realQuery.outFields;if(matchOrderBy&&matchDistinct){const matchPagination=cap.supportsPagination,matchPaginationWithDistinct=!realQuery.returnDistinctValues||cap.supportsPaginationOnDistinct;matchPagination&&matchPaginationWithDistinct?result=yield this.doQueryByCapabilities(realQuery):realQuery.returnDistinctValues?(result=yield this.doQueryByCapabilities(realQuery.without("page").without("pageSize")),result.queryParams=realQuery.set("page",1)):result=yield this.doQueryWithoutPagination(realQuery)}else matchOrderBy?matchDistinct||(cap.supportsDistinct?realQuery.outFields||(errorMsg="outFields should be specified for returnDistinctValues."):errorMsg="Do not support distinct."):errorMsg="Do not support orderBy."}return result||Promise.reject(`Unable to perform query. Please check your parameters. ${errorMsg}`)}))}applyUsedFields(query,usedFields){var _a;if(!usedFields||(null==query?void 0:query.outStatistics))return query;const q=Object.assign({},query);if(!q.returnDistinctValues&&usedFields&&(q.outFields="string"==typeof usedFields?[usedFields]:usedFields),!q.returnDistinctValues&&q.outFields&&!q.outFields.includes("*")){const jimuIdField=this.getIdField();jimuIdField&&!q.outFields.includes(jimuIdField)&&(q.outFields=q.outFields.concat(jimuIdField))}if(q.outFields&&!q.outFields.includes("*")){const originTypeIdField=null===(_a=this.getLayerDefinition())||void 0===_a?void 0:_a.typeIdField,jimuTypeIdField=this.findJimuFieldName(originTypeIdField);jimuTypeIdField&&!q.outFields.includes(jimuTypeIdField)&&(q.outFields=q.outFields.concat(jimuTypeIdField))}return q}getAllUsedFields(options){var _a,_b,_c,_d;"debug"===(null==options?void 0:options.logLevel)&&console.group("All used fields");const query=null==options?void 0:options.queryParams,jimuIdField=this.getIdField();if(null==query?void 0:query.honorOutFields)return(null===(_a=null==query?void 0:query.outFields)||void 0===_a?void 0:_a.includes("*"))||(null===(_b=null==query?void 0:query.outFields)||void 0===_b?void 0:_b.includes(jimuIdField))?query.outFields:((null==query?void 0:query.outFields)||[]).concat(jimuIdField);let usedFields=(null===(_c=null==query?void 0:query.outFields)||void 0===_c?void 0:_c.includes("*"))?"*":(null==query?void 0:query.outFields)||[];if(!(null==query?void 0:query.returnDistinctValues)){const usedFieldsInQueryParams=jimu_core.ZkX.getUsedFieldsFromFeatureLayerQueryParams(query,this,"feature");if("debug"===(null==options?void 0:options.logLevel)&&console.log("Query params used fields are:",usedFieldsInQueryParams),usedFieldsInQueryParams.includes("*"))usedFields="*";else{const usedFieldsInConfigAndOnDemand=super.getAllUsedFields(options);usedFields="*"===usedFieldsInConfigAndOnDemand?"*":Array.from(new Set([...usedFieldsInConfigAndOnDemand,...usedFieldsInQueryParams]))}jimuIdField&&"*"!==usedFields&&!usedFields.includes(jimuIdField)&&usedFields.push(jimuIdField)}const originTypeIdField=null===(_d=this.getLayerDefinition())||void 0===_d?void 0:_d.typeIdField,jimuTypeIdField=this.findJimuFieldName(originTypeIdField);return jimuTypeIdField&&"*"!==usedFields&&!usedFields.includes(jimuTypeIdField)&&usedFields.push(jimuTypeIdField),"*"!==usedFields&&usedFields.length===Object.keys(this.getSchema().fields).length&&("debug"===(null==options?void 0:options.logLevel)&&console.warn("All used fields are * since used fields length equals schema fields length."),usedFields="*"),"debug"===(null==options?void 0:options.logLevel)&&(console.log("All used fields are:",usedFields),console.groupEnd()),usedFields}doQueryWithoutPagination(query){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){var _a;const queryByCapabilities=query.without("page").without("pageSize").set("returnIdsOnly",!0),matchedObjectIds=(null===(_a=(yield this.doQueryByCapabilities(queryByCapabilities)).records)||void 0===_a?void 0:_a.map((r=>r.getId())))||[],page="number"==typeof query.page?query.page:1,pageSize="number"==typeof query.pageSize?query.pageSize:this.getQueryPageSize(),objectIds=this.sliceByPage(matchedObjectIds,pageSize,page);if(0===objectIds.length)return{queryParams:query,records:[],count:0};const queryByObjectIds=query.without("page","pageSize","where","sqlFormat","geometry","geometryType","distance","units","outStatistics","groupByFieldsForStatistics","returnDistinctValues","time").set("objectIds",objectIds),result=yield this.doQueryByCapabilities(queryByObjectIds);return result.queryParams=query,result.exceededTransferLimit=matchedObjectIds.length>objectIds.length,result}))}doQueryByCapabilities(queryByCapabilities){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){var _a,_b,_c;let result={queryParams:queryByCapabilities,records:[],sourceVersion:this.getSourceVersion()};if(this.getDataSourceJson().isDataInDataSourceInstance){if(this.getSourceRecords().length>0){const sourceRecords=this.getSourceRecords();if(jimu_core.ZkX.areQueryParamsEmpty(queryByCapabilities)){const{start,end}=this.getStartAndEndForPage(queryByCapabilities.page,queryByCapabilities.pageSize),records=null!==start&&null!==end?sourceRecords.slice(start,end+1):sourceRecords;result={queryParams:queryByCapabilities,records,sourceVersion:this.getSourceVersion()}}else result=yield jimu_core.ZkX.createJSAPIFeatureLayerByRecords(this,sourceRecords,this.getSourceVersion()).then((_a=>abstract_arcgis_queriable_data_source_awaiter(this,[_a],void 0,(function*({layer,sourceVersion}){const r=yield this.doQueryByLayerCapabilities(queryByCapabilities,layer);return Object.assign(Object.assign({},r),{sourceVersion})}))))}}else if(this.layer)result=yield this.doQueryByLayerCapabilities(queryByCapabilities,this.layer);else if(this.url){if("define"in window&&"function"==typeof window.define&&"amd"in window.define&&!this.layerForRestQuery&&(yield this.createLayerForRestQuery()),this.layerForRestQuery)result=yield this.doQueryByLayerCapabilities(queryByCapabilities,this.layerForRestQuery);else{result=yield this.doQueryByUrlCapabilities(queryByCapabilities,this.url);"pbf"===((null===(_c=null===(_b=null===(_a=this.getCapabilities().getQueryCapabilities().supportedQueryFormats)||void 0===_a?void 0:_a.toLowerCase)||void 0===_b?void 0:_b.call(_a))||void 0===_c?void 0:_c.includes("pbf"))?"pbf":"json")&&this.createLayerForRestQuery()}}else result=yield this.createJSAPILayerByFeatureCollectionItemId().then((layer=>this.doQueryByLayerCapabilities(queryByCapabilities,layer)));return result}))}createLayerForRestQuery(){return this.isDataView||this.isLocal?this.getMainDataSource().createLayerForRestQuery():this.layerForRestQuery?Promise.resolve():(this.layerForRestQueryPromise||(this.layerForRestQueryPromise=this.createJSAPILayerByDataSource(this,!1).then((layer=>{this.layerForRestQuery=layer,this.getAllDerivedDataSources().forEach((ds=>{ds.layerForRestQuery=layer}))})).catch((err=>{console.warn("Failed to create JS API layer to do query.",err)}))),this.layerForRestQueryPromise)}enhanceStatisticQueryResult(queryResult,realQuery,originQueryWithOtherQueriesInDs){var _a,_b;let fixedRecords=null===(_a=queryResult.records)||void 0===_a?void 0:_a.slice();if(!fixedRecords)return queryResult;let fixedQueryParams=queryResult.queryParams;if(null==originQueryWithOtherQueriesInDs?void 0:originQueryWithOtherQueriesInDs.outStatistics){if(originQueryWithOtherQueriesInDs.orderByFields&&!(null==realQuery?void 0:realQuery.orderByFields)&&(fixedRecords=fixedRecords.length>1?this.sortRecordsByFields(fixedRecords,originQueryWithOtherQueriesInDs.orderByFields):fixedRecords,fixedQueryParams=fixedQueryParams.set("orderByFields",originQueryWithOtherQueriesInDs.orderByFields)),"number"==typeof originQueryWithOtherQueriesInDs.pageSize&&"number"!=typeof(null==realQuery?void 0:realQuery.pageSize)){const page=null!==(_b=originQueryWithOtherQueriesInDs.page)&&void 0!==_b?_b:1;fixedRecords=this.sliceByPage(fixedRecords,originQueryWithOtherQueriesInDs.pageSize,page),fixedQueryParams=fixedQueryParams.set("pageSize",originQueryWithOtherQueriesInDs.pageSize),fixedQueryParams=fixedQueryParams.set("page",originQueryWithOtherQueriesInDs.page)}originQueryWithOtherQueriesInDs.outStatistics.every((stat=>!(null==stat?void 0:stat.outStatisticFieldName)||fixedRecords.some((r=>void 0!==r.getFieldValue(stat.outStatisticFieldName)))))||originQueryWithOtherQueriesInDs.outStatistics.forEach((stat=>{if(null==stat?void 0:stat.outStatisticFieldName){const isOutStatNameLowerCase=fixedRecords.some((r=>void 0!==r.getFieldValue(stat.outStatisticFieldName.toLowerCase()))),isOutStatNameUpperCase=fixedRecords.some((r=>void 0!==r.getFieldValue(stat.outStatisticFieldName.toUpperCase())));fixedRecords.forEach((r=>{const realOutStatName=isOutStatNameLowerCase?stat.outStatisticFieldName.toLowerCase():isOutStatNameUpperCase?stat.outStatisticFieldName.toUpperCase():null;realOutStatName&&(r.feature.attributes[stat.outStatisticFieldName]=r.getFieldValue(realOutStatName),delete r.feature.attributes[realOutStatName])}))}}))}return Object.assign(Object.assign({},queryResult),{records:fixedRecords,queryParams:fixedQueryParams})}sliceByPage(records,pageSize,page){const start=pageSize*(page-1),end=start+pageSize;return records.slice(start,end)}sortRecordsByFields(records,orderByFields){return records.filter((r=>!!r)).sort(((r1,r2)=>this.compareRecordsByFields(r1,r2,orderByFields)))}compareRecordsByFields(r1,r2,orderByFields){var _a,_b;let index=0,res=0;for(;index<orderByFields.length;){const jimuFieldName=orderByFields[index].split(" ")[0];let compareByValue=0;if(orderByFields[index].split(" ").length>2)compareByValue=0;else if(typeof r1.getFieldValue(jimuFieldName)!=typeof r2.getFieldValue(jimuFieldName)){const jimuField=null===(_b=null===(_a=this.getSchema())||void 0===_a?void 0:_a.fields)||void 0===_b?void 0:_b[jimuFieldName],typeOfOrderByField=((null==jimuField?void 0:jimuField.type)||jimu_core.Eo3.Number)===jimu_core.Eo3.String?"string":"number",r1TypeIsSameWithOrderByField=typeof r1.getFieldValue(jimuFieldName)===typeOfOrderByField,r2TypeIsSameWIthOrderByField=typeof r2.getFieldValue(jimuFieldName)===typeOfOrderByField;compareByValue=r1TypeIsSameWithOrderByField&&!r2TypeIsSameWIthOrderByField?1:!r1TypeIsSameWithOrderByField&&r2TypeIsSameWIthOrderByField?-1:0}else{const valueOfR1=r1.getFieldValue(jimuFieldName),valueOfR2=r2.getFieldValue(jimuFieldName);compareByValue=this.getCompareValueResult(valueOfR1,valueOfR2)}if(res="DESC"===orderByFields[index].split(" ")[1]?-compareByValue:compareByValue,0!==res)break;index++}return res}getCompareValueResult(v1,v2){let res=0;return"string"==typeof v1&&"string"==typeof v2?res=v1.localeCompare?v1.localeCompare(v2):0:"number"==typeof v1&&"number"==typeof v2&&(res=v1-v2),res}doQueryCount(queryParams){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){const fixedQuery=null==queryParams?void 0:queryParams.without("page","pageSize","orderByFields","returnIdsOnly");if(this.getDataSourceJson().isDataInDataSourceInstance){if(0===this.getSourceRecords().length)return Promise.resolve({queryParams,count:0,sourceVersion:this.getSourceVersion()});const sourceRecords=this.getSourceRecords();if(jimu_core.ZkX.areQueryParamsEmpty(fixedQuery))return Promise.resolve({queryParams,count:sourceRecords.length,sourceVersion:this.getSourceVersion()});const{layer,sourceVersion}=yield jimu_core.ZkX.createJSAPIFeatureLayerByRecords(this,sourceRecords,this.getSourceVersion()),result=yield this.doQueryCountByLayer(fixedQuery,layer);return Object.assign(Object.assign({},result),{queryParams,sourceVersion})}{let result;return result=this.layer?yield this.doQueryCountByLayer(fixedQuery,this.layer):this.url?yield this.doQueryCountByUrl(fixedQuery,this.url):yield this.createJSAPILayerByFeatureCollectionItemId().then((layer=>this.doQueryCountByLayer(fixedQuery,layer))),Object.assign(Object.assign({},result),{queryParams})}}))}doQueryIds(queryParams){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){if(this.getDataSourceJson().isDataInDataSourceInstance){if(0===this.getSourceRecords().length)return Promise.resolve({queryParams,ids:[],sourceVersion:this.getSourceVersion()});const sourceRecords=this.getSourceRecords();return jimu_core.ZkX.areQueryParamsEmpty(queryParams)?Promise.resolve({queryParams,ids:sourceRecords.map((r=>r.getId())),sourceVersion:this.getSourceVersion()}):jimu_core.ZkX.createJSAPIFeatureLayerByRecords(this,sourceRecords,this.getSourceVersion()).then((_a=>abstract_arcgis_queriable_data_source_awaiter(this,[_a],void 0,(function*({layer,sourceVersion}){const result=yield this.doQueryIdsByLayer(queryParams,layer);return Object.assign(Object.assign({},result),{sourceVersion})}))))}return this.layer?this.doQueryIdsByLayer(queryParams,this.layer):this.url?this.doQueryIdsByUrl(queryParams,this.url):this.createJSAPILayerByFeatureCollectionItemId().then((layer=>this.doQueryIdsByLayer(queryParams,layer)))}))}doQueryExtent(queryParams){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){if(!this.getCapabilities().getQueryCapabilities().supportsReturningQueryExtent)return Promise.reject("Unable to perform extent query.");if(this.getDataSourceJson().isDataInDataSourceInstance){if(0===this.getSourceRecords().length)return Promise.resolve({queryParams,extent:null,count:0,sourceVersion:this.getSourceVersion()});const sourceRecords=this.getSourceRecords();return jimu_core.ZkX.createJSAPIFeatureLayerByRecords(this,sourceRecords,this.getSourceVersion()).then((_a=>abstract_arcgis_queriable_data_source_awaiter(this,[_a],void 0,(function*({layer,sourceVersion}){const result=yield this.doQueryExtentByLayer(queryParams,layer);return Object.assign(Object.assign({},result),{sourceVersion})}))))}return this.layer?this.doQueryExtentByLayer(queryParams,this.layer):this.url?this.doQueryExtentByUrl(queryParams,this.url):this.createJSAPILayerByFeatureCollectionItemId().then((layer=>this.doQueryExtentByLayer(queryParams,layer)))}))}doQueryExtentByLayer(queryParams,layer){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){const layerView=this.getLayerViewForClientSideQuery(layer);let res,isClientQuerySuccess=!1;if(layerView){const clientQueryResult=yield layerView.clientQueryExtent(queryParams);(null==clientQueryResult?void 0:clientQueryResult.success)&&(isClientQuerySuccess=!0,res=clientQueryResult.data)}if(!isClientQuerySuccess){const query=yield this.changeJimuQueryToJSAPIQuery(queryParams);res=yield this.jsAPILayerQueryExtent(query,layer)}return{queryParams,count:res.count,extent:res.extent}}))}doQueryExtentByUrl(queryParams,url){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){const query=this.changeJimuQueryToRestAPIQuery(queryParams);return delete query.resultRecordCount,delete query.resultOffset,delete query.returnIdsOnly,query.returnExtentOnly||(query.returnExtentOnly=!0),yield this._q(query,url).then((queryResponse=>({queryParams,count:queryResponse.count,extent:queryResponse.extent})))}))}doQueryCountByLayer(queryParams,layer){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){const layerView=this.getLayerViewForClientSideQuery(layer);let count,isClientQuerySuccess=!1;if(layerView){const clientQueryResult=yield layerView.clientQueryFeatureCount(queryParams);(null==clientQueryResult?void 0:clientQueryResult.success)&&(isClientQuerySuccess=!0,count=clientQueryResult.data)}if(!isClientQuerySuccess){const query=yield this.changeJimuQueryToJSAPIQuery(queryParams);count=yield this.jsAPILayerQueryFeatureCount(query,layer)}return{queryParams,count}}))}doQueryCountByUrl(queryParams,url){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){const query=this.changeJimuQueryToRestAPIQuery(queryParams);return query.returnCountOnly||(query.returnCountOnly=!0),yield this._q(query,url).then((queryResponse=>({queryParams,count:queryResponse.count})))}))}doQueryIdsByLayer(queryParams,layer){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){const query=yield this.changeJimuQueryToJSAPIQuery(queryParams),layerView=this.getLayerViewForClientSideQuery(layer);let ids,isClientQuerySuccess=!1;if(layerView){const clientQueryResult=yield layerView.clientQueryObjectIds(queryParams);(null==clientQueryResult?void 0:clientQueryResult.success)&&(isClientQuerySuccess=!0,ids=clientQueryResult.data)}return isClientQuerySuccess||(ids=yield this.jsAPILayerQueryObjectIds(query,layer)),ids||(ids=[]),{queryParams,ids:ids.map((i=>`${i}`))}}))}doQueryIdsByUrl(queryParams,url){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){const query=this.changeJimuQueryToRestAPIQuery(queryParams);return delete query.resultRecordCount,delete query.resultOffset,delete query.returnCountOnly,delete query.returnGeometry,query.returnIdsOnly||(query.returnIdsOnly=!0),this._q(query,url).then((queryResponse=>{var _a;return{queryParams,ids:null===(_a=queryResponse.objectIds)||void 0===_a?void 0:_a.map((i=>`${i}`))}}))}))}doQueryById(id,fields){const outFields=fields||["*"];return this.doQueryByCapabilities((0,jimu_core.J3Z)({objectIds:[id],returnGeometry:!0,returnZ:!0,outFields,notAddFieldsToClient:!0})).then((result=>result.records[0]))}getConfigQueryParams(){var _a;const query=this.getDataViewConfig();if(!query)return null;return{where:jimu_core.ZkX.getArcGISSQL(query.where,this).sql,sqlExpression:null===(_a=query.where)||void 0===_a?void 0:_a.asMutable({deep:!0}),orderByFields:this.getOrderByArray(query.orderBy)}}mergeQueryParams(...queries){let mergedQueries=(queries=queries||[]).filter((q=>q)).reduce(((res,q)=>Object.assign(Object.assign({},res),q)),{});const timeArr=queries.map((q=>null==q?void 0:q.time)).filter((w=>"number"==typeof w||Array.isArray(w))),time=timeArr.length>1?timeArr.reduce(((res,t)=>jimu_core.ZkX.mergeTimeExtent(res,t)),null):timeArr[0];if(delete mergedQueries.time,-1===time)return mergedQueries.where="1=2",mergedQueries;("number"==typeof time||Array.isArray(time))&&(mergedQueries.time=time);const whereArr=queries.map((q=>null==q?void 0:q.where)).filter((w=>w&&"1=1"!==w)),where=whereArr.length>1?whereArr.map((w=>`(${w})`)).join(" and "):whereArr[0];mergedQueries=Object.assign(Object.assign({},mergedQueries),{where:where||"1=1"});const sqlExpressionArr=queries.map((q=>null==q?void 0:q.sqlExpression)).filter((s=>s)),sqlExpression=sqlExpressionArr.length>1?sqlExpressionArr.reduce(((res,s)=>jimu_core.ZkX.getMergedSQLExpressions([res,s],this)),null):sqlExpressionArr[0];if(mergedQueries=Object.assign(Object.assign({},mergedQueries),{sqlExpression}),mergedQueries.returnDistinctValues){const distinctQuery=queries.reverse().find((q=>null==q?void 0:q.returnDistinctValues));mergedQueries=Object.assign(Object.assign({},mergedQueries),{outFields:distinctQuery.outFields})}else{const outFieldsArr=queries.map((q=>null==q?void 0:q.outFields)).filter((f=>f)),outFields=outFieldsArr.length>1?Array.from(new Set(outFieldsArr.reduce(((res,f)=>res.concat(f)),[]))):outFieldsArr[0];mergedQueries=Object.assign(Object.assign({},mergedQueries),{outFields:(null==outFields?void 0:outFields.includes("*"))?["*"]:outFields})}return mergedQueries}getCurrentQueryParams(options){const query=super.getCurrentQueryParams(options);return this.applyGDBVersionAndFix(query,null==options?void 0:options.dataSourceToFormatSql)}getRealQueryParams(query,flag,options){const rq=super.getRealQueryParams(query,flag,options);return this.applyGDBVersionAndFix(rq,null==options?void 0:options.dataSourceToFormatSql)}getRemoteQueryParams(){return this.getSchema().filter?{where:this.getSchema().filter}:null}applyGDBVersionAndFix(query,dataSourceToFormatSql){this.getGDBVersion()&&(query.gdbVersion=this.getGDBVersion());let q=this.fixQueryParam((0,jimu_core.J3Z)(query));return q.sqlExpression&&dataSourceToFormatSql&&dataSourceToFormatSql.isSqlCaseSensitive!==this.isSqlCaseSensitive&&(q=q.set("where",jimu_core.ZkX.getArcGISSQL(q.sqlExpression,dataSourceToFormatSql).sql)),q.asMutable({deep:!0})}fixQueryParam(q){var _a,_b,_c,_d;let fixedQuery=q;if(q.outStatistics&&Object.keys(q).forEach((k=>{["outStatistics","where","gdbVersion","geometry","geometryType","spatialRel","distance","units","groupByFieldsForStatistics","time","orderByFields","havingClause","page","pageSize"].includes(k)||(fixedQuery=fixedQuery.without(k))})),q.returnDistinctValues&&q.returnGeometry&&(fixedQuery=fixedQuery.set("returnGeometry",!1)),!q.returnDistinctValues&&q.returnGeometry&&(fixedQuery=fixedQuery.set("returnZ",!0)),!fixedQuery.outStatistics&&!fixedQuery.returnDistinctValues&&(null===(_a=fixedQuery.orderByFields)||void 0===_a?void 0:_a.length)>0){!!fixedQuery.orderByFields.find((f=>f.split(" ")[0]===this.getIdField()))||(fixedQuery=fixedQuery.set("orderByFields",fixedQuery.orderByFields.concat([`${this.getIdField()} ASC`])))}return fixedQuery.returnDistinctValues&&(null===(_b=fixedQuery.outFields)||void 0===_b?void 0:_b.length)&&!(null===(_c=fixedQuery.orderByFields)||void 0===_c?void 0:_c.length)&&(fixedQuery=fixedQuery.set("orderByFields","*"===fixedQuery.outFields[0]?[`${this.getIdField()} ASC`]:[fixedQuery.outFields[0]])),jimu_core.ZkX.areDatesInUnknownTimezone(this)&&(fixedQuery=fixedQuery.set("timeReferenceUnknownClient",!0)),(null===(_d=fixedQuery.outFields)||void 0===_d?void 0:_d.some((f=>!f)))&&(fixedQuery=fixedQuery.set("outFields",fixedQuery.outFields.filter((f=>!!f)))),fixedQuery}fetchSchema(){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){if(this.getDataSourceJson().isStatistic||!this.url&&!this.itemId&&!this.layer)return Promise.resolve((0,jimu_core.J3Z)({}));let schema;return schema=this.layer?yield this.fetchSchemaWithLayer():yield this.fetchSchemaWithoutLayer(),(null==schema?void 0:schema.fields)&&Object.keys(schema.fields).length?schema:Promise.reject(new jimu_core.yR5(this.id,"No fields."))}))}createJSAPILayerByFeatureCollectionItemId(){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){return this.createFeatureLayerPromise||(this.itemId?this.createFeatureLayerPromise=(0,jimu_core.e$n)(["esri/layers/Layer","esri/portal/PortalItem"]).then((modules=>abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){const Layer=modules[0],PortalItem=modules[1];return yield Layer.fromPortalItem({portalItem:new PortalItem({id:this.itemId,portal:{url:this.portalUrl}})})})))).then((layer=>abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){return(null==layer?void 0:layer.type)===jimu_core.QBT.FeatureLayer?yield Promise.resolve(layer):(null==layer?void 0:layer.type)===jimu_core.QBT.GroupLayer?yield layer.loadAll().then((layer=>abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){const featureLayer=layer.layers.toArray().find((l=>`${l.layerId}`===this.layerId||jimu_core.ZkX.fixLayerId(l.title)===jimu_core.ZkX.fixLayerId(this.getMainDataSource().getDataSourceJson().sourceLabel)));return(null==featureLayer?void 0:featureLayer.type)===jimu_core.QBT.FeatureLayer?Promise.resolve(featureLayer):Promise.reject("Feature layer data source error: failed to create feature layer with specific layer id.")})))):void 0})))):this.createFeatureLayerPromise=Promise.reject("No item id.")),this.createFeatureLayerPromise}))}fetchSchemaWithoutLayer(){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){const serviceInfoPromise=this.url?jimu_core.ljd.getInstance().fetchServiceInfo(this.url):Promise.resolve(null);return yield serviceInfoPromise.then((serviceInfo=>this.itemId?Promise.all([this.fetchItemData(),this.fetchItemInfo()]).then((([itemData,itemInfo])=>{var _a;const layerInfo=itemData&&itemData.layers&&(itemData.layers.find((l=>`${l.id}`===this.layerId))||itemData.layers[this.layerId]),serviceDefinition=(null==serviceInfo?void 0:serviceInfo.definition)?this.getUpdatedLayerDefinition(layerInfo,serviceInfo.definition):null==layerInfo?void 0:layerInfo.layerDefinition;return!this.parentDataSource&&serviceDefinition&&(serviceDefinition.name=(null==itemInfo?void 0:itemInfo.title)||serviceDefinition.name),{serviceDefinition,fieldInfos:layerInfo&&layerInfo.popupInfo&&layerInfo.popupInfo.fieldInfos,filter:(null===(_a=null==layerInfo?void 0:layerInfo.layerDefinition)||void 0===_a?void 0:_a.definitionExpression)?`(${layerInfo.layerDefinition.definitionExpression})`:null,refreshInterval:60*(null==layerInfo?void 0:layerInfo.refreshInterval)}})):{serviceDefinition:null==serviceInfo?void 0:serviceInfo.definition,fieldInfos:null,filter:null,refreshInterval:null})).then((({serviceDefinition,fieldInfos,filter,refreshInterval})=>{var _a,_b,_c;const schema={fields:{},idField:(null==serviceDefinition?void 0:serviceDefinition.idField)||(null===(_b=null===(_a=null==serviceDefinition?void 0:serviceDefinition.fields)||void 0===_a?void 0:_a.find((f=>"esriFieldTypeOID"===f.type)))||void 0===_b?void 0:_b.name)||"OBJECTID",filter,refreshInterval,label:null==serviceDefinition?void 0:serviceDefinition.name};return this.setLayerDefinitionAndQueryCapabilities(serviceDefinition),null===(_c=null==serviceDefinition?void 0:serviceDefinition.fields)||void 0===_c||_c.forEach((f=>{const fieldInfo=fieldInfos&&fieldInfos.find((fi=>fi.fieldName===f.name)),jimuField=jimu_core.ZkX.convertFieldToJimuField(f,fieldInfo);jimuField&&(schema.fields[f.name]=jimuField)})),(0,jimu_core.J3Z)(schema)}))}))}fetchSchemaWithLayer(){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){return this.layer.load().then((()=>{var _a,_b,_c;if(!this.layer.fields)return null;this.updateLayerDefinitionByLayer();const schema={fields:{},idField:this.layer.objectIdField||(null===(_b=null===(_a=this.layer.fields)||void 0===_a?void 0:_a.find((f=>"oid"===f.type)))||void 0===_b?void 0:_b.name)||"OBJECTID",filter:this.layer.definitionExpression?`${this.layer.definitionExpression}`:null,refreshInterval:60*(null!==(_c=this.layer.refreshInterval)&&void 0!==_c?_c:0),label:this.layer.title};return this.layer.fields.forEach((field=>{const fieldInfo=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos&&this.layer.popupTemplate.fieldInfos.find((f=>f.fieldName===field.name)),jimuField=jimu_core.ZkX.convertFieldToJimuField(field.toJSON(),null==fieldInfo?void 0:fieldInfo.toJSON());jimuField&&(schema.fields[field.name]=jimuField)})),(0,jimu_core.J3Z)(schema)}))}))}updateLayerDefinitionByLayer(){var _a,_b;let layerDef=this.layer.sourceJSON;if(this.layer.type===jimu_core.QBT.SubtypeGroupLayer){let renderer;this.layer.sublayers.forEach((ly=>{const lyRendererJSON=ly.renderer.toJSON();if(lyRendererJSON.field1===layerDef.subtypeField&&"uniqueValue"===lyRendererJSON.type&&lyRendererJSON.field1&&!lyRendererJSON.field2)if(renderer){const valueInfo=lyRendererJSON.uniqueValueInfos[0];renderer.uniqueValueInfos.push(valueInfo)}else renderer=lyRendererJSON})),renderer&&(layerDef=Object.assign({name:this.layer.title},layerDef,{drawingInfo:{renderer}}))}else{const renderer=this.layer.renderer;if(renderer&&renderer.toJSON()){const rendererJSON=renderer.toJSON();if("uniqueValue"===rendererJSON.type){let types=(null===(_a=this.layer.sourceJSON)||void 0===_a?void 0:_a.types)||[];rendererJSON.field1!==(null===(_b=this.layer.sourceJSON)||void 0===_b?void 0:_b.typeIdField)&&(types=[],rendererJSON.uniqueValueInfos.forEach((item=>{types.push({id:item.value,name:item.label,domain:{}})}))),layerDef=Object.assign({name:this.layer.title},layerDef,{drawingInfo:{renderer:rendererJSON},typeIdField:rendererJSON.field1,types})}}}layerDef&&["typeIdField","subtypeField"].forEach((key=>{layerDef[key]&&layerDef.fields&&!layerDef.fields.filter((field=>field.name===layerDef[key])).length&&layerDef.fields.some((field=>field.name.toLowerCase()===layerDef[key].toLowerCase()&&(layerDef[key]=field.name,!0)))})),this.setLayerDefinitionAndQueryCapabilities(layerDef)}getLayerDefinition(){return jimu_core.ZkX.getLayerDefinition(this)}setLayerDefinition(layerDef){this.layerDefinition=layerDef}getPopupInfo(){return jimu_core.ZkX.getPopupInfo(this)}getPopupInfoFields(){var _a,_b,_c;return(null===(_c=null===(_b=null===(_a=this.getPopupInfo())||void 0===_a?void 0:_a.fieldInfos)||void 0===_b?void 0:_b.map((fieldInfo=>!1===fieldInfo.visible?null:this.findJimuFieldName(fieldInfo.fieldName))))||void 0===_c?void 0:_c.filter((f=>!!f)))||[]}setPopupInfo(popupInfo){this.popupInfo=popupInfo}getItemInfo(){return this.isDataView||this.isLocal?this.getMainDataSource().getItemInfo():super.getItemInfo()}setLayerDefinitionAndQueryCapabilities(layerDef){this.setLayerDefinition(layerDef),this.setCapabilities(new ArcGISCapabilitiesImpl({layerDefinition:this.getLayerDefinition(),isClientSide:!this.url}))}getCapabilities(){return super.getCapabilities()}buildRecord(feature){return new FeatureDataRecordImpl(feature,this)}getFieldCodedValueList(jimuFieldName,record){let fieldName="";const fields=this.getSchema().fields;return Object.keys(fields).some((name=>name===jimuFieldName&&(fieldName=fields[name].name,!0))),jimu_core.ZkX.getCodedValueListForCodedValueOrSubtypeField(this.getLayerDefinition(),fieldName,record)}getGDBVersion(){return this.getInfo().gdbVersion}changeGDBVersion(gdbVersion){(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.changeDataSourceGDBVersion(this.id,gdbVersion)),this.layer&&(this.layer.gdbVersion=gdbVersion)}getUpdatedLayerDefinition(layerInfo,serviceDefinition){let updatedDefinition=serviceDefinition,updatedOptions={};if(layerInfo&&layerInfo.layerDefinition){const drawingInfo=layerInfo.layerDefinition.drawingInfo;if(drawingInfo){if(drawingInfo.renderer&&"uniqueValue"===drawingInfo.renderer.type){let types=serviceDefinition.types;drawingInfo.renderer.field1!==serviceDefinition.typeIdField&&(types=[],drawingInfo.renderer.uniqueValueInfos.forEach((item=>{types.push({id:item.value,name:item.label,domain:{}})}))),updatedOptions={defaultVisibility:layerInfo.layerDefinition.defaultVisibility,drawingInfo:layerInfo.layerDefinition.drawingInfo,typeIdField:drawingInfo.renderer.field1,types}}}else layerInfo.layerDefinition.defaultVisibility!==serviceDefinition.defaultVisibility&&(updatedOptions={defaultVisibility:layerInfo.layerDefinition.defaultVisibility})}return layerInfo&&layerInfo.title&&(updatedOptions.name=layerInfo.title),updatedDefinition=Object.assign({},updatedDefinition,updatedOptions),updatedDefinition}getOrderByArray(orderBys){var _a;return null!==(_a=null==orderBys?void 0:orderBys.map((orderBy=>orderBy.jimuFieldName+" "+orderBy.order)).asMutable())&&void 0!==_a?_a:[]}changeJimuQueryToRestAPIQuery(queryParams){var _a,_b,_c,_d,_e;if(!queryParams)return null;const q=queryParams.asMutable({deep:!0});if("number"==typeof q.pageSize){const page=null!==(_a=q.page)&&void 0!==_a?_a:1;q.resultOffset=(page-1)*q.pageSize,q.resultRecordCount=q.pageSize,null!==this.getMaxRecordCount()&&(1===page?q.resultRecordCount=Math.min(this.getMaxRecordCount(),q.pageSize):page*q.pageSize>this.getMaxRecordCount()&&(q.resultRecordCount=this.getMaxRecordCount()-(page-1)*q.pageSize)),delete q.page,delete q.pageSize}return Array.isArray(q.orderByFields)&&(q.orderByFields=q.orderByFields.join(",")),Array.isArray(q.groupByFieldsForStatistics)&&(q.groupByFieldsForStatistics=q.groupByFieldsForStatistics.join(",")),Array.isArray(q.time)&&(q.time=q.time.join(",")),(null===(_b=q.outStatistics)||void 0===_b?void 0:_b.some((stat=>{var _a;return null===(_a=stat.statisticParameters)||void 0===_a?void 0:_a.orderBy})))&&(q.outStatistics=q.outStatistics.map((stat=>{var _a;return(null===(_a=stat.statisticParameters)||void 0===_a?void 0:_a.orderBy)&&(stat.statisticParameters.orderBy=stat.statisticParameters.orderBy.toUpperCase()),stat}))),(null===(_c=q.objectIds)||void 0===_c?void 0:_c.length)&&(q.objectIds=q.objectIds.map((id=>+id)).filter((id=>!isNaN(id)))),(null===(_d=q.outStatistics)||void 0===_d?void 0:_d.length)||(null===(_e=q.outFields)||void 0===_e?void 0:_e.length)||(q.outFields=[this.getIdField()]),q}changeJimuQueryToJSAPIQuery(queryParams){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){return yield jimu_core.ZkX.changeJimuArcGISQueryToJSAPIQuery(this,queryParams)}))}doQueryByUrlCapabilities(queryParams,url){const query=this.changeJimuQueryToRestAPIQuery(queryParams);return query.returnCountOnly?(console.error("To query count, please use queryCount."),Promise.reject("To query count, please use queryCount.")):this._q(query,url).then((queryResponse=>{var _a;const fields=Object.keys(this.getSchema().fields).filter((jimuFieldName=>queryResponse.fields&&queryResponse.fields.find((field=>field.name===this.getSchema().fields[jimuFieldName].name))));return{queryParams,fields,records:(queryResponse.features?queryResponse.features.map((feature=>new FeatureDataRecordImpl(feature,this))):null===(_a=queryResponse.objectIds)||void 0===_a?void 0:_a.map((id=>new FeatureDataRecordImpl({attributes:{[this.getIdField()]:id}},this))))||[],exceededTransferLimit:queryResponse.exceededTransferLimit}}))}doQueryByLayerCapabilities(queryParams,layer){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){var _a;const query=yield this.changeJimuQueryToJSAPIQuery(queryParams),layerView=this.getLayerViewForClientSideQuery(layer);if(queryParams.returnIdsOnly){let objectIds;delete query.returnIdsOnly;let isClientQuerySuccess=!1;if(layerView){const clientQueryResult=yield layerView.clientQueryObjectIds(queryParams);(null==clientQueryResult?void 0:clientQueryResult.success)&&(isClientQuerySuccess=!0,objectIds=clientQueryResult.data)}isClientQuerySuccess||(objectIds=yield this.jsAPILayerQueryObjectIds(query,layer));const records=null==objectIds?void 0:objectIds.map((id=>new FeatureDataRecordImpl({attributes:{[this.getIdField()]:id}},this))),fields=[this.getIdField()];return{queryParams,records,fields}}{let featureSet,isClientQuerySuccess=!1,hasFullGeometry=!0;if(layerView){let clientQueryParams=queryParams;(null===(_a=clientQueryParams.orderByFields)||void 0===_a?void 0:_a.length)||(clientQueryParams=clientQueryParams.set("orderByFields",[this.getIdField()]));const clientQueryResult=yield layerView.clientQueryFeatures(clientQueryParams);(null==clientQueryResult?void 0:clientQueryResult.success)&&(isClientQuerySuccess=!0,featureSet=clientQueryResult.data,hasFullGeometry=clientQueryResult.hasFullGeometry)}isClientQuerySuccess||(featureSet=yield this.jsAPILayerQueryFeatures(query,layer));const records=featureSet.features.map((f=>new FeatureDataRecordImpl(f,this,{hasFullGeometry}))),fields=Object.keys(this.getSchema().fields).filter((jimuFieldName=>featureSet.fields&&featureSet.fields.find((field=>field.name===this.getSchema().fields[jimuFieldName].name))));return{queryParams,records,fields,exceededTransferLimit:featureSet.exceededTransferLimit}}}))}getLayerViewForClientSideQuery(useLayer){var _a,_b;if(!(null===(_a=this.getRootDataSource())||void 0===_a?void 0:_a.map)||useLayer!==this.layer)return null;const JimuArcgis=jimu_core.SRz.getModuleSync("jimu-arcgis"),mapViewManager=null===(_b=null==JimuArcgis?void 0:JimuArcgis.MapViewManager)||void 0===_b?void 0:_b.getInstance();return null==mapViewManager?void 0:mapViewManager.getJimuLayerViewForClientQuery(this.getMainDataSource())}_q(queryParams,url){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){const queryString=Object.keys(queryParams||{}).reduce(((previous,current)=>"object"!=typeof queryParams[current]?`${previous}&${current}=${queryParams[current]}`:`${previous}&${current}=${JSON.stringify(queryParams[current])}`),""),usePost=`${url}?${queryString}`.length>1500,options=Object.assign({url,httpMethod:usePost?"POST":"GET"},queryParams);return options.timeReferenceUnknownClient&&(options.params={where:options.where||"1=1",outFields:options.outFields||"*",timeReferenceUnknownClient:!0}),jimu_core.Le1.requestWrapper(url,(session=>abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){return options.authentication=session,jimu_core._2M.restFeatureService.queryFeatures(options)}))),1)}))}getTimezone(){var _a,_b,_c;if(jimu_core.ZkX.areDatesInUnknownTimezone(this))return"unknown";{const timezoneInAppConfig=null===(_a=(0,jimu_core.Vp3)().getState().appConfig.attributes)||void 0===_a?void 0:_a.timezone;if(!timezoneInAppConfig||timezoneInAppConfig.type===jimu_core.gvO.Device)return"device";if(timezoneInAppConfig.type===jimu_core.gvO.Specific)return timezoneInAppConfig.value;if(timezoneInAppConfig.type===jimu_core.gvO.Data){if(!!!(null===(_b=this.getRootDataSource())||void 0===_b?void 0:_b.map))return this.getLayerTimezone();{const rootDsTimezone=null===(_c=this.getRootDataSource().map.resourceInfo)||void 0===_c?void 0:_c.timeZone;if(!rootDsTimezone||"system"===rootDsTimezone)return"device";if("unknown"===rootDsTimezone)return this.getLayerTimezone();if("string"==typeof rootDsTimezone)return rootDsTimezone}}}return null}getLayerTimezone(){var _a,_b;return(null===(_b=null===(_a=this.getLayerDefinition())||void 0===_a?void 0:_a.dateFieldsTimeReference)||void 0===_b?void 0:_b.timeZone)||null}allowToExportData(){var _a,_b;if(this.isDataView||this.isLocal)return this.getMainDataSource().allowToExportData();if(this.getDataSourceJson().isOutputFromWidget&&1===(null===(_a=this.getDataSourceJson().originDataSources)||void 0===_a?void 0:_a.length)){const originDsId=null===(_b=this.getDataSourceJson().originDataSources[0])||void 0===_b?void 0:_b.dataSourceId,originDs=originDsId&&this.dataSourceManager.getDataSource(originDsId);return originDs?originDs.allowToExportData():(console.error("Origin data source is not created, allow to export data by default. Output data source id is ",this.id),Promise.resolve(!0))}return!this.getDataSourceJson().disableExport?this.allowToExportDataInRemote():Promise.resolve(!1)}allowToExportDataInRemote(){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){return this.allowExportRemoteCheckPromise||(this.allowExportRemoteCheckPromise=jimu_core.ovz.isDataSourceSubscriberOrPremium(this.getDataSourceJson()).then((isSubscriberOrPremium=>!isSubscriberOrPremium&&(!jimu_core.ZkX.isAGOLHostedService(this.getDataSourceJson().url)||this.allowToExportDataInItem())))),this.allowExportRemoteCheckPromise}))}allowToExportDataInItem(){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){try{if(!this.itemId)return!0;const user=(0,jimu_core.Vp3)().getState().user;if(!user)return this.getWhetherAllowToExportInItemSetting();let itemInfo=this.getItemInfo();itemInfo=(null==itemInfo?void 0:itemInfo.contentOrigin)?itemInfo:yield jimu_core.Le1.requestWrapper((0,jimu_core.Vp3)().getState().portalUrl,(session=>jimu_core._2M.restPortal.getItem(this.itemId,{portal:jimu_core.zJ_.getPortalRestUrl((0,jimu_core.Vp3)().getState().portalUrl),authentication:session}))).catch((err=>(console.warn("Failed to get item info via app portal url. ",err),itemInfo)));if("self"===(null==itemInfo?void 0:itemInfo.contentOrigin)){if("org_admin"===user.role)return!0;return!!(user&&(null==itemInfo?void 0:itemInfo.owner)===user.username)||this.getWhetherAllowToExportInItemSetting()}return this.getWhetherAllowToExportInItemSetting()}catch(error){return console.log(`Failed to get whether data source ${this.id} allows to export data, `,error),!0}}))}getWhetherAllowToExportInItemSetting(){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){var _a;if(this.url){const layerDef=yield jimu_core.Le1.requestWrapper(this.url,(session=>abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){return yield jimu_core._2M.restRequest.request(this.url,{authentication:session,httpMethod:"GET"})}))),1);return!!(null===(_a=null==layerDef?void 0:layerDef.capabilities)||void 0===_a?void 0:_a.includes("Extract"))}return!0}))}supportSymbol(){return jimu_core.ZkX.supportSymbol(this)}supportAttachment(){return jimu_core.ZkX.supportAttachment(this)}supportTime(){return jimu_core.ZkX.supportTime(this)}getTimeInfo(){var _a,_b,_c;if(this.layer){const timeInfo=this.layer.timeInfo;return(null===(_a=this.getLayerDefinition())||void 0===_a?void 0:_a.timeInfo)&&timeInfo?jimu_core.CM0.merge(this.getLayerDefinition().timeInfo,timeInfo.toJSON()):(null==timeInfo?void 0:timeInfo.toJSON())||(null===(_b=this.getLayerDefinition())||void 0===_b?void 0:_b.timeInfo)}return null===(_c=this.getLayerDefinition())||void 0===_c?void 0:_c.timeInfo}setSourceFeatures(features,others){return abstract_arcgis_queriable_data_source_awaiter(this,void 0,void 0,(function*(){let graphics;if(null==features?void 0:features.some((f=>"esri.Graphic"!==(null==f?void 0:f.declaredClass)))){const Graphic=yield(0,jimu_core.p8A)("esri/Graphic");graphics=features.map((f=>"esri.Graphic"===(null==f?void 0:f.declaredClass)?f:new Graphic(f)))}else graphics=features;const createLayerRes=yield jimu_core.ZkX.createJSAPIFeatureLayerByRecords(this,null==graphics?void 0:graphics.map((g=>this.buildRecord(g))),null,others);this._layer=createLayerRes.layer,this.clearRecordsNotAddVersion(),this.addSourceVersion()}))}getDataViews(){return super.getDataViews()}getDataView(dataViewId){return super.getDataView(dataViewId)}getMainDataSource(){return super.getMainDataSource()}get layer(){return jimu_core.ZkX.getJSAPILayer(this)}set layer(l){this._layer=l}_printUseAllFieldsWarning(outFields){(null==outFields?void 0:outFields.includes("*"))&&jimu_core.CM0.defer((()=>{console.debug(`Using * as out fields to do query. Data source id is: ${this.id}`)}))}}var feature_layer_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};const{queryRelated}=jimu_core._2M.restFeatureService;class FeatureLayerDataSourceImpl extends AbstractArcGISQueriableDataSource{constructor(){super(...arguments),this.type=jimu_core.hg5.FeatureLayer}get isAssociatedFeatureLayer(){return!!this.getAssociatedDataSource()}get isSqlCaseSensitive(){return this.getAssociatedDataSource()?this.getAssociatedDataSource().isSqlCaseSensitive:this._isSqlCaseSensitive}set isSqlCaseSensitive(isCaseSensitive){this._isSqlCaseSensitive=isCaseSensitive}ready(){const _super=Object.create(null,{ready:{get:()=>super.ready}});return feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){return _super.ready.call(this).then((()=>this.replaceSubLayerWithFeatureLayer()))}))}jsAPILayerQueryObjectIds(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryObjectIds(query)}jsAPILayerQueryFeatures(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryFeatures(query)}jsAPILayerQueryExtent(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryExtent(query)}jsAPILayerQueryFeatureCount(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryFeatureCount(query)}get layer(){return jimu_core.ZkX.getJSAPILayer(this)}set layer(l){this._layer=l}get restLayer(){return jimu_core.ZkX.getRestAPILayer(this)}set restLayer(l){this._restLayer=l}setAssociatedDataSource(associatedDataSource){this.associatedDataSource=associatedDataSource}getAssociatedDataSource(){return this.associatedDataSource}isInAppConfig(){var _a;return this.isAssociatedFeatureLayer?null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.isInAppConfig():super.isInAppConfig()}createRestAPILayerByDataSource(){return jimu_core.ZkX.createRestAPILayerByDataSource(this)}getCharts(){var _a,_b;const mainDs=this.getMainDataSource();if(null==mainDs?void 0:mainDs.layer)return mainDs.layer.charts;if(null==mainDs?void 0:mainDs.getItemData()){const layerInfo=null===(_b=null===(_a=mainDs.getItemData())||void 0===_a?void 0:_a.layers)||void 0===_b?void 0:_b.find((l=>`${l.id}`===this.layerId));return null==layerInfo?void 0:layerInfo.charts}return[]}fetchSchema(){const _super=Object.create(null,{fetchSchema:{get:()=>super.fetchSchema}});return feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){var _a,_b;return this.getAssociatedDataSource()||this.getDataSourceJson().isOutputFromWidget||"multipatch"!==(null===(_a=this.layer)||void 0===_a?void 0:_a.geometryType)&&"mesh"!==(null===(_b=this.layer)||void 0===_b?void 0:_b.geometryType)?_super.fetchSchema.call(this):null}))}fetchSchemaWithLayer(){const _super=Object.create(null,{fetchSchemaWithLayer:{get:()=>super.fetchSchemaWithLayer}});return feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){var _a,_b;let schema=yield _super.fetchSchemaWithLayer.call(this);return schema.filter&&(null===(_a=this.layer.customParameters)||void 0===_a?void 0:_a.where)?schema=schema.set("filter",`(${schema.filter}) and (${this.layer.customParameters.where})`):(null===(_b=this.layer.customParameters)||void 0===_b?void 0:_b.where)&&(schema=schema.set("filter",`${this.layer.customParameters.where}`)),schema}))}createRelatedDataSources(){return feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){var _a,_b;if(this.relatedDataSources)return this.relatedDataSources;try{const rootDs=this.getRootDataSource(),featureServiceUrl=jimu_core.ZkX.getFullArcGISServiceUrl(this.url,!1);if(!rootDs||!featureServiceUrl)return[];const relationships=(null===(_a=this.getLayerDefinition())||void 0===_a?void 0:_a.relationships)||[];let jsApiLayers=[];if(rootDs.map){const rootMapDs=rootDs,layers=rootMapDs.map.allLayers.toArray(),tables=rootMapDs.map.allTables.toArray(),allLayers=layers.concat(tables);for(const layer of allLayers)if("feature"===layer.type)jsApiLayers.push(layer);else if("map-image"===layer.type){const mapImageLayer=layer;jsApiLayers=jsApiLayers.concat(mapImageLayer.allSublayers.toArray())}}const relatedDsPromises=[];for(const r of relationships){let parentOrRootDs=this.parentDataSource,childDsId=null===(_b=null==parentOrRootDs?void 0:parentOrRootDs.getChildDataSourceId)||void 0===_b?void 0:_b.call(parentOrRootDs,r.relatedTableId.toString());const jsApiLayer=jsApiLayers.find((l=>[l.layerId,l.id].includes(r.relatedTableId)&&jimu_core.ZkX.getFullArcGISServiceUrl(l.url,!1)===featureServiceUrl));jsApiLayer&&(parentOrRootDs=rootDs,childDsId=jimu_core.ZkX.getDataSourceIdByJSAPILayer(rootDs,jsApiLayer)),childDsId&&relatedDsPromises.push(parentOrRootDs.createDataSourceById(childDsId))}const relatedDss=(yield Promise.allSettled(relatedDsPromises)).filter((result=>"fulfilled"===result.status)).map((result=>result.value));this.relatedDataSources=relatedDss}catch(e){console.error(e)}return this.relatedDataSources}))}getRelatedDataSources(){return this.relatedDataSources}queryRelatedRecords(relatedDs_1,ids_1){return feature_layer_data_source_impl_awaiter(this,arguments,void 0,(function*(relatedDs,ids,params={},ignoreFilter=!1){var _a,_b;if(!Array.isArray(ids)||0===ids.length)return[];const relationshipId=null===(_b=((null===(_a=this.getLayerDefinition())||void 0===_a?void 0:_a.relationships)||[]).find((r=>{var _a;return r.relatedTableId===(null===(_a=null==relatedDs?void 0:relatedDs.getLayerDefinition())||void 0===_a?void 0:_a.id)})))||void 0===_b?void 0:_b.id;if(void 0===relationshipId)return[];const objectIds=ids.map((id=>parseInt(id))).filter((id=>!isNaN(id))),queryParams=relatedDs.getRealQueryParams(params,"query"),{where,outFields,returnGeometry}=queryParams,maxRecordCount=relatedDs.getLayerDefinition().maxRecordCount;let exceededTransferLimit,relatedFeatureGroups=[],resultOffset=0;do{const queryRelatedResponse=yield jimu_core.Le1.requestWrapper(this.url,(session=>feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){return yield queryRelated({url:this.url,httpMethod:"POST",relationshipId,objectIds,params:{definitionExpression:ignoreFilter||!where?"1=1":where,outFields,returnGeometry,resultOffset},authentication:session})}))),1);relatedFeatureGroups=relatedFeatureGroups.concat((null==queryRelatedResponse?void 0:queryRelatedResponse.relatedRecordGroups)||[]),exceededTransferLimit=null==queryRelatedResponse?void 0:queryRelatedResponse.exceededTransferLimit,exceededTransferLimit&&(resultOffset+=maxRecordCount)}while(exceededTransferLimit);return relatedFeatureGroups.map((r=>({objectId:r.objectId,relatedRecords:r.relatedRecords.map((feature=>relatedDs.buildRecord(feature))),count:r.count})))}))}queryRelatedFieldValues(records,relatedDs,relatedFieldName){return feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){const objectIds=null==records?void 0:records.map((r=>r.getId())),relatedFieldValues=((yield this.queryRelatedRecords(relatedDs,objectIds,{outFields:[relatedFieldName]},!0))||[]).reduce(((prev,cur)=>prev.concat(cur.relatedRecords.map((r=>r.getFieldValue(relatedFieldName))))),[]);return Array.from(new Set(relatedFieldValues))}))}changeSelectionInUrl(options){const mainDs=this.getMainDataSource();jimu_core.V08.getInstance().changeHashObjectByDataSourceSelection(this.isAssociatedFeatureLayer?this.getAssociatedDataSource().getMainDataSource().id:mainDs.id,options)}doAddRecordToServerSideSource(record){return this.layer?this.addRecordByLayer(record,this.layer):this.url?this.addRecordByUrl(record,this.url):this.createJSAPILayerByFeatureCollectionItemId().then((layer=>this.addRecordByLayer(record,layer)))}doDeleteOneRecordFromServerSideSource(record){return this.layer?this.deleteOneRecordByLayer(record,this.layer):this.url?this.deleteOneRecordByUrl(record,this.url):this.createJSAPILayerByFeatureCollectionItemId().then((layer=>this.deleteOneRecordByLayer(record,layer)))}doUpdateRecordsInServerSideSource(records){return this.layer?this.updateRecordsByLayer(records,this.layer):this.url?this.updateRecordsByUrl(records,this.url):this.createJSAPILayerByFeatureCollectionItemId().then((layer=>this.updateRecordsByLayer(records,layer)))}addRecordByLayer(record,layer){return feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){const f=(yield jimu_core.ZkX.changeToJSAPIGraphic(record.feature)).clone();return layer.applyEdits({addFeatures:[f]}).then((response=>{var _a,_b;const objectId=null===(_a=response.addFeatureResults[0])||void 0===_a?void 0:_a.objectId;if("number"!=typeof objectId||(null===(_b=response.addFeatureResults[0])||void 0===_b?void 0:_b.error))return Promise.reject("Adding record failed.");const idField=this.getIdField();return f.attributes[idField]=objectId,new FeatureDataRecordImpl(f,this)}))}))}addRecordByUrl(record,url){return feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){const feature=jimu_core.ZkX.changeToRestAPIFeature(record.feature),f=Object.assign({},feature),options={url,features:[f]};return yield jimu_core.Le1.requestWrapper(url,(session=>feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){return options.authentication=session,yield jimu_core._2M.restFeatureService.addFeatures(options).then((response=>{var _a,_b;const objectId=null===(_a=response.addResults[0])||void 0===_a?void 0:_a.objectId;if("number"!=typeof objectId||!(null===(_b=response.addResults[0])||void 0===_b?void 0:_b.success))return Promise.reject("Adding record failed.");const idField=this.getIdField();return f.attributes[idField]=objectId,new FeatureDataRecordImpl(f,this)}))}))),1)}))}updateRecordsByLayer(records,layer){return feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){const features=yield Promise.all(records.map((r=>feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){return yield jimu_core.ZkX.changeToJSAPIGraphic(r.feature).then((g=>g.clone()))})))));return layer.applyEdits({updateFeatures:features}).then((response=>response.updateFeatureResults.filter((r=>!r.error)).length>0))}))}updateRecordsByUrl(records,url){return feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){const features=records.map((r=>Object.assign({},jimu_core.ZkX.changeToRestAPIFeature(r.feature)))),options={url,features};return yield jimu_core.Le1.requestWrapper(url,(session=>feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){return options.authentication=session,yield jimu_core._2M.restFeatureService.updateFeatures(options).then((response=>response.updateResults.filter((r=>r.success)).length>0))}))),1)}))}deleteOneRecordByLayer(record,layer){return feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){const f=(yield jimu_core.ZkX.changeToJSAPIGraphic(record.feature)).clone();return layer.applyEdits({deleteFeatures:[f]}).then((response=>response.deleteFeatureResults.filter((r=>!r.error)).length>0))}))}deleteOneRecordByUrl(record,url){return feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){const f=Object.assign({},jimu_core.ZkX.changeToRestAPIFeature(record.feature)),idField=this.getIdField(),objectId=f.attributes[idField],options={url,objectIds:[objectId]};return yield jimu_core.Le1.requestWrapper(url,(session=>feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){return options.authentication=session,yield jimu_core._2M.restFeatureService.deleteFeatures(options).then((response=>response.deleteResults.filter((r=>r.success)).length>0))}))),1)}))}afterUpdateRecords(records){this.checkAndClearCacheNotAddVersion(),super.afterUpdateRecords(records)}afterUpdateRecord(record){this.checkAndClearCacheNotAddVersion(),super.afterUpdateRecord(record)}afterAddRecord(record){this.getMainDataSource().clearRecords(),this.getMainDataSource().getAllDerivedDataSources().forEach((ds=>{ds.clearRecords()})),this.getMainDataSource().addSourceVersion()}afterDeleteRecordsByIds(ids){this.checkAndClearCacheNotAddVersion(),super.afterDeleteRecordsByIds(ids)}afterDeleteRecordById(id){this.checkAndClearCacheNotAddVersion(),super.afterDeleteRecordById(id)}checkAndClearCacheNotAddVersion(){this.getMainDataSource().getAllDerivedDataSources().concat(this.getMainDataSource()).forEach((ds=>{jimu_core.ZkX.areQueryParamsEmpty((0,jimu_core.J3Z)(ds.lastQueryParams))||ds.clearRecordsNotAddVersion(),jimu_core.ZkX.areQueryParamsEmpty((0,jimu_core.J3Z)(ds.lastCountQueryParams))||ds.clearCountNotAddVersion(),ds.lastQueryId&&ds.clearQueryByIdNotAddVersion()}))}replaceSubLayerWithFeatureLayer(){return feature_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){var _a;if("esri.layers.support.Sublayer"===(null===(_a=this.layer)||void 0===_a?void 0:_a.declaredClass)&&this.layer.url){const FeatureLayer=yield(0,jimu_core.p8A)("esri/layers/FeatureLayer"),definitionExpression=this.layer.definitionExpression||null;this.layer=new FeatureLayer({id:this.layer.id,title:this.layer.title,url:jimu_core.ZkX.getUrlByLayer(this.layer),renderer:this.layer.renderer,popupTemplate:this.layer.popupTemplate,sourceJSON:this.layer.sourceJSON,parent:this.layer.parent,definitionExpression}),this.getAllDerivedDataSources().forEach((ds=>{ds.clearRecords(),ds.layer=this.layer})),yield this.layer.load()}return Promise.resolve(this)}))}}var set_data_source_mixin_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};const set_data_source_mixin_SetDataSourceMixinImpl=Base=>class SetDataSourceMixinImpl extends Base{constructor(){super(...arguments),this.childDataSourcesCreated=!1,this.childDataSourcePromises={}}childDataSourcesReady(){return this.createChildDataSourcesRecursively().finally((()=>{this.setChildDataSourcesCreated(!0)}))}updateAreChildDataSourcesCreated(){var _a;if(!this.getChildDataSourceIds().some((cId=>{var _a,_b;const c=this.dataSourceManager.getDataSource(cId);return(null==c?void 0:c.isDataSourceSet())?!c.areChildDataSourcesCreated():![jimu_core.e3_.Created,jimu_core.e3_.CreateError].includes(null===(_b=null===(_a=(0,jimu_core.Vp3)().getState().dataSourcesInfo)||void 0===_a?void 0:_a[cId])||void 0===_b?void 0:_b.instanceStatus)}))){const prevChildDataSourcesCreated=this.areChildDataSourcesCreated();this.setChildDataSourcesCreated(!0);const thisAsDs=this;null===(_a=thisAsDs.parentDataSource)||void 0===_a||_a.updateAreChildDataSourcesCreated(),thisAsDs.parentDataSource||prevChildDataSourcesCreated||thisAsDs.fetchSchema().then((fetchedSchema=>{this.dataSourceManager.initSchema(thisAsDs,fetchedSchema)}))}}areChildDataSourcesCreated(){return this.childDataSourcesCreated}setChildDataSourcesCreated(created){!this.childDataSourcesCreated&&created&&this.dataSourceManager.traversedDataSourceIdsByTime.add(this.id),this.childDataSourcesCreated=created}createChildDataSourcesRecursively(){return this.createChildDataSources().then((childDss=>Promise.allSettled(childDss.map((childDs=>childDs.isDataSourceSet()?childDs.childDataSourcesReady().then((()=>childDs)):childDs))).then((childDssRes=>childDssRes.filter((c=>"fulfilled"===c.status)).map((c=>c.value))))))}createChildDataSources(){return set_data_source_mixin_awaiter(this,void 0,void 0,(function*(){return this.getChildDataSourceIds().forEach((childDsId=>{this.childDataSourcePromises[childDsId]||(this.childDataSourcePromises[childDsId]=this.createDataSourceById(childDsId))})),Promise.allSettled(Object.values(this.childDataSourcePromises)).then((childDssRes=>childDssRes.filter((c=>"fulfilled"===c.status)).map((c=>c.value))))}))}createDataSourceById(dataSourceId){return set_data_source_mixin_awaiter(this,void 0,void 0,(function*(){const neededChildDsId=this.findChildDataSourceIdByDescendantDataSourceId(dataSourceId);try{if(!neededChildDsId)return Promise.reject(new jimu_core.yR5(dataSourceId,"Can not find data source."));if(!this.childDataSourcePromises[neededChildDsId]){const childId=this.getChildIds().find((cId=>this.getJimuChildId(cId).some((jimuCId=>this.getChildDataSourceId(jimuCId)===neededChildDsId)))),jimuChildId=this.getJimuChildId(childId).find((jimuCId=>this.getChildDataSourceId(jimuCId)===neededChildDsId));this.childDataSourcePromises[neededChildDsId]=this.createChildDataSourceById(neededChildDsId,jimuChildId,childId)}const childDs=yield this.childDataSourcePromises[neededChildDsId];return childDs.id===dataSourceId?childDs:childDs.isDataSourceSet()?childDs.createDataSourceById(dataSourceId):Promise.reject(new jimu_core.yR5(dataSourceId,"Can not find data source."))}finally{this.updateAreChildDataSourcesCreated()}}))}findChildDataSourceIdByDescendantDataSourceId(dataSourceId){const childDsIds=this.getChildDataSourceIds(),descendantDsIdArr=null==dataSourceId?void 0:dataSourceId.split("-");return childDsIds.find((childDsId=>{const childDsIdArr=null==childDsId?void 0:childDsId.split("-");return null==childDsIdArr?void 0:childDsIdArr.every(((d,i)=>descendantDsIdArr[i]===d))}),null)}getChildDataSourceIds(){return(this.getChildIds()||[]).reduce(((jimuChildIds,childId)=>jimuChildIds.concat(this.getJimuChildId(childId))),[]).map((jimuChildId=>this.getChildDataSourceId(jimuChildId)))}destroy(){Object.keys(this.childDataSourcePromises).forEach((childDsId=>{this.dataSourceManager.destroyDataSource(childDsId)}))}areSomeChildDataSourcesPending(){const checkPromises=Object.keys(this.childDataSourcePromises).map((childDsId=>(p=>{const o={};return Promise.race([p,o]).then((v=>v===o),(err=>!1))})(this.childDataSourcePromises[childDsId])));return Promise.all(checkPromises).then((res=>res.some((r=>r))))}getChildDataSourceId(jimuChildId){return jimu_core.ZkX.getChildDataSourceId(this.id,jimuChildId)}getChildDataSources(){return Object.keys(this.dataSourceManager.getDataSources()).filter((dsId=>this.dataSourceManager.getDataSource(dsId).parentDataSource===this)).map((dsId=>this.dataSourceManager.getDataSource(dsId))).sort(((ds1,ds2)=>ds1.order-ds2.order))}getAllChildDataSources(){const visitTree=(ds,results)=>{const childDss=ds.isDataSourceSet()&&ds.getChildDataSources();childDss&&childDss.forEach((childDs=>{results.push(childDs),childDs.isDataSourceSet()&&visitTree(childDs,results)}))},allDss=[];return visitTree(this,allDss),allDss}getChildDataSource(jimuChildId){return this.dataSourceManager.getDataSource(this.getChildDataSourceId(jimuChildId))}getJimuChildId(childId){const rschema=this.getReversedConfigSchema();return rschema&&rschema.childSchemas&&rschema.childSchemas[childId]?rschema.childSchemas[childId].map((schema=>schema.jimuChildId)).asMutable():[childId]}clearChildDataSourcePromise(childDsId){delete this.childDataSourcePromises[childDsId]}};var abstract_layer_folder_data_source_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};const dataSourceJsonCreator=jimu_core.ZkX.dataSourceJsonCreator;class abstract_layer_folder_data_source_AbstractLayerFolderDataSource extends(js_api_layer_mixin_JSAPILayerMixinImpl(item_mixin_ItemMixinImpl(set_data_source_mixin_SetDataSourceMixinImpl(abstract_data_source_AbstractDataSource)))){constructor(options){var _a;super(options),options.layer&&(this.layer=options.layer);const dsJson=this.getDataSourceJson();this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId,this.layerId=dsJson.layerId,(null===(_a=this.layer)||void 0===_a?void 0:_a.portalItem)&&this.setItemInfo(this.layer.portalItem.sourceJSON)}ready(){const _super=Object.create(null,{ready:{get:()=>super.ready},createChildDataSourcesRecursively:{get:()=>super.createChildDataSourcesRecursively}});return this.fetchDataDefinitions().then((()=>_super.ready.call(this))).then((()=>abstract_layer_folder_data_source_awaiter(this,void 0,void 0,(function*(){const appConfig=(0,jimu_core.Vp3)().getState().appConfig;if(appConfig.originExbVersion&&jimu_core.hOv.lt(appConfig.originExbVersion,"1.6.0")){const childDss=yield _super.createChildDataSourcesRecursively.call(this);yield this.upgradeChildDssId(childDss)}}))))}upgradeChildDssId(childDss){return abstract_layer_folder_data_source_awaiter(this,void 0,void 0,(function*(){let appConfig=(0,jimu_core.Vp3)().getState().appConfig;const selectionViewReadyPromises=[],updatedWidgets=[],updateUseDataSource=(u,id,newId)=>((null==u?void 0:u.dataSourceId)&&(u.dataSourceId=u.dataSourceId.replace(id,newId)),(null==u?void 0:u.mainDataSourceId)&&(u.mainDataSourceId=u.mainDataSourceId.replace(id,newId)),u),needUpdateUseDs=(u,idFromLabel)=>(null==u?void 0:u.mainDataSourceId)?u.mainDataSourceId===idFromLabel:!!(null==u?void 0:u.dataSourceId)&&u.dataSourceId.split("-dataView_")[0]===idFromLabel;if(childDss.forEach((childDs=>{var _a,_b,_c,_d,_e,_f,_g;if(childDs){let idFromLabel="",ds=childDs;const idFromLabelToIdFromId=[];for(;ds;){const isRootDs=!ds.parentDataSource,isSingleLayerDs=!ds.isDataSourceSet()&&!ds.getDataSourceJson().url||jimu_core.ZkX.isSupportedSingleArcGISLayerService(ds.getDataSourceJson().url),isChildDsOfMap=!!(null===(_a=ds.parentDataSource)||void 0===_a?void 0:_a.map);let jimuChildIdFromLabel;if(isRootDs)jimuChildIdFromLabel=ds.id;else if(isSingleLayerDs&&!isChildDsOfMap){const layerDefinition=ds.getLayerDefinition?ds.getLayerDefinition():null===(_c=(_b=ds).getServiceDefinition)||void 0===_c?void 0:_c.call(_b);jimuChildIdFromLabel=jimu_core.ZkX._getFixedLayerIdByLayerDefinition(layerDefinition)||ds.jimuChildId}else jimuChildIdFromLabel=isSingleLayerDs||isChildDsOfMap?ds.jimuChildId:jimu_core.ZkX.getLabelFromArcGISServiceUrl(ds.getDataSourceJson().url);if(!isRootDs&&!isChildDsOfMap&&ds.getDataSourceJson().url&&(null===(_g=null===(_f=null===(_e=null===(_d=ds.parentDataSource.layer)||void 0===_d?void 0:_d.layers)||void 0===_e?void 0:_e.toArray)||void 0===_f?void 0:_f.call(_e))||void 0===_g?void 0:_g.filter((l=>jimu_core.ZkX.getUrlByLayer(l)===ds.getDataSourceJson().url)).length)>1){const repeatTimes=ds.parentDataSource.layer.layers.toArray().filter((l=>jimu_core.ZkX.getUrlByLayer(l)===ds.getDataSourceJson().url)).findIndex((l=>l.id===ds.jimuChildId));repeatTimes>0&&(jimuChildIdFromLabel=`${jimuChildIdFromLabel}_${repeatTimes}`)}idFromLabel=idFromLabel?`${jimuChildIdFromLabel}-${idFromLabel}`:jimuChildIdFromLabel,idFromLabelToIdFromId.unshift({jimuChildIdFromLabel,jimuChildIdFromId:ds.jimuChildId||ds.id}),ds=ds.parentDataSource}Object.keys(appConfig.widgets||{}).forEach((widgetId=>{var _a;if(null===(_a=appConfig.widgets[widgetId].useDataSources)||void 0===_a?void 0:_a.some((u=>needUpdateUseDs(u,idFromLabel)))){const widgetJson=appConfig.widgets[widgetId].asMutable({deep:!0});widgetJson.useDataSources=widgetJson.useDataSources.map((u=>updateUseDataSource(u,idFromLabel,childDs.id))),widgetJson.config&&(widgetJson.config=JSON.parse(JSON.stringify(widgetJson.config).replace(new RegExp(idFromLabel,"g"),childDs.id))),appConfig=appConfig.setIn(["widgets",widgetId],widgetJson),updatedWidgets.push(widgetJson)}})),Object.keys(appConfig.dataSources||{}).forEach((dsId=>{var _a;if(null===(_a=appConfig.dataSources[dsId].originDataSources)||void 0===_a?void 0:_a.some((u=>needUpdateUseDs(u,idFromLabel)))){const dsJson=appConfig.dataSources[dsId].asMutable({deep:!0});dsJson.originDataSources=dsJson.originDataSources.map((u=>updateUseDataSource(u,idFromLabel,childDs.id))),appConfig=appConfig.setIn(["dataSources",dsId],dsJson)}const pathToChildDsJson=[];if(idFromLabelToIdFromId.forEach(((id,index)=>{pathToChildDsJson.push(id.jimuChildIdFromLabel),index!==idFromLabelToIdFromId.length-1&&pathToChildDsJson.push("childDataSourceJsons")})),appConfig.dataSources.getIn(pathToChildDsJson)){const ids=idFromLabelToIdFromId.slice().reverse();if(ids[0].jimuChildIdFromId!==ids[0].jimuChildIdFromLabel){const pathToParentDsJson=pathToChildDsJson.slice(0,pathToChildDsJson.length-2),parentDsJson=appConfig.dataSources.getIn(pathToParentDsJson).asMutable({deep:!0});parentDsJson.childDataSourceJsons[ids[0].jimuChildIdFromId]=parentDsJson.childDataSourceJsons[ids[0].jimuChildIdFromLabel],parentDsJson.childDataSourceJsons[ids[0].jimuChildIdFromId].id=childDs.id,delete parentDsJson.childDataSourceJsons[ids[0].jimuChildIdFromLabel],appConfig=appConfig.setIn(["dataSources"].concat(pathToParentDsJson),parentDsJson)}}})),Object.keys(appConfig.messageConfigs||{}).forEach((messageId=>{var _a;const hasActionUseDsWhichIdIsFromLabel=null===(_a=appConfig.messageConfigs[messageId].actions)||void 0===_a?void 0:_a.some((a=>{var _a,_b,_c,_d,_e;return(null===(_a=a.useDataSources)||void 0===_a?void 0:_a.some((u=>(null==u?void 0:u.mainDataSourceId)===idFromLabel)))||(null===(_c=null===(_b=a.config)||void 0===_b?void 0:_b.actionUseDataSource)||void 0===_c?void 0:_c.mainDataSourceId)===idFromLabel||(null===(_e=null===(_d=a.config)||void 0===_d?void 0:_d.messageUseDataSource)||void 0===_e?void 0:_e.mainDataSourceId)===idFromLabel}));if(hasActionUseDsWhichIdIsFromLabel){const messageJson=appConfig.messageConfigs[messageId].asMutable({deep:!0});messageJson.actions=messageJson.actions.map((a=>{var _a,_b;return a.useDataSources&&(a.useDataSources=a.useDataSources.map((u=>updateUseDataSource(u,idFromLabel,childDs.id)))),(null===(_a=a.config)||void 0===_a?void 0:_a.actionUseDataSource)&&(a.config.actionUseDataSource=updateUseDataSource(a.config.actionUseDataSource,idFromLabel,childDs.id)),(null===(_b=a.config)||void 0===_b?void 0:_b.messageUseDataSource)&&(a.config.messageUseDataSource=updateUseDataSource(a.config.messageUseDataSource,idFromLabel,childDs.id)),a})),appConfig=appConfig.setIn(["messageConfigs",messageId],messageJson)}})),!childDs.isDataSourceSet()&&Object.keys((0,jimu_core.Vp3)().getState().dataSourcesInfo).some((dsId=>dsId.includes(idFromLabel)))&&(Object.keys((0,jimu_core.Vp3)().getState().dataSourcesInfo).forEach((dsId=>{if(dsId.includes(idFromLabel)){const prevDsId=dsId,newDsId=dsId.replace(idFromLabel,childDs.id);(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.updateDataSourceInfo(childDs.id,(0,jimu_core.Vp3)().getState().dataSourcesInfo[prevDsId].merge((0,jimu_core.Vp3)().getState().dataSourcesInfo[newDsId]||{})))}})),childDs.getDataView(jimu_core.aH5.W7)&&selectionViewReadyPromises.push(childDs.getDataView(jimu_core.aH5.W7).ready()))}})),(0,jimu_core.Vp3)().getState().appConfig!==appConfig){const widgetManager=jimu_core.SS0.getInstance(),loadedAndUpdatedWidgets=updatedWidgets.filter((w=>{var _a,_b;return!!(null===(_b=null===(_a=widgetManager.widgets)||void 0===_a?void 0:_a[w.uri])||void 0===_b?void 0:_b.clazzPromise)}));if(loadedAndUpdatedWidgets.some((w=>w.version!==w.manifest.version)))return void jimu_core.WpD.tryGet((()=>{const newWidgets=(0,jimu_core.Vp3)().getState().appConfig.widgets||{},areWidgetsUpdated=!loadedAndUpdatedWidgets.some((w=>newWidgets[w.id]&&newWidgets[w.id].version!==newWidgets[w.id].manifest.version));return areWidgetsUpdated&&this.upgradeChildDssId(childDss),areWidgetsUpdated}),1e4,200);jimu_core.WpD.changeAppConfig(appConfig);const rootDs=this.getRootDataSource()||this,rootDsJson=appConfig.dataSources[rootDs.id];rootDsJson&&jimu_core.CM0.defer((()=>{this.dataSourceManager.updateDataSourceByDataSourceJson(rootDs,rootDsJson)}))}return Promise.allSettled(selectionViewReadyPromises).then()}))}fetchDataDefinitions(){return abstract_layer_folder_data_source_awaiter(this,void 0,void 0,(function*(){const sourceDataPromises=[this.fetchServiceDefinition().then((()=>{var _a,_b;(null===(_b=null===(_a=this.serviceDefinition)||void 0===_a?void 0:_a.tables)||void 0===_b?void 0:_b.length)>0&&(this.serviceDefinition.tables=this.serviceDefinition.tables.map((t=>Object.assign(Object.assign({},t),{type:jimu_core.OhU.Table}))))}))];this.layer||this.url||!this.itemId||sourceDataPromises.push(this.fetchItemData(),this.fetchItemInfo()),yield Promise.all(sourceDataPromises)}))}fetchServiceDefinition(){return abstract_layer_folder_data_source_awaiter(this,void 0,void 0,(function*(){var _a;let serviceDefinition;if(this.layer?(yield this.layer.load(),this.updateServiceDefinitionByLayer(),serviceDefinition=this.getServiceDefinition()):this.url&&(serviceDefinition=yield this.fetchServiceDefinitionByUrl()),null===(_a=null==serviceDefinition?void 0:serviceDefinition.layers)||void 0===_a?void 0:_a.some((l=>!l.type))){const layerUrls=serviceDefinition.layers.filter((l=>!l.type)).map((l=>jimu_core.ZkX.getFullArcGISServiceUrl(this.url,!0,l))),fullLayerDefs=yield jimu_core.ljd.getInstance().fetchChildLayerDefinitionsFromUrls(layerUrls),fullLayerDefsArr=Object.values(fullLayerDefs);serviceDefinition.layers.forEach(((l,i)=>{serviceDefinition.layers[i]=Object.assign(Object.assign({},serviceDefinition.layers[i]),fullLayerDefsArr.find((l=>l.id===serviceDefinition.layers[i].id)))}))}return serviceDefinition}))}fetchSchema(){return abstract_layer_folder_data_source_awaiter(this,void 0,void 0,(function*(){const dss=this.getChildDataSources(),label=yield jimu_core.ZkX.getOriginDataLabel(this);let schema=(0,jimu_core.J3Z)({childSchemas:{},label});return dss.forEach(((ds,i)=>{const layerSchema=ds.getFetchedSchema();schema=schema.setIn(["childSchemas",ds.jimuChildId],layerSchema)})),Promise.resolve(schema)}))}getServiceDefinition(){return this.isDataView||this.isLocal?this.getMainDataSource().getServiceDefinition():this.serviceDefinition}getItemInfo(){return this.isDataView||this.isLocal?this.getMainDataSource().getItemInfo():super.getItemInfo()}createChildDataSourceById(childDsId,jimuChildId,childId){return abstract_layer_folder_data_source_awaiter(this,void 0,void 0,(function*(){const options=this.createChildDataSourceOptionsById(childDsId,jimuChildId,childId),childDs=yield options?this.dataSourceManager.createDataSource(options):this.dataSourceManager.createDataSource(childDsId,null,null,!0);return this.updateChildDataSourcesGDBVersion([childDs]),childDs}))}createChildDataSourceOptionsByIdFromUrl(childDsId,jimuChildId,childId){if(this.url){const layerInfo=this.findLayerDefinitionInfo(childId);return(null==layerInfo?void 0:layerInfo.url)?this.createChildDataSourceOptionsByLayerDefinition(layerInfo.partialLayerDefinition,layerInfo.url,jimuChildId,childDsId,layerInfo.order):null}return null}createChildDataSourceOptionsByLayerDefinition(layerDefinition,url,jimuChildId,childDsId,order){const dsJson=this.createChildDataSourceJsonByLayerDefinition(layerDefinition,url,jimuChildId,childDsId);return dsJson?{id:childDsId,dataSourceJson:dsJson,parentDataSource:this,jimuChildId,order}:null}createChildDataSourceJsonByLayerDefinition(layerDefinition,url,jimuChildId,childDsId){var _a,_b,_c,_d,_e,_f;if(!layerDefinition||!childDsId)return null;const _jimuChildIdFromLabel=jimu_core.ZkX._getFixedLayerIdByLayerDefinition(layerDefinition)||jimu_core.ZkX.getLabelFromArcGISServiceUrl(url),schemaInConfig=(null===(_b=null===(_a=this.getDataSourceJson().schema)||void 0===_a?void 0:_a.childSchemas)||void 0===_b?void 0:_b[jimuChildId])||(null===(_d=null===(_c=this.getDataSourceJson().schema)||void 0===_c?void 0:_c.childSchemas)||void 0===_d?void 0:_d[_jimuChildIdFromLabel]),dsJsonInConfig=(null===(_e=this.getDataSourceJson().childDataSourceJsons)||void 0===_e?void 0:_e[jimuChildId])||(null===(_f=this.getDataSourceJson().childDataSourceJsons)||void 0===_f?void 0:_f[_jimuChildIdFromLabel]);let dsJson=dataSourceJsonCreator.createDataSourceJsonByLayerDefinition(childDsId,layerDefinition,url,dsJsonInConfig,schemaInConfig);return dsJson&&(this.portalUrl&&(dsJson=dsJson.set("portalUrl",this.portalUrl)),this.itemId&&(dsJson=dsJson.set("itemId",this.itemId))),dsJson}findLayerDefinitionInfo(childId){let layerInfo;return this.getPartialLayerAndTableDefinitions().concat(this.getPartialSubLayerDefinitions()).some(((layerDef,i)=>{const layerUrl=jimu_core.ZkX.getFullArcGISServiceUrl(this.url,!0,layerDef);return this.getChildIdByLayerDefinition(layerDef,layerUrl)===childId&&(layerInfo={proxyUrl:layerUrl,url:layerUrl,partialLayerDefinition:layerDef,order:i},!0)})),layerInfo}updateServiceDefinitionByLayer(){var _a,_b;(null===(_a=this.layer)||void 0===_a?void 0:_a.sourceJSON)?this.serviceDefinition=this.layer.sourceJSON:this.serviceDefinition={name:null===(_b=this.layer)||void 0===_b?void 0:_b.title}}fetchServiceDefinitionByUrl(){return abstract_layer_folder_data_source_awaiter(this,void 0,void 0,(function*(){var _a,_b,_c;if(this.getServiceDefinition())return this.getServiceDefinition();if(this.url){const definition=yield jimu_core.ljd.getInstance().fetchServiceInfo(this.url).then((res=>res.definition));if(!definition)return null;if(definition.name||(definition.name=jimu_core.ZkX.getLabelFromArcGISServiceUrl(this.getDataSourceJson().url)),null===(_a=definition.subLayers)||void 0===_a?void 0:_a.some((l=>!l.type))){const allLayerDefs=(null===(_b=this.parentDataSource)||void 0===_b?void 0:_b.getServiceDefinition)?null===(_c=this.parentDataSource)||void 0===_c?void 0:_c.getServiceDefinition():yield jimu_core.ljd.getInstance().fetchServiceInfo(`${jimu_core.ZkX.getFullArcGISServiceUrl(this.url,!1)}/layers`).then((res=>res.definition));definition.subLayers=definition.subLayers.map((l=>{var _a;const def=null===(_a=null==allLayerDefs?void 0:allLayerDefs.layers)||void 0===_a?void 0:_a.find((allDef=>allDef.id===l.id));return Object.assign(Object.assign({},l),def)}))}return this.serviceDefinition=definition,this.serviceDefinition}return Promise.reject(new jimu_core.yR5(this.id,"Failed to fetch service definition, need url."))}))}getPartialSubLayerDefinitions(){var _a;return(null===(_a=this.getServiceDefinition())||void 0===_a?void 0:_a.subLayers)||[]}getPartialLayerAndTableDefinitions(){var _a,_b;const layers=(null===(_a=this.getServiceDefinition())||void 0===_a?void 0:_a.layers)||[],tables=(null===(_b=this.getServiceDefinition())||void 0===_b?void 0:_b.tables)||[];return layers.concat(tables)}getChildIdByLayerDefinition(layerDefinition,url){return jimu_core.ZkX.getFixedLayerIdByLayerDefinition(layerDefinition)||jimu_core.ZkX.getLabelFromArcGISServiceUrl(url)}getChildIdByLayer(layer){return jimu_core.ZkX.getFixedLayerIdByLayer(layer)||jimu_core.ZkX.getLabelFromArcGISServiceUrl(jimu_core.ZkX.getUrlByLayer(layer))}getChildIdBySubLayer(subLayer){var _a,_b;const fixedSubLayer=Object.assign(Object.assign({},subLayer),{id:null!==(_b=null===(_a=null==subLayer?void 0:subLayer.source)||void 0===_a?void 0:_a.mapLayerId)&&void 0!==_b?_b:subLayer.id});return jimu_core.ZkX.getFixedLayerIdByLayer(fixedSubLayer)||jimu_core.ZkX.getLabelFromArcGISServiceUrl(jimu_core.ZkX.getUrlByLayer(subLayer))}getChildIdsByUrl(){return this.getPartialLayerAndTableDefinitions().concat(this.getPartialSubLayerDefinitions()).map((l=>this.getChildIdByLayerDefinition(l,jimu_core.ZkX.getFullArcGISServiceUrl(this.getDataSourceJson().url,!0,l))))}updateChildDataSourcesGDBVersion(childDss){this.getInfo().gdbVersion&&childDss.forEach((ds=>{(null==ds?void 0:ds.type)===jimu_core.hg5.FeatureLayer&&ds.changeGDBVersion(this.getInfo().gdbVersion)}))}getGDBVersion(){return this.getInfo().gdbVersion}changeGDBVersion(gdbVersion){(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.changeDataSourceGDBVersion(this.id,gdbVersion)),this.updateChildDataSourcesGDBVersion(this.getAllChildDataSources()),jimu_core.e7y.changeQueryObjectByDataSourceGDBVersion(this.id,gdbVersion)}}var feature_service_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class feature_service_data_source_impl_FeatureServiceDataSourceImpl extends abstract_layer_folder_data_source_AbstractLayerFolderDataSource{constructor(){super(...arguments),this.type=jimu_core.hg5.FeatureService}fetchServiceDefinition(){const _super=Object.create(null,{fetchServiceDefinition:{get:()=>super.fetchServiceDefinition}});return feature_service_data_source_impl_awaiter(this,void 0,void 0,(function*(){const[serviceDefinitions,fullLayerDefinitions]=yield Promise.all([_super.fetchServiceDefinition.call(this),jimu_core.ljd.getInstance().fetchServiceInfo(`${this.url}/layers`).then((res=>res.definition))]);return serviceDefinitions.layers=fullLayerDefinitions.layers,serviceDefinitions.tables=fullLayerDefinitions.tables,serviceDefinitions}))}getChildIds(){return this.getChildIdsByUrl()}createChildDataSourceOptionsById(childDsId,jimuChildId,childId){return this.createChildDataSourceOptionsByIdFromUrl(childDsId,jimuChildId,childId)}createJSAPILayerByDataSource(dataSource_1){const _super=Object.create(null,{createJSAPILayerByDataSource:{get:()=>super.createJSAPILayerByDataSource}});return feature_service_data_source_impl_awaiter(this,arguments,void 0,(function*(dataSource,useDataSourceQueryParams=!0,throwError=!1){var _a,_b,_c,_d,_e,_f,_g;const createdBy=dataSource||this;let layer;try{createdBy.areChildDataSourcesCreated()||(yield createdBy.childDataSourcesReady());if((null===(_b=null===(_a=createdBy.getItemInfo())||void 0===_a?void 0:_a.typeKeywords)||void 0===_b?void 0:_b.includes("Singlelayer"))||1===(null===(_d=null===(_c=createdBy.getServiceDefinition())||void 0===_c?void 0:_c.layers)||void 0===_d?void 0:_d.length)){const childDss=createdBy.getChildDataSources();if(0===childDss.length){const[Layer,GroupLayer]=yield(0,jimu_core.e$n)(["esri/layers/Layer","esri/layers/GroupLayer"]),childLayer=yield Layer.fromArcGISServerUrl({url:`${createdBy.url}/${(null===(_g=null===(_f=null===(_e=createdBy.getServiceDefinition())||void 0===_e?void 0:_e.layers)||void 0===_f?void 0:_f[0])||void 0===_g?void 0:_g.id)||0}`});layer=new GroupLayer({layers:childLayer.isTable?[]:[childLayer],tables:childLayer.isTable?[childLayer]:[],title:createdBy.getLabel()})}else{const loadJSAPIGroupLayerPromise=(0,jimu_core.p8A)("esri/layers/GroupLayer"),createJSAPILayerForChildDsPromise=childDss[0].layer?Promise.resolve(childDss[0].layer):childDss[0].createJSAPILayerByDataSource(),[GroupLayer,childLayer]=yield Promise.all([loadJSAPIGroupLayerPromise,createJSAPILayerForChildDsPromise]);layer=new GroupLayer({layers:childLayer.isTable?[]:[childLayer],tables:childLayer.isTable?[childLayer]:[],title:createdBy.getLabel()})}}else layer=yield _super.createJSAPILayerByDataSource.call(this,dataSource,useDataSourceQueryParams,throwError);this.afterCreateJSAPILayer(layer,createdBy)}catch(err){if(throwError)throw err;console.error("Failed to create JS API layer. ",err,this.id)}return"group"===(null==layer?void 0:layer.type)?layer:null}))}}class group_layer_data_source_impl_GroupLayerDataSourceImpl extends abstract_layer_folder_data_source_AbstractLayerFolderDataSource{constructor(options){super(options),this.type=jimu_core.hg5.GroupLayer,this.setItemData(options.itemData)}getChildIds(){return this.layer?this.getChildIdsByLayer():this.url?this.getChildIdsByUrl():this.itemId||this.getItemData()?this.getChildIdsByItem():[]}createChildDataSourceOptionsById(childDsId,jimuChildId,childId){return this.layer?this.createChildDataSourceOptionsByIdFromLayer(childDsId,jimuChildId,childId):this.url?this.createChildDataSourceOptionsByIdFromUrl(childDsId,jimuChildId,childId):this.itemId||this.getItemData()?this.createChildDataSourceOptionsByIdFromItem(childDsId,jimuChildId,childId):null}getChildIdsByLayer(){return this.isJSAPIGroupLayer(this.layer)?this.getChildIdsByJSAPIGroupLayer():this.getChildIdsByJSAPISubLayer()}getChildIdsByItem(){return this.isFeatureCollectionItem(this.getItemInfo())?this.getChildIdsByFeatureCollectionItem():this.getChildIdsByGroupLayerItem()}createChildDataSourceOptionsByIdFromLayer(childDsId,jimuChildId,childId){if(this.layer){const isJSAPIGroupLayer=this.isJSAPIGroupLayer(this.layer),layerInfo=isJSAPIGroupLayer?this.findLayerInfoOfJSAPIGroupLayer(childId):this.findLayerInfoOfJSAPISubLayer(childId);if(!(null==layerInfo?void 0:layerInfo.layer))return null;if(isJSAPIGroupLayer)return this.createChildDataSourceOptionsByLayer(layerInfo.layer,layerInfo.url,jimuChildId,childDsId,layerInfo.order);{const dsOptions=this.createChildDataSourceOptionsByLayerDefinition(layerInfo.layer.sourceJSON,layerInfo.url,jimuChildId,childDsId,layerInfo.order);return layerInfo.layer.title&&(null==dsOptions?void 0:dsOptions.dataSourceJson)&&(dsOptions.dataSourceJson=dsOptions.dataSourceJson.set("sourceLabel",layerInfo.layer.title)),dsOptions?Object.assign(Object.assign({},dsOptions),{layer:layerInfo.layer}):null}}return null}createChildDataSourceOptionsByIdFromItem(childDsId,jimuChildId,childId){let dsOptions;if(this.isFeatureCollectionItem(this.getItemInfo())){const layerInfo=this.findLayerInfoOfFeatureCollectionItem(childId);if(!(null==layerInfo?void 0:layerInfo.layerDefinition))return null;dsOptions=this.createChildDataSourceOptionsByLayerDefinition(layerInfo.layerDefinition,null,jimuChildId,childDsId,layerInfo.order),dsOptions&&(null==dsOptions?void 0:dsOptions.dataSourceJson)&&!dsOptions.dataSourceJson.layerId&&(dsOptions.dataSourceJson=dsOptions.dataSourceJson.set("layerId",`${layerInfo.order}`))}else{const layerInfo=this.findLayerInfoOfGroupLayerItem(childId);if(!(null==layerInfo?void 0:layerInfo.layerItem))return null;dsOptions=this.createChildDataSourceOptionsByLayerItem(layerInfo.layerItem,layerInfo.portalUrl,jimuChildId,childDsId,layerInfo.order)}return dsOptions}createChildDataSourceOptionsByLayerItem(item,portalUrl,jimuChildId,childDsId,order){const dsJson=this.createChildDataSourceJsonByLayerItem(item,portalUrl,jimuChildId,childDsId);return dsJson?{id:childDsId,dataSourceJson:dsJson,parentDataSource:this,jimuChildId,order,itemData:item}:null}createChildDataSourceJsonByLayerItem(itemData,portalUrl,jimuChildId,childDsId){var _a,_b,_c;if(!itemData||!childDsId)return null;const schemaInConfig=null===(_b=null===(_a=this.getDataSourceJson().schema)||void 0===_a?void 0:_a.childSchemas)||void 0===_b?void 0:_b[jimuChildId],dsJsonInConfig=null===(_c=this.getDataSourceJson().childDataSourceJsons)||void 0===_c?void 0:_c[jimuChildId];return jimu_core.ZkX.dataSourceJsonCreator.createDataSourceJsonByItemData(childDsId,itemData,portalUrl,dsJsonInConfig,schemaInConfig)}createChildDataSourceOptionsByLayer(layer,url,jimuChildId,childDsId,order){const dsJson=this.createChildDataSourceJsonByLayer(layer,url,jimuChildId,childDsId);return dsJson?{id:childDsId,dataSourceJson:dsJson,parentDataSource:this,jimuChildId,order,layer}:null}createChildDataSourceJsonByLayer(layer,url,jimuChildId,childDsId){var _a,_b,_c,_d,_e,_f;if(!layer||!childDsId)return null;const layerDefinition=layer.sourceJSON,_jimuChildIdFromLabel=jimu_core.ZkX._getFixedLayerIdByLayerDefinition(layerDefinition)||jimu_core.ZkX.getLabelFromArcGISServiceUrl(url),schemaInConfig=(null===(_b=null===(_a=this.getDataSourceJson().schema)||void 0===_a?void 0:_a.childSchemas)||void 0===_b?void 0:_b[jimuChildId])||(null===(_d=null===(_c=this.getDataSourceJson().schema)||void 0===_c?void 0:_c.childSchemas)||void 0===_d?void 0:_d[_jimuChildIdFromLabel]),dsJsonInConfig=(null===(_e=this.getDataSourceJson().childDataSourceJsons)||void 0===_e?void 0:_e[jimuChildId])||(null===(_f=this.getDataSourceJson().childDataSourceJsons)||void 0===_f?void 0:_f[_jimuChildIdFromLabel]);return jimu_core.ZkX.dataSourceJsonCreator.createDataSourceJsonByJSAPILayer(childDsId,layer,dsJsonInConfig,schemaInConfig)}findLayerInfoOfJSAPIGroupLayer(childId){let layerInfo;return this.getJSAPILayersAndTables().some(((l,i)=>{const layerUrl=jimu_core.ZkX.getUrlByLayer(l);return this.getChildIdByLayer(l)===childId&&(layerInfo={layer:l,url:layerUrl,order:i},!0)})),layerInfo}findLayerInfoOfJSAPISubLayer(childId){let layerInfo;return this.getJSAPISubLayers().some(((l,i)=>{const layerUrl=jimu_core.ZkX.getUrlByLayer(l);return this.getChildIdBySubLayer(l)===childId&&(layerInfo={layer:l,url:layerUrl,order:i},!0)})),layerInfo}findLayerInfoOfGroupLayerItem(childId){let layerInfo;return this.getLayersOfGroupLayerItem().some(((l,i)=>this.getChildIdByLayerItem(l)===childId&&(layerInfo={layerItem:l,order:i,portalUrl:this.portalUrl},!0))),layerInfo}findLayerInfoOfFeatureCollectionItem(childId){let layerInfo;return this.getLayersOfFeatureCollectionItem().some(((l,i)=>this.getChildIdByLayerDefinition(l,null)===childId&&(layerInfo={layerDefinition:l,order:i},!0))),layerInfo}getJSAPISubLayers(){var _a,_b;return(null===(_b=null===(_a=this.layer.sublayers)||void 0===_a?void 0:_a.toArray())||void 0===_b?void 0:_b.reverse())||[]}getJSAPILayersAndTables(){var _a,_b,_c,_d;const layers=(null===(_b=null===(_a=this.layer.layers)||void 0===_a?void 0:_a.toArray())||void 0===_b?void 0:_b.reverse())||[],tables=(null===(_d=null===(_c=this.layer.tables)||void 0===_c?void 0:_c.toArray())||void 0===_d?void 0:_d.reverse())||[];return layers.concat(tables)}getLayersOfFeatureCollectionItem(){var _a,_b;return(null===(_b=null===(_a=this.getItemData())||void 0===_a?void 0:_a.layers)||void 0===_b?void 0:_b.map((l=>l.layerDefinition)))||[]}getLayersOfGroupLayerItem(){var _a;return(null===(_a=this.getItemData())||void 0===_a?void 0:_a.layers)||[]}getChildIdsByJSAPISubLayer(){return this.getJSAPISubLayers().map((l=>this.getChildIdBySubLayer(l)))}getChildIdsByJSAPIGroupLayer(){return this.getJSAPILayersAndTables().map((l=>this.getChildIdByLayer(l)))}getChildIdsByFeatureCollectionItem(){return this.getLayersOfFeatureCollectionItem().map((l=>this.getChildIdByLayerDefinition(l,null)))}getChildIdsByGroupLayerItem(){return this.getLayersOfGroupLayerItem().map((l=>this.getChildIdByLayerItem(l)))}getChildIdByLayerItem(item){return jimu_core.ZkX.getFixedLayerIdByLayerDefinition(item)}isJSAPIGroupLayer(layer){return(null==layer?void 0:layer.type)===jimu_core.QBT.GroupLayer}isFeatureCollectionItem(item){return(null==item?void 0:item.type)===jimu_core.RfI.FeatureCollection}}var map_service_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class map_service_data_source_impl_MapServiceDataSourceImpl extends abstract_layer_folder_data_source_AbstractLayerFolderDataSource{constructor(){super(...arguments),this.type=jimu_core.hg5.MapService}getChildIds(){return this.layer?this.getChildIdsByLayer():this.getChildIdsByUrl()}createChildDataSourceOptionsById(childDsId,jimuChildId,childId){return this.layer?this.createChildDataSourceOptionsByIdFromLayer(childDsId,jimuChildId,childId):this.url?this.createChildDataSourceOptionsByIdFromUrl(childDsId,jimuChildId,childId):null}fetchServiceDefinition(){const _super=Object.create(null,{fetchServiceDefinition:{get:()=>super.fetchServiceDefinition}});return map_service_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.layer?(yield this.layer.loadAll(),this.updateServiceDefinitionByLayer(),this.getServiceDefinition()):_super.fetchServiceDefinition.call(this)}))}supportTime(){return jimu_core.ZkX.supportTime(this)}getTimeInfo(){var _a,_b;return this.layer?null===(_a=this.layer.timeInfo)||void 0===_a?void 0:_a.toJSON():null===(_b=this.getServiceDefinition())||void 0===_b?void 0:_b.timeInfo}getTimeExtent(){const widgetQueries=this.getInfo().widgetQueries||{},timeArr=Object.values(widgetQueries).map((q=>null==q?void 0:q.time)).filter((w=>"number"==typeof w||Array.isArray(w)));return timeArr.length>1?timeArr.reduce(((res,t)=>jimu_core.ZkX.mergeTimeExtent(res,t)),null):timeArr[0]}changeTimeExtent(time,widgetId){var _a,_b;jimu_core.WpD.isDeepEqual(time,null===(_b=null===(_a=this.getInfo().widgetQueries)||void 0===_a?void 0:_a[widgetId])||void 0===_b?void 0:_b.time)||((0,jimu_core.Vp3)().dispatch(jimu_core.tRc.updateWidgetQuery(this.id,widgetId,{time})),this.getAllChildDataSources().forEach((cDs=>{cDs.type===jimu_core.hg5.FeatureLayer&&cDs.updateQueryParams({time},widgetId)})))}changeGDBVersion(gdbVersion){super.changeGDBVersion(gdbVersion),this.layer&&"map-image"===this.layer.type&&(this.layer.gdbVersion=gdbVersion)}createChildDataSourceOptionsByIdFromLayer(childDsId,jimuChildId,childId){if(this.layer){const layerInfo=this.findSubLayerInfo(childId);if(!(null==layerInfo?void 0:layerInfo.subLayer))return null;const dsOptions=this.createChildDataSourceOptionsByLayerDefinition(layerInfo.subLayer.sourceJSON,layerInfo.url,jimuChildId,childDsId,layerInfo.order);return layerInfo.subLayer.title&&(null==dsOptions?void 0:dsOptions.dataSourceJson)&&(dsOptions.dataSourceJson=dsOptions.dataSourceJson.set("sourceLabel",layerInfo.subLayer.title)),dsOptions?Object.assign(Object.assign({},dsOptions),{layer:layerInfo.subLayer}):null}return null}findSubLayerInfo(childId){let subLayerInfo;return this.getSubLayers().some(((subLayer,i)=>{const layerUrl=jimu_core.ZkX.getUrlByLayer(subLayer);return this.getChildIdBySubLayer(subLayer)===childId&&(subLayerInfo={subLayer,url:layerUrl,order:i},!0)})),subLayerInfo}getSubLayers(){var _a,_b;return(null===(_b=null===(_a=this.layer.sublayers)||void 0===_a?void 0:_a.toArray())||void 0===_b?void 0:_b.reverse())||[]}getChildIdsByLayer(){var _a,_b;return((null===(_b=null===(_a=this.layer)||void 0===_a?void 0:_a.sublayers)||void 0===_b?void 0:_b.toArray())||[]).map((l=>this.getChildIdBySubLayer(l)))}}var simple_local_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class SimpleLocalDataSourceImpl extends abstract_data_source_AbstractDataSource{constructor(){super(...arguments),this.type=jimu_core.hg5.SimpleLocal}updateRecords(records){return this.records=records,this.addVersion(),Promise.resolve(!0)}addRecord(record){return simple_local_data_source_impl_awaiter(this,void 0,void 0,(function*(){return record.getId()||record.setId((0,jimu_core.nms)()),this.records.push(record),this.addVersion(),yield Promise.resolve(record)}))}updateRecord(record){return simple_local_data_source_impl_awaiter(this,void 0,void 0,(function*(){const i=this.records.findIndex((r=>r.getId()===record.getId()));return this.records.splice(i,1,record),this.addVersion(),Promise.resolve(!0)}))}deleteRecord(index){return simple_local_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.records.splice(index,1),this.addVersion(),yield Promise.resolve(!0)}))}}var scene_service_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class scene_service_data_source_impl_SceneServiceDataSourceImpl extends abstract_layer_folder_data_source_AbstractLayerFolderDataSource{constructor(){super(...arguments),this.type=jimu_core.hg5.SceneService}getChildIds(){return this.getChildIdsByUrl()}createChildDataSourceOptionsById(childDsId,jimuChildId,childId){return this.createChildDataSourceOptionsByIdFromUrl(childDsId,jimuChildId,childId)}createJSAPILayerByDataSource(dataSource_1){const _super=Object.create(null,{createJSAPILayerByDataSource:{get:()=>super.createJSAPILayerByDataSource}});return scene_service_data_source_impl_awaiter(this,arguments,void 0,(function*(dataSource,useDataSourceQueryParams=!0,throwError=!1){var _a,_b,_c,_d,_e,_f,_g;const createdBy=dataSource||this;let layer;try{createdBy.areChildDataSourcesCreated()||(yield createdBy.childDataSourcesReady());if((null===(_b=null===(_a=createdBy.getItemInfo())||void 0===_a?void 0:_a.typeKeywords)||void 0===_b?void 0:_b.includes("Singlelayer"))||1===(null===(_d=null===(_c=createdBy.getServiceDefinition())||void 0===_c?void 0:_c.layers)||void 0===_d?void 0:_d.length)){const childDss=createdBy.getChildDataSources();if(0===childDss.length){const[Layer,GroupLayer]=yield(0,jimu_core.e$n)(["esri/layers/Layer","esri/layers/GroupLayer"]);layer=new GroupLayer({layers:[yield Layer.fromArcGISServerUrl({url:`${createdBy.url}/layers/${(null===(_g=null===(_f=null===(_e=createdBy.getServiceDefinition())||void 0===_e?void 0:_e.layers)||void 0===_f?void 0:_f[0])||void 0===_g?void 0:_g.id)||0}`})],title:createdBy.getLabel()})}else{const loadJSAPIGroupLayerPromise=(0,jimu_core.p8A)("esri/layers/GroupLayer"),createJSAPILayerForChildDsPromise=childDss[0].layer?Promise.resolve(childDss[0].layer):childDss[0].createJSAPILayerByDataSource(),[GroupLayer,childLayer]=yield Promise.all([loadJSAPIGroupLayerPromise,createJSAPILayerForChildDsPromise]);layer=new GroupLayer({layers:[childLayer],title:createdBy.getLabel()})}}else layer=yield _super.createJSAPILayerByDataSource.call(this,dataSource,useDataSourceQueryParams,throwError);this.afterCreateJSAPILayer(layer,createdBy)}catch(err){if(throwError)throw err;console.error("Failed to create JS API layer. ",err,this.id)}return"group"===(null==layer?void 0:layer.type)?layer:null}))}}var scene_layer_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class SceneLayerDataSourceImpl extends AbstractArcGISQueriableDataSource{constructor(options){var _a,_b,_c;super(options),this.type=jimu_core.hg5.SceneLayer;const dsJson=this.getDataSourceJson();if(this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId,this.layerId=dsJson.layerId,options.layer&&(this.layer=options.layer),options.belongToDataSource&&options.belongToDataSource.layer&&(this.layer=options.belongToDataSource.layer),this.isLocal){const associatedDataSourceBelongToDataSource=null===(_a=options.belongToDataSource)||void 0===_a?void 0:_a.getAssociatedDataSource();associatedDataSourceBelongToDataSource&&jimu_core.zAk.getInstance().createLocalDataSource(associatedDataSourceBelongToDataSource,this.localId)}else if(this.isDataView){const associatedDataSourceBelongToDataSource=null===(_b=options.belongToDataSource)||void 0===_b?void 0:_b.getAssociatedDataSource();associatedDataSourceBelongToDataSource&&jimu_core.zAk.getInstance().createDataView(associatedDataSourceBelongToDataSource,this.dataViewId)}this.getAssociatedDataSource()&&((0,jimu_core.Yzm)(this.onInfoChange.bind(this),["dataSourcesInfo",this.getAssociatedDataSource().id]),this.getAssociatedDataSource().setAssociatedDataSource(this)),(null===(_c=this.layer)||void 0===_c?void 0:_c.portalItem)&&this.setItemInfo(this.layer.portalItem.sourceJSON)}ready(){return Promise.all([super.ready(),this.fetchLayerDefinition(),this.createAssociatedDataSource()]).then((()=>this.getAssociatedDataSource()?(this.getInfo().widgetQueries&&Object.keys(this.getInfo().widgetQueries).length&&(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.updateDataSourceInfo(this.getAssociatedDataSource().id,this.getAssociatedDataSource().getInfo().set("widgetQueries",this.getInfo().widgetQueries))),Promise.resolve()):Promise.reject("Need associated feature layer."))).then((()=>{var _a,_b;this.getAssociatedDataSource()&&(0,jimu_core.Yzm)(this.onInfoChange.bind(this),["dataSourcesInfo",this.getAssociatedDataSource().id]),(null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.layer)&&(null===(_b=this.layer)||void 0===_b?void 0:_b.popupTemplate)&&(this.getAssociatedDataSource().layer.popupTemplate=this.layer.popupTemplate)}))}jsAPILayerQueryObjectIds(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryObjectIds(query)}jsAPILayerQueryFeatures(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryFeatures(query)}jsAPILayerQueryExtent(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryExtent(query)}jsAPILayerQueryFeatureCount(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryFeatureCount(query)}onInfoChange(){this.getAssociatedDataSource()&&!jimu_core.WpD.isDeepEqual(this.getInfo().without("instanceStatus"),this.getAssociatedDataSource().getInfo().without("instanceStatus"))&&(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.updateDataSourceInfo(this.id,this.getAssociatedDataSource().getInfo().without("instanceStatus").set("instanceStatus",this.getInfo().instanceStatus)))}createAssociatedDataSource(){return this.getAssociatedDataSource()?Promise.resolve(this.getAssociatedDataSource()):this.layer?this._createAssociatedDataSourceWithLayer().then((associatedDataSource=>associatedDataSource||this._createAssociatedDataSourceWithUrl())):this._createAssociatedDataSourceWithUrl()}_createAssociatedDataSourceWithLayer(){const dsId=this._getNewAssociatedDataSourceId();return this.layer.load().then((()=>{const associatedFeatureLayer=this.layer.associatedLayer;if(!associatedFeatureLayer)return null;this.layer.definitionExpression&&(associatedFeatureLayer.definitionExpression=this.layer.definitionExpression);let dsJson=(0,jimu_core.J3Z)({id:dsId,type:jimu_core.hg5.FeatureLayer,url:jimu_core.ZkX.getUrlByLayer(associatedFeatureLayer)});dsJson=this._mergeAssociatedDataSourceJson(dsJson);const options={id:dsId,dataSourceJson:dsJson,layer:associatedFeatureLayer,associatedDataSource:this};return this.dataSourceManager.createDataSource(options)})).then((ds=>(this.associatedDataSource=ds,this.associatedDataSource)))}_createAssociatedDataSourceWithUrl(){const dsId=this._getNewAssociatedDataSourceId();return jimu_core.ZkX.fetchAssociatedFeatureLayerDefinition(this.url,this.layerId,this.itemId,this.portalUrl).then((res=>{if(!res)return Promise.reject("Can not find associated feature layer");let dsJson=jimu_core.ZkX.dataSourceJsonCreator.createDataSourceJsonByLayerDefinition(dsId,res.def,res.url);return dsJson=this._mergeAssociatedDataSourceJson(dsJson),dsJson})).then((dsJson=>{const options={id:dsJson.id,dataSourceJson:dsJson,associatedDataSource:this};return this.dataSourceManager.createDataSource(options)})).then((ds=>(this.associatedDataSource=ds,this.associatedDataSource)))}_getNewAssociatedDataSourceId(){return`${this.getDataSourceJson().id}-associated_data_source`}getTimezone(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getTimezone()}fetchLayerDefinition(){return scene_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){var _a;try{const url=this.url;if(this.layer)yield this.layer.load(),this.layerDefinition={id:this.layer.layerId,fields:null===(_a=this.layer.fields)||void 0===_a?void 0:_a.map((f=>null==f?void 0:f.toJSON()))};else if(this.url){const layerDef=yield jimu_core.ljd.getInstance().fetchServiceInfo(url).then((res=>res.definition)).then((definition=>definition||null));this.layerDefinition=layerDef}return Promise.resolve(this.layerDefinition)}catch(err){return Promise.resolve(null)}}))}getLayerDefinition(){return jimu_core.ZkX.getLayerDefinition(this)}setLayerDefinition(layerDef){this.layerDefinition=layerDef}getPopupInfo(){return jimu_core.ZkX.getPopupInfo(this)}setPopupInfo(popupInfo){this.popupInfo=popupInfo}getCapabilities(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getCapabilities()}get layer(){return jimu_core.ZkX.getJSAPILayer(this)}set layer(l){this._layer=l}getItemInfo(){return this.isDataView||this.isLocal?this.getMainDataSource().getItemInfo():super.getItemInfo()}fetchSchema(){return scene_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){const label=yield jimu_core.ZkX.getOriginDataLabel(this),sceneLayerSchema=(0,jimu_core.J3Z)({label}),associatedLayerSchema=yield this.getAssociatedDataSource()?this.getAssociatedDataSource().fetchSchema():Promise.resolve(null);return associatedLayerSchema?associatedLayerSchema.merge(sceneLayerSchema):sceneLayerSchema}))}setDataSourceJson(dsJson){if(super.setDataSourceJson(dsJson),this.getAssociatedDataSource()){const aDsJson=this._mergeAssociatedDataSourceJson(this.getAssociatedDataSource().getDataSourceJson());this.getAssociatedDataSource().setDataSourceJson(aDsJson)}}getFetchedSchema(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getFetchedSchema()}setFetchedSchema(fetchedSchema){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.setFetchedSchema(fetchedSchema)}getReversedConfigSchema(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getReversedConfigSchema()}getSelectedFields(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getSelectedFields()}setSelectedFields(jimuNames){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.setSelectedFields(jimuNames)}getIdField(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getIdField()}queryById(id){var _a,_b;return null!==(_b=null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.queryById(id).then((r=>this.fixRecordDataSource(r))))&&void 0!==_b?_b:Promise.reject(Error("No Associated DataSource."))}addRecord(record){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.addRecord(record)}updateRecord(record){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.updateRecord(record)}updateRecords(records){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.updateRecords(records)}deleteRecord(index){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.deleteRecord(index)}deleteRecordById(id){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.deleteRecordById(id)}doQuery(realQuery,originQuery){return this.getAssociatedDataSource()?this.getAssociatedDataSource().doQuery(realQuery,originQuery).then((res=>{var _a;return res.records=null===(_a=res.records)||void 0===_a?void 0:_a.map((r=>this.fixRecordDataSource(r))),res})):Promise.reject(Error("No Associated DataSource."))}doQueryById(id,fields){return this.getAssociatedDataSource()?this.getAssociatedDataSource().doQueryById(id,fields).then((record=>this.fixRecordDataSource(record))):Promise.reject(Error("No Associated DataSource."))}doQueryIds(queryParams){return this.getAssociatedDataSource()?this.getAssociatedDataSource().doQueryIds(queryParams).then((res=>{var _a;return res.records&&(res.records=null===(_a=res.records)||void 0===_a?void 0:_a.map((r=>this.fixRecordDataSource(r)))),res})):Promise.reject(Error("No Associated DataSource."))}doQueryCount(queryProperties){var _a,_b;return null!==(_b=null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.doQueryCount(queryProperties))&&void 0!==_b?_b:Promise.reject(Error("No Associated DataSource."))}getConfigQueryParams(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getConfigQueryParams()}getRemoteQueryParams(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getRemoteQueryParams()}getCurrentQueryParams(options){var _a;return Array.isArray(null==options?void 0:options.exclude)?options.exclude.forEach((e=>{this.fixExcludeQuery(e)})):(null==options?void 0:options.exclude)&&this.fixExcludeQuery(options.exclude),null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getCurrentQueryParams(options)}getRuntimeQueryParams(excludeWidgetId){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getRuntimeQueryParams(excludeWidgetId)}getCurrentQueryId(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getCurrentQueryId()}mergeQueryParams(...queries){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.mergeQueryParams(...queries)}buildRecord(feature){return new FeatureDataRecordImpl(feature,this)}getFieldCodedValueList(jimuFieldName,record){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getFieldCodedValueList(jimuFieldName,record)}getRealQueryParams(query,flag,options){var _a;return options&&this.fixQueryOptions(options),null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getRealQueryParams(query,flag,options)}getAllUsedFields(options){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getAllUsedFields(options)}applyUsedFields(query,usedFields){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.applyUsedFields(query,usedFields)}updateQueryParams(query,widgetId){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.updateQueryParams(query,widgetId)}getGDBVersion(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getGDBVersion()}getGeometryType(){return this.getAssociatedDataSource()?this.getAssociatedDataSource().getGeometryType():null}getQueryPageSize(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getQueryPageSize()}getMaxRecordCount(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getMaxRecordCount()}getRecordsByPage(page,pageSize){var _a,_b;return null===(_b=null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getRecordsByPage(page,pageSize))||void 0===_b?void 0:_b.map((r=>this.fixRecordDataSource(r)))}getPagesData(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getPagesData()}setPagesData(pages){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.setPagesData(pages)}getRealQueryPages(page,pageSize){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getRealQueryPages(page,pageSize)}load(query,options={}){var _a,_b;return options&&this.fixQueryOptions(options),null!==(_b=null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.load(query,options).then((rs=>null==rs?void 0:rs.map((r=>this.fixRecordDataSource(r))))))&&void 0!==_b?_b:Promise.reject(Error("No Associated DataSource."))}loadCount(query,options={}){var _a,_b;return options&&this.fixQueryOptions(options),null!==(_b=null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.loadCount(query,options))&&void 0!==_b?_b:Promise.reject(Error("No Associated DataSource."))}query(query,options){var _a,_b;return options&&this.fixQueryOptions(options),null!==(_b=null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.query(query,options).then((res=>{var _a,_b;return(null===(_a=res.records)||void 0===_a?void 0:_a.length)?Object.assign(Object.assign({},res),{records:null===(_b=res.records)||void 0===_b?void 0:_b.map((r=>this.fixRecordDataSource(r)))}):res})))&&void 0!==_b?_b:Promise.reject(Error("No Associated DataSource."))}queryAll(query,signal,progressCallback,options){var _a,_b;return null!==(_b=null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.queryAll(query,signal,progressCallback,options).then((res=>{var _a,_b;return(null===(_a=res.records)||void 0===_a?void 0:_a.length)?Object.assign(Object.assign({},res),{records:null===(_b=res.records)||void 0===_b?void 0:_b.map((r=>this.fixRecordDataSource(r)))}):res})))&&void 0!==_b?_b:Promise.reject(Error("No Associated DataSource."))}queryCount(query,options){var _a,_b;return options&&this.fixQueryOptions(options),null!==(_b=null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.queryCount(query,options))&&void 0!==_b?_b:Promise.reject(Error("No Associated DataSource."))}loadById(id,refresh){var _a,_b;return null!==(_b=null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.loadById(id,refresh))&&void 0!==_b?_b:Promise.reject(Error("No Associated DataSource."))}changeGDBVersion(gdbVersion){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.changeGDBVersion(gdbVersion)}getAssociatedDataSource(){if(!this.isDataView&&!this.isLocal)return this.associatedDataSource;const realAssoDsId=this._getRealAssociatedDataSourceId();return jimu_core.zAk.getInstance().getDataSource(realAssoDsId)}getAssociatedDataSourceById(dsId){return this.dataSourceManager.getDataSource(dsId).getAssociatedDataSource()}fixQueryOptions(options){(null==options?void 0:options.excludeQuery)&&(Array.isArray(options.excludeQuery)?options.excludeQuery.forEach((e=>{this.fixExcludeQuery(e)})):this.fixExcludeQuery(options.excludeQuery))}fixExcludeQuery(excludeQuery){(null==excludeQuery?void 0:excludeQuery.dataSourceId)&&this.getAssociatedDataSourceById(excludeQuery.dataSourceId)&&(excludeQuery.dataSourceId=this.getAssociatedDataSourceById(excludeQuery.dataSourceId).id)}_getRealAssociatedDataSourceId(){var _a;let realAssoDsId;const belongToAssoDs=null===(_a=this.belongToDataSource)||void 0===_a?void 0:_a.getAssociatedDataSource();return realAssoDsId=this.isLocal?jimu_core.zAk.getInstance().getLocalDataSourceId(null==belongToAssoDs?void 0:belongToAssoDs.id,this.localId):this.isDataView?jimu_core.zAk.getInstance().getDataViewDataSourceId(null==belongToAssoDs?void 0:belongToAssoDs.id,this.dataViewId):this.associatedDataSource.id,realAssoDsId}clearRecords(){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.clearRecords()}setRecords(records){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.setRecords(records)}getRecords(){var _a,_b;return null===(_b=null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getRecords())||void 0===_b?void 0:_b.map((r=>this.fixRecordDataSource(r)))}setSourceRecords(records){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.setSourceRecords(records)}getSourceRecords(){var _a,_b;return null===(_b=null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getSourceRecords())||void 0===_b?void 0:_b.map((r=>this.fixRecordDataSource(r)))}fixRecordDataSource(r,dataSource=this){if(!r)return null;const record=r.clone();return record.dataSource=dataSource,record}getSelectedRecords(){var _a,_b;return null===(_b=null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getSelectedRecords())||void 0===_b?void 0:_b.map((r=>this.fixRecordDataSource(r,this.getSelectionDataView())))}nextRecord(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.nextRecord()}prevRecord(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.prevRecord()}getRecord(index){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getRecord(index)}getRecordById(id){var _a;return this.fixRecordDataSource(null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.getRecordById(id))}clearRecordsNotAddVersion(){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.clearRecordsNotAddVersion()}clearSelection(){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.clearSelection()}addVersion(){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.addVersion()}selectRecord(index){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.selectRecord(index)}selectRecords(options,signal,progressCallback){var _a,_b;return(null===(_a=options.records)||void 0===_a?void 0:_a.length)&&(options.records=options.records.map((r=>r.clone()))),null===(_b=this.getAssociatedDataSource())||void 0===_b?void 0:_b.selectRecords(options)}selectRecordById(id,record){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.selectRecordById(id,null==record?void 0:record.clone())}selectRecordsByIds(ids,records){var _a;null===(_a=this.getAssociatedDataSource())||void 0===_a||_a.selectRecordsByIds(ids,null==records?void 0:records.map((r=>r.clone())))}destroy(){const associatedDataSource=this.getAssociatedDataSource();associatedDataSource&&this.dataSourceManager.destroyDataSource(associatedDataSource.id)}supportSymbol(){return jimu_core.ZkX.supportSymbol(this)}supportAttachment(){return jimu_core.ZkX.supportAttachment(this)}getDataViews(){return super.getDataViews()}getDataView(dataViewId){return super.getDataView(dataViewId)}getMainDataSource(){return super.getMainDataSource()}_mergeAssociatedDataSourceJson(associatedDataSourceJson){return null==associatedDataSourceJson?void 0:associatedDataSourceJson.set("query",this.getDataSourceJson().query).set("dataViews",this.getDataSourceJson().dataViews).set("schema",this.getDataSourceJson().schema)}get count(){var _a;return null===(_a=this.getAssociatedDataSource())||void 0===_a?void 0:_a.count}set count(count){this.getAssociatedDataSource()&&(this.getAssociatedDataSource().count=count)}allowToExportData(){const allowInDataSource=!this.getDataSourceJson().disableExport;return Promise.resolve(allowInDataSource)}}var imagery_layer_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class ImageryLayerDataSourceImpl extends AbstractArcGISQueriableDataSource{constructor(){super(...arguments),this.type=jimu_core.hg5.ImageryLayer}jsAPILayerQueryObjectIds(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryObjectIds(query)}jsAPILayerQueryFeatures(query,layer){const l=layer||this.layer;return"imagery"===(null==l?void 0:l.type)?l.queryRasters(query):null==l?void 0:l.queryFeatures(query)}jsAPILayerQueryExtent(query,layer){const l=layer||this.layer;return"imagery"===(null==l?void 0:l.type)?Promise.reject("Imagery layer does not support to query extent."):null==l?void 0:l.queryExtent(query)}jsAPILayerQueryFeatureCount(query,layer){const l=layer||this.layer;return"imagery"===(null==l?void 0:l.type)?l.queryRasterCount(query):null==l?void 0:l.queryFeatureCount(query)}getGeometryType(){return"esriGeometryPolygon"}get layer(){return jimu_core.ZkX.getJSAPILayer(this)}set layer(l){this._layer=l}fetchSchema(){const _super=Object.create(null,{fetchSchema:{get:()=>super.fetchSchema}});return imagery_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){if(this.layer.fields&&this.layer.fields.length)return _super.fetchSchema.call(this);Promise.resolve(null)}))}ready(){const _super=Object.create(null,{ready:{get:()=>super.ready}});return imagery_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource(null,!0,!0)),yield this.layer.load(),_super.ready.call(this),Promise.resolve(this)}))}}var imagery_tile_layer_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class ImageryTileLayerDataSourceImpl extends(js_api_layer_mixin_JSAPILayerMixinImpl(item_mixin_ItemMixinImpl(abstract_data_source_AbstractDataSource))){constructor(options){super(options),this.type=jimu_core.hg5.ImageryTileLayer,options.layer&&(this.layer=options.layer);const dsJson=this.getDataSourceJson();this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId}getLayerDefinition(){return this.layerDefinition}setLayerDefinition(layerDef){this.layerDefinition=layerDef}supportTime(){return jimu_core.ZkX.supportTime(this)}getTimeInfo(){var _a;const layerDefTimeInfo=null===(_a=this.getLayerDefinition())||void 0===_a?void 0:_a.timeInfo,layerTimeInfo=this.layer.timeInfo;return layerDefTimeInfo&&layerTimeInfo?jimu_core.CM0.merge(layerDefTimeInfo,layerTimeInfo.toJSON()):(null==layerTimeInfo?void 0:layerTimeInfo.toJSON())||layerDefTimeInfo}updateQueryParams(timeParam,widgetId){var _a;timeParam=timeParam||null,jimu_core.WpD.isDeepEqual(timeParam||{},(null===(_a=this.getInfo().widgetQueries)||void 0===_a?void 0:_a[widgetId])||{})||(0,jimu_core.Vp3)().dispatch(jimu_core.tRc.updateWidgetQuery(this.id,widgetId,timeParam))}getCurrentQueryParams(options){var _a,_b,_c;const excludeWidgetId=(null===(_a=null==options?void 0:options.exclude)||void 0===_a?void 0:_a.dataSourceId)===this.id?null===(_b=null==options?void 0:options.exclude)||void 0===_b?void 0:_b.widgetId:null,widgetQueries=excludeWidgetId?null===(_c=this.getInfo().widgetQueries)||void 0===_c?void 0:_c.without(excludeWidgetId):this.getInfo().widgetQueries;return this.getMergedWidgetTimes(widgetQueries)}getMergedWidgetTimes(widgetTimes){let widgetIds=widgetTimes&&Object.keys(widgetTimes)||[];return widgetIds=widgetIds.sort(((a,b)=>a.localeCompare(b,"en",{numeric:!0,sensitivity:"base"}))),this.mergeTimeParams(...widgetIds.map((widgetId=>widgetTimes[widgetId])))}mergeTimeParams(...times){const mergedTimes=(times=times||[]).filter((q=>q)).reduce(((res,q)=>Object.assign(Object.assign({},res),q)),{}),timeArr=times.map((q=>null==q?void 0:q.time)).filter((w=>"number"==typeof w||Array.isArray(w))),time=timeArr.length>1?timeArr.reduce(((res,t)=>jimu_core.ZkX.mergeTimeExtent(res,t)),null):timeArr[0];return delete mergedTimes.time,-1===time?mergedTimes.time=[1,0]:("number"==typeof time||Array.isArray(time))&&(mergedTimes.time=time),mergedTimes}ready(){const _super=Object.create(null,{ready:{get:()=>super.ready}});return imagery_tile_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),this.layer.sourceJSON&&this.setLayerDefinition(this.layer.sourceJSON),_super.ready.call(this),Promise.resolve()}))}}var oriented_imagery_layer_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class OrientImageryLayerDataSourceImpl extends AbstractArcGISQueriableDataSource{constructor(){super(...arguments),this.type=jimu_core.hg5.OrientedImageryLayer}jsAPILayerQueryObjectIds(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryObjectIds(query)}jsAPILayerQueryFeatures(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryFeatures(query)}jsAPILayerQueryExtent(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryExtent(query)}jsAPILayerQueryFeatureCount(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryFeatureCount(query)}get layer(){return jimu_core.ZkX.getJSAPILayer(this)}set layer(l){this._layer=l}ready(){const _super=Object.create(null,{ready:{get:()=>super.ready}});return oriented_imagery_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource(null,!0,!0)),yield this.layer.load(),_super.ready.call(this),Promise.resolve(this)}))}}var vector_tile_service_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class VectorTileServiceDataSourceImpl extends(js_api_layer_mixin_JSAPILayerMixinImpl(item_mixin_ItemMixinImpl(abstract_data_source_AbstractDataSource))){constructor(options){super(options),this.type=jimu_core.hg5.VectorTileService,options.layer&&(this.layer=options.layer);const dsJson=this.getDataSourceJson();this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId}ready(){return vector_tile_service_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}}var geojson_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class GeoJSONDataSourceImpl extends(js_api_layer_mixin_JSAPILayerMixinImpl(item_mixin_ItemMixinImpl(abstract_data_source_AbstractDataSource))){constructor(options){super(options),this.type=jimu_core.hg5.GeoJSON,options.layer&&(this.layer=options.layer);const dsJson=this.getDataSourceJson();this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId,this.url&&jimu_core.Le1.registerCacheableUrl(this.url)}ready(){return geojson_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}}var kml_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class KMLDataSourceImpl extends(js_api_layer_mixin_JSAPILayerMixinImpl(item_mixin_ItemMixinImpl(abstract_data_source_AbstractDataSource))){constructor(options){super(options),this.type=jimu_core.hg5.KML,options.layer&&(this.layer=options.layer);const dsJson=this.getDataSourceJson();this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId,(this.url||this.portalUrl&&this.itemId)&&jimu_core.Le1.registerCacheableUrl(((url,query)=>{if("https://utility.arcgis.com/sharing/kml"!==url)return!1;const sourceUrl=null==query?void 0:query.url;return sourceUrl.includes(this.url)||sourceUrl.includes(`${this.portalUrl}/sharing/rest/content/items/${this.itemId}`)}))}ready(){return kml_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}}var wfs_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class WFSDataSourceImpl extends(js_api_layer_mixin_JSAPILayerMixinImpl(item_mixin_ItemMixinImpl(abstract_data_source_AbstractDataSource))){constructor(options){super(options),this.type=jimu_core.hg5.WFS,options.layer&&(this.layer=options.layer);const dsJson=this.getDataSourceJson();this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId}ready(){return wfs_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}}var wms_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class WMSDataSourceImpl extends(js_api_layer_mixin_JSAPILayerMixinImpl(item_mixin_ItemMixinImpl(abstract_data_source_AbstractDataSource))){constructor(options){super(options),this.type=jimu_core.hg5.WMS,options.layer&&(this.layer=options.layer);const dsJson=this.getDataSourceJson();this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId}ready(){return wms_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}}var wmts_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class WMTSDataSourceImpl extends(js_api_layer_mixin_JSAPILayerMixinImpl(item_mixin_ItemMixinImpl(abstract_data_source_AbstractDataSource))){constructor(options){super(options),this.type=jimu_core.hg5.WMTS,options.layer&&(this.layer=options.layer);const dsJson=this.getDataSourceJson();this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId}ready(){return wmts_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}}class ErrorDataSourceImpl extends abstract_data_source_AbstractDataSource{constructor(){super(...arguments),this.type=jimu_core.hg5.Error}}var subtype_group_layer_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class SubtypeGroupLayerDataSourceImpl extends(set_data_source_mixin_SetDataSourceMixinImpl(AbstractArcGISQueriableDataSource)){constructor(){super(...arguments),this.type=jimu_core.hg5.SubtypeGroupLayer}ready(){const _super=Object.create(null,{ready:{get:()=>super.ready}});return subtype_group_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource(null,!0,!0)),yield this.layer.loadAll(),_super.ready.call(this)}))}getChildIds(){var _a;return null===(_a=this.layer.sublayers)||void 0===_a?void 0:_a.toArray().map((l=>this.getChildIdByLayer(l)))}createChildDataSourceById(childDsId,jimuChildId,childId){const layerInfo=this.findLayerInfo(childId);return this.createChildDataSourceByLayer(null==layerInfo?void 0:layerInfo.layer,jimuChildId,childDsId,null==layerInfo?void 0:layerInfo.order)}selectRecordsByIds(ids,records,updateChildren=!0){const allRecords=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),selectRecords=records||ids.map((id=>allRecords.find((r=>(null==r?void 0:r.getId())===id))));this.copySelectionToDataView(selectRecords,updateChildren),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids})}copySelectionToDataView(selection,updateChildren=!0){if(super.copySelectionToDataView(selection),updateChildren){const selectionGroupedBySubtype={},subtypeField=this.getSubtypeField();null==selection||selection.forEach((r=>{if(r){const subtypeCode=r.getFieldValue(subtypeField);selectionGroupedBySubtype[subtypeCode]||(selectionGroupedBySubtype[subtypeCode]=[]),selectionGroupedBySubtype[subtypeCode].push(r)}})),this.getMainDataSource().getChildDataSources().forEach((c=>{const childDsSelection=selectionGroupedBySubtype[c.getSubtypeCode()]||[];c.selectRecordsByIds(childDsSelection.map((r=>r.getId())),childDsSelection,!1)}))}}updateWidgetQueries(query,widgetId){super.updateWidgetQueries(query,widgetId),this.getMainDataSource().id===this.id?this.getChildDataSources().forEach((c=>{c.addSourceVersion()})):this.isSelectionView()&&this.getMainDataSource().getChildDataSources().forEach((c=>{const childDsSelectionView=c.getSelectionDataView();childDsSelectionView.load({returnGeometry:!0,pageSize:childDsSelectionView.getSourceRecords().length},{widgetId:jimu_core.aH5.W7}),childDsSelectionView.loadCount({},{widgetId:jimu_core.aH5.W7})}))}setDataSourceJson(dsJson){const prevQuery=this.getDataSourceJson().query;super.setDataSourceJson(dsJson),jimu_core.WpD.isDeepEqual(null==dsJson?void 0:dsJson.query,prevQuery)||this.getChildDataSources().forEach((c=>{c.addSourceVersion()}))}getRemoteQueryParams(considerChildren=!0){var _a,_b,_c;if(considerChildren){const query=super.getRemoteQueryParams(),subtypeFieldName=null===(_c=null===(_b=null===(_a=this.getSchema())||void 0===_a?void 0:_a.fields)||void 0===_b?void 0:_b[this.getSubtypeField()])||void 0===_c?void 0:_c.name,whereClausesFromChildDss={};this.getChildDataSources().forEach((c=>{const remoteQueryFromChild=c.getRemoteQueryParams(!1),configQueryFromChild=c.getConfigQueryParams(),q=this.mergeQueryParams(remoteQueryFromChild,configQueryFromChild);jimu_core.ZkX.isWhereClauseEmpty(null==q?void 0:q.where)||(whereClausesFromChildDss[c.getSubtypeCode()]=q.where)}));const finalWhereClause=jimu_core.ZkX.mergeSubtypeSublayerWhereClausesToSubtypeGroupLayer(subtypeFieldName,null,whereClausesFromChildDss);return this.mergeQueryParams({where:finalWhereClause},query)}return super.getRemoteQueryParams()}getRuntimeQueryParams(excludeWidgetIds,considerChildren=!0){return this.getRuntimeQueryParamsWithSpecificWidgetQueries(excludeWidgetIds,this.getInfo().widgetQueries,considerChildren)}getRuntimeQueryParamsWithSpecificWidgetQueries(excludeWidgetIds,widgetQueries,considerChildren=!0){var _a,_b,_c;const isMainDs=this.getMainDataSource().id===this.id;if(considerChildren&&(isMainDs||this.isSelectionView())){const query=super.getRuntimeQueryParamsWithSpecificWidgetQueries(excludeWidgetIds,widgetQueries),subtypeFieldName=null===(_c=null===(_b=null===(_a=this.getSchema())||void 0===_a?void 0:_a.fields)||void 0===_b?void 0:_b[this.getSubtypeField()])||void 0===_c?void 0:_c.name,whereClausesFromChildDss={};this.getMainDataSource().getChildDataSources().forEach((c=>{const q=isMainDs?c.getRuntimeQueryParams(null,!1):c.getSelectionDataView().getRuntimeQueryParams(null,!1);jimu_core.ZkX.isWhereClauseEmpty(null==q?void 0:q.where)||(whereClausesFromChildDss[c.getSubtypeCode()]=q.where)}));const finalWhereClause=jimu_core.ZkX.mergeSubtypeSublayerWhereClausesToSubtypeGroupLayer(subtypeFieldName,null,whereClausesFromChildDss);return this.mergeQueryParams({where:finalWhereClause},query)}return super.getRuntimeQueryParamsWithSpecificWidgetQueries(excludeWidgetIds,widgetQueries)}getSubtypeField(){var _a;const originSubtypeFieldField=null===(_a=this.getLayerDefinition())||void 0===_a?void 0:_a.subtypeField;return this.findJimuFieldName(originSubtypeFieldField)||this.findJimuFieldName(null==originSubtypeFieldField?void 0:originSubtypeFieldField.toLowerCase())}jsAPILayerQueryObjectIds(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryObjectIds(query)}jsAPILayerQueryFeatures(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryFeatures(query)}jsAPILayerQueryExtent(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryExtent(query)}jsAPILayerQueryFeatureCount(query,layer){const l=layer||this.layer;return null==l?void 0:l.queryFeatureCount(query)}get layer(){return jimu_core.ZkX.getJSAPILayer(this)}set layer(l){this._layer=l}getChildDataSources(){return super.getChildDataSources()}findLayerInfo(childId){var _a;let layerInfo;return null===(_a=this.layer.sublayers)||void 0===_a||_a.toArray().some(((l,i)=>this.getChildIdByLayer(l)===childId&&(layerInfo={layer:l,order:i},!0))),layerInfo}createChildDataSourceByLayer(layer,jimuChildId,childDsId,order){var _a,_b,_c;const schemaInConfig=(null===(_b=null===(_a=this.getDataSourceJson().schema)||void 0===_a?void 0:_a.childSchemas)||void 0===_b?void 0:_b[jimuChildId])||null,dsJsonInConfig=(null===(_c=this.getDataSourceJson().childDataSourceJsons)||void 0===_c?void 0:_c[jimuChildId])||null,dsJson=jimu_core.ZkX.dataSourceJsonCreator.createDataSourceJsonByJSAPILayer(childDsId,layer,dsJsonInConfig,schemaInConfig),options=dsJson?{id:dsJson.id,dataSourceJson:dsJson,layer,parentDataSource:this,jimuChildId,order}:null;return options?this.dataSourceManager.createDataSource(options):this.dataSourceManager.createDataSource(childDsId,null,null,!0)}getChildIdByLayer(layer){return jimu_core.ZkX.getFixedLayerIdByLayer(layer)}createJSAPILayerByDataSource(dataSource,useDataSourceQueryParams,throwError){const _super=Object.create(null,{createJSAPILayerByDataSource:{get:()=>super.createJSAPILayerByDataSource}});return subtype_group_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){var _a,_b;const createdBy=dataSource||this,layer=yield _super.createJSAPILayerByDataSource.call(this,dataSource,useDataSourceQueryParams,throwError);return(null==layer?void 0:layer.type)!==jimu_core.QBT.SubtypeGroupLayer||(null===(_a=createdBy.getRootDataSource())||void 0===_a?void 0:_a.map)||(yield layer.loadAll(),null===(_b=layer.sublayers)||void 0===_b||_b.toArray().forEach((l=>{l.id=`${l.subtypeCode}`}))),layer}))}getSublayerDataSourceByRecordId(id){return subtype_group_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){var _a;if(!id)return null;const record=this.getRecords().find((r=>r.getId()===id))||(yield this.queryById(id));if(!record)return null;const subtypeCode=record.getFieldValue(this.getSubtypeField()),sublayer=this.layer.sublayers.find((l=>l.subtypeCode===subtypeCode));if(!sublayer)return null;const childId=this.getChildIdByLayer(sublayer),jimuChildId=null===(_a=this.getJimuChildId(childId))||void 0===_a?void 0:_a[0],childDsId=this.getChildDataSourceId(jimuChildId);let childDs=this.dataSourceManager.getDataSource(childDsId);if(!childDs)try{childDs=yield this.createChildDataSourceById(childDsId,jimuChildId,childId)}catch(err){childDs=null}return childDs}))}}var subtype_sublayer_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class SubtypeSublayerDataSourceImpl extends AbstractArcGISQueriableDataSource{constructor(){super(...arguments),this.type=jimu_core.hg5.SubtypeSublayer}ready(){return super.ready().then((()=>{if(this.isSelectionView()){const parentDsSelection=this.getMainDataSource().parentDataSource.getSelectedRecords();if(!(null==parentDsSelection?void 0:parentDsSelection.length))return;const subtypeField=this.getSubtypeField(),subtypeCode=this.getSubtypeCode(),selection=parentDsSelection.filter((r=>r.getFieldValue(subtypeField)===subtypeCode));selection.length&&jimu_core.CM0.defer((()=>{this.getMainDataSource().selectRecordsByIds(selection.map((r=>r.getId())),selection,!1)}))}}))}getSubtypeCode(){return this.layer.subtypeCode}getSubtypeField(){return this.getMainDataSource().parentDataSource.getSubtypeField()}jsAPILayerQueryObjectIds(query,layer){const l=layer||this.layer,queryLayer=l.type===jimu_core.QBT.FeatureLayer?l:l.parent;return query.where=l.type===jimu_core.QBT.FeatureLayer?query.where:this.ensureWhereClauseMatchesSubtype(query.where),queryLayer.queryObjectIds(query)}jsAPILayerQueryFeatures(query,layer){const l=layer||this.layer,queryLayer=l.type===jimu_core.QBT.FeatureLayer?l:l.parent;return query.where=l.type===jimu_core.QBT.FeatureLayer?query.where:this.ensureWhereClauseMatchesSubtype(query.where),queryLayer.queryFeatures(query)}jsAPILayerQueryExtent(query,layer){const l=layer||this.layer,queryLayer=l.type===jimu_core.QBT.FeatureLayer?l:l.parent;return query.where=l.type===jimu_core.QBT.FeatureLayer?query.where:this.ensureWhereClauseMatchesSubtype(query.where),null==queryLayer?void 0:queryLayer.queryExtent(query)}jsAPILayerQueryFeatureCount(query,layer){const l=layer||this.layer,queryLayer=l.type===jimu_core.QBT.FeatureLayer?l:l.parent;return query.where=l.type===jimu_core.QBT.FeatureLayer?query.where:this.ensureWhereClauseMatchesSubtype(query.where),queryLayer.queryFeatureCount(query)}selectRecordsByIds(ids,records,updateParent=!0){const allRecords=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),selectRecords=records||ids.map((id=>allRecords.find((r=>(null==r?void 0:r.getId())===id))));this.copySelectionToDataView(selectRecords,updateParent),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids})}copySelectionToDataView(selection,updateParent=!0){if(super.copySelectionToDataView(selection),updateParent){const parentDataSource=this.getMainDataSource().parentDataSource,parentDsSelection=parentDataSource.getSelectionDataView().getSourceRecords().filter((r=>(null==r?void 0:r.getFieldValue(parentDataSource.getSubtypeField()))!==this.getSubtypeCode())).concat(selection);parentDataSource.selectRecordsByIds(parentDsSelection.map((r=>null==r?void 0:r.getId())),parentDsSelection,!1)}}updateQueryParams(query,widgetId){if(super.updateQueryParams(query,widgetId),this.getMainDataSource().id===this.id)this.getMainDataSource().parentDataSource.addSourceVersion();else if(this.isSelectionView()){const parentDsSelectionView=this.getMainDataSource().parentDataSource.getSelectionDataView();parentDsSelectionView.load({returnGeometry:!0,pageSize:parentDsSelectionView.getSourceRecords().length},{widgetId:jimu_core.aH5.W7}),parentDsSelectionView.loadCount({},{widgetId:jimu_core.aH5.W7})}}setDataSourceJson(dsJson){const prevQuery=this.getDataSourceJson().query;if(super.setDataSourceJson(dsJson),!jimu_core.WpD.isDeepEqual(null==dsJson?void 0:dsJson.query,prevQuery)){this.getMainDataSource().parentDataSource.addSourceVersion()}}setLayerDefinition(layerDef){const parentDataSource=this.getMainDataSource().parentDataSource;this.layerDefinition=Object.assign(Object.assign(Object.assign({},parentDataSource.getLayerDefinition()),{id:this.getSubtypeCode()}),layerDef)}getRemoteQueryParams(considerParent=!0){if(considerParent){const query=super.getRemoteQueryParams(),parentDataSource=this.getMainDataSource().parentDataSource,remoteQueryFromParent=parentDataSource.getRemoteQueryParams(!1),configQueryFromParent=parentDataSource.getConfigQueryParams();return this.mergeQueryParams(remoteQueryFromParent,configQueryFromParent,query)}return super.getRemoteQueryParams()}getRuntimeQueryParams(excludeWidgetIds,considerParent=!0){return this.getRuntimeQueryParamsWithSpecificWidgetQueries(excludeWidgetIds,this.getInfo().widgetQueries,considerParent)}getRuntimeQueryParamsWithSpecificWidgetQueries(excludeWidgetIds,widgetQueries,considerParent=!0){const isMainDs=this.getMainDataSource().id===this.id;if(considerParent&&(isMainDs||this.isSelectionView())){const query=super.getRuntimeQueryParamsWithSpecificWidgetQueries(excludeWidgetIds,widgetQueries),parentDataSource=this.getMainDataSource().parentDataSource,queryFromParent=isMainDs?parentDataSource.getRuntimeQueryParams(null,!1):parentDataSource.getSelectionDataView().getRuntimeQueryParams(null,!1);return this.mergeQueryParams(queryFromParent,query)}return super.getRuntimeQueryParamsWithSpecificWidgetQueries(excludeWidgetIds,widgetQueries)}changeSelectionInUrl(options){var _a,_b,_c,_d;((null===(_a=null==options?void 0:options.queryParams)||void 0===_a?void 0:_a.geometry)||(null===(_b=null==options?void 0:options.queryParams)||void 0===_b?void 0:_b.spatialRel)||0===(null===(_c=options.records)||void 0===_c?void 0:_c.length)||0===(null===(_d=options.ids)||void 0===_d?void 0:_d.length))&&super.changeSelectionInUrl(options)}get layer(){return jimu_core.ZkX.getJSAPILayer(this)}set layer(l){this._layer=l}ensureWhereClauseMatchesSubtype(whereClause){var _a,_b,_c;const parentDataSource=this.getMainDataSource().parentDataSource,subtypeFieldName=null===(_c=null===(_b=null===(_a=parentDataSource.getSchema())||void 0===_a?void 0:_a.fields)||void 0===_b?void 0:_b[parentDataSource.getSubtypeField()])||void 0===_c?void 0:_c.name,subtypeCode=this.getSubtypeCode();return jimu_core.ZkX.ensureWhereClauseMatchesSubtype(whereClause,subtypeFieldName,subtypeCode)}allowToExportData(){return this.getMainDataSource().parentDataSource.allowToExportData()}getExportOptions(){return this.getMainDataSource().parentDataSource.getExportOptions()}createJSAPILayerByDataSource(dataSource_1){return subtype_sublayer_data_source_impl_awaiter(this,arguments,void 0,(function*(dataSource,useDataSourceQueryParams=!0,throwError=!1){var _a;const createdBy=dataSource||this;let layer;try{if(createdBy.dataViewId===jimu_core.aH5.W7&&createdBy.useNoSelectionView()){const noSelectionView=createdBy.getMainDataSource().getDataView(jimu_core.aH5.kf);if(noSelectionView){layer=(yield jimu_core.ZkX.createJSAPIFeatureLayerByRecords(noSelectionView,noSelectionView.getRecords())).layer}}else if(createdBy.getDataSourceJson().isDataInDataSourceInstance)layer=yield jimu_core.ZkX.createJSAPIFeatureLayerByRecords(createdBy,createdBy.getSourceRecords()).then((res=>null==res?void 0:res.layer));else{const subtypeCode=createdBy.getSubtypeCode(),options=this.getLayerConstructorOptions(createdBy.getMainDataSource().parentDataSource);options.sublayers=[{subtypeCode:createdBy.getSubtypeCode()}];const parentLayer=new(yield(0,jimu_core.p8A)("esri/layers/SubtypeGroupLayer"))(options);yield parentLayer.loadAll(),layer=parentLayer.sublayers.toArray().find((l=>l.subtypeCode===subtypeCode))}useDataSourceQueryParams&&(layer.type===jimu_core.QBT.FeatureLayer?this.syncQueryParams(layer,createdBy):(this.syncQueryParams(layer.parent,createdBy),layer.parent.definitionExpression=this.ensureWhereClauseMatchesSubtype(null===(_a=createdBy.getCurrentQueryParams())||void 0===_a?void 0:_a.where))),this.afterCreateJSAPILayer(layer,createdBy)}catch(err){if(throwError)throw err;console.error("Failed to create JS API layer. ",err,this.id)}return layer}))}}var building_scene_layer_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};const building_scene_layer_data_source_impl_dataSourceJsonCreator=jimu_core.ZkX.dataSourceJsonCreator;class BuildingSceneLayerDataSourceImpl extends abstract_layer_folder_data_source_AbstractLayerFolderDataSource{constructor(options){if(super(options),this.type=jimu_core.hg5.BuildingSceneLayer,options.layer){const urlArray=options.layer.url.split("/");"SceneServer"===urlArray[urlArray.length-1]&&(this.url=`${options.layer.url}/layers/${options.layer.layerId}`)}}ready(){return building_scene_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){this.serviceDefinition||(this.serviceDefinition=yield this.fetchServiceDefinition());const associatedFeatureServerUrl=jimu_core.ZkX.getFullArcGISServiceUrl(this.url,!1).replace("SceneServer","FeatureServer");try{yield jimu_core.Le1.requestWrapper(associatedFeatureServerUrl,(session=>building_scene_layer_data_source_impl_awaiter(this,void 0,void 0,(function*(){return yield jimu_core._2M.restRequest.request(associatedFeatureServerUrl,{authentication:session,httpMethod:"GET"})}))))}catch(err){return err}return Promise.resolve()}))}createChildDataSourceOptionsById(childDsId,jimuChildId,childId){var _a;const subLayerUrl=this.getSubLayerUrlByChildId(childId),serviceInfo={url:subLayerUrl,layerDefinition:this.layer?null:this.getSubLayerDefinitionByChildId(childId)},subLayer=this.getSubLayerByChildId(childId);let dsJson=building_scene_layer_data_source_impl_dataSourceJsonCreator.createDataSourceJson(childDsId,subLayer,{portalUrl:""},serviceInfo).set("url",subLayerUrl);(null===(_a=serviceInfo.layerDefinition)||void 0===_a?void 0:_a.layerType)&&(dsJson=dsJson.set("type",serviceInfo.layerDefinition.layerType));const dsJsonInRootDs=jimu_core.ZkX.getChildDsJsonFromRootDs(this,jimuChildId),option={id:childDsId,dataSourceJson:dsJson.merge(dsJsonInRootDs,{deep:!0}),jimuChildId,parentDataSource:this,serviceUrl:this.url};return this.layer?option.layer=subLayer:this.serviceDefinition&&(option.layerDefinition=this.getSubLayerDefinitionByChildId(childId)),option}getChildIds(){if(this.layer){return this.layer.sublayers.toArray().map((layer=>this.getChildIdByLayer(layer)))}if(this.serviceDefinition){return this.serviceDefinition.sublayers.map((subLayerDef=>`${subLayerDef.id}`))}return[]}getSubLayerByChildId(childId){if(!this.layer)return null;const subLayers=this.layer.sublayers.toArray();for(const subLayer of subLayers){if(this.getChildIdByLayer(subLayer)===childId)return subLayer}return null}getSubLayerDefinitionByChildId(childId){if(!this.serviceDefinition)return null;const subLayerDefinitions=this.serviceDefinition.sublayers;for(const subLayerDef of subLayerDefinitions)if(`${subLayerDef.id}`===childId)return"group"===subLayerDef.layerType?subLayerDef.layerType=jimu_core.QBT.BuildingGroupSubLayer:"3DObject"===subLayerDef.layerType&&(subLayerDef.layerType=jimu_core.QBT.BuildingComponentSubLayer),subLayerDef;return null}getSubLayerUrlByChildId(childId){const sublayer=this.getSubLayerByChildId(childId),sublayerUrl=`${this.url}/sublayers/${childId}`;if(sublayer)return sublayer.type===jimu_core.QBT.BuildingComponentSubLayer?sublayerUrl:null;return this.getSubLayerDefinitionByChildId(childId).layerType===jimu_core.QBT.BuildingComponentSubLayer?sublayerUrl:null}updateQueryParams(sqlQueryParams,widgetId){const allComponentDss=this.getAllChildDataSources().filter((ds=>ds.type===jimu_core.at.BuildingComponentSubLayer));for(const componentDs of allComponentDss)componentDs.updateQueryParams(sqlQueryParams,widgetId)}}var building_component_sublayer_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};const building_component_sublayer_data_source_impl_dataSourceJsonCreator=jimu_core.ZkX.dataSourceJsonCreator;class BuildingComponentSubLayerDataSourceImpl extends SceneLayerDataSourceImpl{constructor(){super(...arguments),this.type=jimu_core.hg5.BuildingComponentSubLayer}createAssociatedDataSource(){return building_component_sublayer_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.getAssociatedDataSource()?Promise.resolve(this.getAssociatedDataSource()):this.layer?this._createAssociatedDataSourceWithLayer():this._createAssociatedDataSourceWithLayerDefinition()}))}getAssociatedFeatureServerUrl(){const sceneServiceUrlArray=jimu_core.ZkX.getFullArcGISServiceUrl(this.url,!1).split("/");sceneServiceUrlArray[sceneServiceUrlArray.length-1]="FeatureServer";return sceneServiceUrlArray.join("/")}_createAssociatedDataSourceWithLayer(){return building_component_sublayer_data_source_impl_awaiter(this,void 0,void 0,(function*(){const dsId=this._getNewAssociatedDataSourceId();yield this.layer.load();const associatedFeatureLayer=this.layer.associatedLayer;if(!associatedFeatureLayer)return this._createAssociatedDataSourceWithUrl();this.layer.definitionExpression&&(associatedFeatureLayer.definitionExpression=this.layer.definitionExpression),yield associatedFeatureLayer.load();const featureLayerUrl=associatedFeatureLayer.url+"/"+associatedFeatureLayer.layerId;let dsJson=(0,jimu_core.J3Z)({id:dsId,type:jimu_core.hg5.FeatureLayer,url:featureLayerUrl});dsJson=this._mergeAssociatedDataSourceJson(dsJson);const options={id:dsId,dataSourceJson:dsJson,layer:associatedFeatureLayer,associatedDataSource:this};let featureDs=null;try{featureDs=yield this.dataSourceManager.createDataSource(options)}catch(err){console.warn(err)}return this.associatedDataSource=featureDs,this.associatedDataSource}))}_createAssociatedDataSourceWithLayerDefinition(){return building_component_sublayer_data_source_impl_awaiter(this,void 0,void 0,(function*(){const layerDef=yield this.fetchLayerDefinition(),associatedFeatureLayerUrl=`${this.getAssociatedFeatureServerUrl()}/${layerDef.associatedLayerID}`,dsId=this._getNewAssociatedDataSourceId();let dsJson=building_component_sublayer_data_source_impl_dataSourceJsonCreator.createDataSourceJsonByLayerDefinition(dsId,layerDef,associatedFeatureLayerUrl);dsJson=dsJson.set("url",associatedFeatureLayerUrl),dsJson=this._mergeAssociatedDataSourceJson(dsJson).setIn(["type"],jimu_core.hg5.FeatureLayer);const options={id:dsJson.id,dataSourceJson:dsJson,associatedDataSource:this};let featureDs=null;try{featureDs=yield this.dataSourceManager.createDataSource(options)}catch(err){console.warn(err)}return this.associatedDataSource=featureDs,this.associatedDataSource}))}}var building_group_sublayer_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};const building_group_sublayer_data_source_impl_dataSourceJsonCreator=jimu_core.ZkX.dataSourceJsonCreator;class BuildingGroupSubLayerDataSourceImpl extends abstract_layer_folder_data_source_AbstractLayerFolderDataSource{constructor(){super(...arguments),this.type=jimu_core.hg5.BuildingGroupSubLayer}ready(){return building_group_sublayer_data_source_impl_awaiter(this,void 0,void 0,(function*(){this.serviceDefinition||(yield this.fetchServiceDefinition());let childDss=[];return childDss=window.jimuConfig.isInBuilder?yield this.childDataSourcesReady():this.getChildDataSourceIds(),0===childDss.length?Promise.reject("No sublayers inside this building-group layer, will not create the building-group data source"):Promise.resolve()}))}fetchServiceDefinition(){return this.serviceDefinition||(this.serviceDefinition=this.layerDefinition),Promise.resolve(this.layerDefinition||{})}createChildDataSourceOptionsById(childDsId,jimuChildId,childId){var _a;const subLayerUrl=this.getSubLayerUrlByChildId(childId),serviceInfo={url:subLayerUrl,layerDefinition:this.layer?null:this.getSubLayerDefinitionByChildId(childId)},subLayer=this.getSubLayerByChildId(childId);let dsJson=building_group_sublayer_data_source_impl_dataSourceJsonCreator.createDataSourceJson(childDsId,subLayer,{portalUrl:""},serviceInfo).set("url",subLayerUrl);(null===(_a=serviceInfo.layerDefinition)||void 0===_a?void 0:_a.layerType)&&(dsJson=dsJson.set("type",serviceInfo.layerDefinition.layerType));const dsJsonInRootDs=jimu_core.ZkX.getChildDsJsonFromRootDs(this,jimuChildId),option={id:childDsId,dataSourceJson:dsJson.merge(dsJsonInRootDs,{deep:!0}),jimuChildId,parentDataSource:this,serviceUrl:this.serviceUrl};return this.layer?option.layer=subLayer:this.serviceDefinition&&(option.layerDefinition=this.getSubLayerDefinitionByChildId(childId)),option}getChildIds(){if(this.layer){return this.layer.sublayers.toArray().map((layer=>this.getChildIdByLayer(layer)))}if(this.layerDefinition){return this.layerDefinition.sublayers.map((def=>`${def.id}`))}return[]}getSubLayerByChildId(childId){if(!this.layer)return null;const subLayers=this.layer.sublayers.toArray();for(const subLayer of subLayers){if(this.getChildIdByLayer(subLayer)===childId)return subLayer}return null}getSubLayerDefinitionByChildId(childId){if(!this.layerDefinition)return null;for(const subLayerDef of this.layerDefinition.sublayers)if(subLayerDef.id.toString()===childId.toString())return"group"===subLayerDef.layerType?subLayerDef.layerType=jimu_core.QBT.BuildingGroupSubLayer:"3DObject"===subLayerDef.layerType&&(subLayerDef.layerType=jimu_core.QBT.BuildingComponentSubLayer),subLayerDef;return null}getSubLayerUrlByChildId(childId){const sublayer=this.getSubLayerByChildId(childId),sublayerUrl=`${this.serviceUrl}/sublayers/${childId}`;if(sublayer)return sublayer.type===jimu_core.QBT.BuildingComponentSubLayer?sublayerUrl:null;return this.getSubLayerDefinitionByChildId(childId).layerType===jimu_core.QBT.BuildingComponentSubLayer?sublayerUrl:null}}var elevation_layer_data_source_imp_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class ElevationLayerDataSourceImpl extends(js_api_layer_mixin_JSAPILayerMixinImpl(item_mixin_ItemMixinImpl(abstract_data_source_AbstractDataSource))){constructor(options){super(options),this.type=jimu_core.hg5.ElevationLayer,options.layer&&(this.layer=options.layer);const dsJson=this.getDataSourceJson();this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId}ready(){const _super=Object.create(null,{ready:{get:()=>super.ready}});return elevation_layer_data_source_imp_awaiter(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),_super.ready.call(this),Promise.resolve()}))}}var map_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class MapDataSourceImpl extends(set_data_source_mixin_SetDataSourceMixinImpl(abstract_data_source_AbstractDataSource)){constructor(options){super(options),this.type=jimu_core.hg5.Map,this.map=options.map}ready(){return map_data_source_impl_awaiter(this,void 0,void 0,(function*(){return this.map||(yield this.createMap()),this.createFilterUrlChildDataSource()}))}getChildIds(){return this.getLayersAndTables().map((layerOrTable=>this.getChildIdByLayer(layerOrTable)))}createChildDataSourceById(childDsId,jimuChildId,childId){const layerInfo=this.findLayerInfo(childId);return this.createChildDataSourceByLayer(null==layerInfo?void 0:layerInfo.layer,jimuChildId,childDsId,null==layerInfo?void 0:layerInfo.order)}createDataSourceByLayer(layer){const layerDs=this.getDataSourceByLayer(layer);return layerDs?Promise.resolve(layerDs):this.createDataSourceById(jimu_core.ZkX.getDataSourceIdByJSAPILayer(this,layer))}fetchSchema(){return map_data_source_impl_awaiter(this,void 0,void 0,(function*(){var _a,_b;const dss=this.getChildDataSources();let mapSchema=(0,jimu_core.J3Z)({childSchemas:{},label:null===(_b=null===(_a=this.map)||void 0===_a?void 0:_a.portalItem)||void 0===_b?void 0:_b.title});return dss.forEach(((ds,i)=>{const layerSchema=ds.getFetchedSchema();mapSchema=mapSchema.setIn(["childSchemas",ds.jimuChildId],layerSchema)})),Promise.resolve(mapSchema)}))}getDataSourceByLayer(layer){return this.dataSourceManager.getDataSource(jimu_core.ZkX.getDataSourceIdByJSAPILayer(this,layer))}getDataSourcesByType(type){if(!type)return[];const dataSourcesWithSpecificType=[];return this.traverseToGetDataSourcesByType(type,this,dataSourcesWithSpecificType),dataSourcesWithSpecificType}traverseToGetDataSourcesByType(type,dataSource,dataSourcesWithSpecificType){if(!type||!dataSource||!dataSourcesWithSpecificType)return;dataSource.type===type&&dataSourcesWithSpecificType.push(dataSource);const childDataSources=dataSource.isDataSourceSet()&&dataSource.getChildDataSources();childDataSources&&childDataSources.forEach((childDataSource=>{this.traverseToGetDataSourcesByType(type,childDataSource,dataSourcesWithSpecificType)}))}createMap(){return map_data_source_impl_awaiter(this,void 0,void 0,(function*(){var _a;const modules=yield(0,jimu_core.e$n)(["esri/Map","esri/layers/FeatureLayer"]),Map=modules[0],FeatureLayer=modules[1];this.map=new Map,null===(_a=this.getDataSourceJson().layers)||void 0===_a||_a.forEach((layer=>{this.map.layers.add(new FeatureLayer(layer))}))}))}createChildDataSourceByLayer(layer,jimuChildId,childDsId,order){var _a,_b,_c;const schemaInConfig=(null===(_b=null===(_a=this.getDataSourceJson().schema)||void 0===_a?void 0:_a.childSchemas)||void 0===_b?void 0:_b[jimuChildId])||null,dsJsonInConfig=(null===(_c=this.getDataSourceJson().childDataSourceJsons)||void 0===_c?void 0:_c[jimuChildId])||null,dsJson=jimu_core.ZkX.dataSourceJsonCreator.createDataSourceJsonByJSAPILayer(childDsId,layer,dsJsonInConfig,schemaInConfig),options=dsJson?{id:dsJson.id,dataSourceJson:dsJson,layer,parentDataSource:this,jimuChildId,order}:null;return options?this.dataSourceManager.createDataSource(options):this.dataSourceManager.createDataSource(childDsId,null,null,!0)}findLayerInfo(childId){let layerInfo;return this.getLayersAndTables().some(((l,i)=>this.getChildIdByLayer(l)===childId&&(layerInfo={layer:l,order:i},!0))),layerInfo}getLayersAndTables(){if(!this.map)return[];const layers=this.map.layers.toArray().reverse(),groundLayers=this.map.ground.layers.toArray().reverse(),tables=(this.map.tables?this.map.tables.toArray():[]).reverse();return layers.concat(groundLayers).concat(tables)}getChildIdByLayer(layer){return jimu_core.ZkX.getFixedLayerIdByLayer(layer)}createFilterUrlChildDataSource(){const dataSourceInfo=(0,jimu_core.Vp3)().getState().dataSourcesInfo;return Promise.all(Object.keys(dataSourceInfo||{}).filter((dsId=>{var _a;return(null===(_a=dataSourceInfo[dsId].widgetQueries)||void 0===_a?void 0:_a._filterInUrl)&&this.findChildDataSourceIdByDescendantDataSourceId(dsId)})).map((dsId=>this.createDataSourceById(dsId)))).then((()=>null)).catch((err=>{console.error("create filter url child data sources error",err)}))}}var webmap_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class WebMapDataSourceImpl extends(item_mixin_ItemMixinImpl(MapDataSourceImpl)){constructor(options){super(options),this.type=jimu_core.hg5.WebMap;const dsJson=this.getDataSourceJson();this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId}createMap(){return webmap_data_source_impl_awaiter(this,void 0,void 0,(function*(){const modules=yield(0,jimu_core.e$n)(["esri/WebMap","esri/portal/Portal","esri/portal/PortalItem"]),WebMap=modules[0],Portal=modules[1],PortalItem=modules[2];if(this.getDataSourceJson().portalUrl){const portal=new Portal({url:jimu_core.zJ_.getPlatformUrlByOrgUrl(this.getDataSourceJson().portalUrl)});this.map=new WebMap({portalItem:new PortalItem({id:this.getDataSourceJson().itemId,portal})})}else this.map=new WebMap({portalItem:new PortalItem({id:this.getDataSourceJson().itemId})});this.map.isFulfilled()?this.initItem():yield this.map.load().then((()=>{this.initItem()}))}))}initItem(){var _a;this.map&&(this.setItemData(this.map.resourceInfo),this.setItemInfo(null===(_a=this.map.portalItem)||void 0===_a?void 0:_a.sourceJSON))}}var webscene_data_source_impl_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class WebSceneDataSourceImpl extends(item_mixin_ItemMixinImpl(MapDataSourceImpl)){constructor(options){super(options),this.type=jimu_core.hg5.WebScene;const dsJson=this.getDataSourceJson();this.portalUrl=dsJson.portalUrl,this.itemId=dsJson.itemId}createMap(){return webscene_data_source_impl_awaiter(this,void 0,void 0,(function*(){const modules=yield(0,jimu_core.e$n)(["esri/WebScene","esri/portal/Portal","esri/portal/PortalItem"]),WebScene=modules[0],Portal=modules[1],PortalItem=modules[2];if(this.getDataSourceJson().portalUrl){const portal=new Portal({url:jimu_core.zJ_.getPlatformUrlByOrgUrl(this.getDataSourceJson().portalUrl)});this.map=new WebScene({portalItem:new PortalItem({id:this.getDataSourceJson().itemId,portal})})}else this.map=new WebScene({portalItem:new PortalItem({id:this.getDataSourceJson().itemId})});this.map.isFulfilled()?this.initItem():yield this.map.load().then((()=>{this.initItem()}))}))}initItem(){var _a;this.map&&(this.setItemData(this.map.resourceInfo),this.setItemInfo(null===(_a=this.map.portalItem)||void 0===_a?void 0:_a.sourceJSON))}}const jimu_data_source=class JimuDataSourceFactory{createDataSource(options){var _a;const dsJson=null!==(_a=options.dataSourceJson)&&void 0!==_a?_a:options.belongToDataSource.getMainDataSource().getDataSourceJson(),dsType=options.dataViewId&&dsJson.dataViews&&dsJson.dataViews[options.dataViewId]&&dsJson.dataViews[options.dataViewId].type||dsJson.type;switch(dsType){case jimu_core.hg5.Error:return new ErrorDataSourceImpl(options);case jimu_core.hg5.CSV:return new CSVDataSourceImpl(options);case jimu_core.hg5.FeatureLayer:return new FeatureLayerDataSourceImpl(options);case jimu_core.hg5.FeatureService:return new feature_service_data_source_impl_FeatureServiceDataSourceImpl(options);case jimu_core.hg5.GroupLayer:return new group_layer_data_source_impl_GroupLayerDataSourceImpl(options);case jimu_core.hg5.MapService:return new map_service_data_source_impl_MapServiceDataSourceImpl(options);case jimu_core.hg5.SceneService:return new scene_service_data_source_impl_SceneServiceDataSourceImpl(options);case jimu_core.hg5.ImageryLayer:return new ImageryLayerDataSourceImpl(options);case jimu_core.hg5.ImageryTileLayer:return new ImageryTileLayerDataSourceImpl(options);case jimu_core.hg5.ElevationLayer:return new ElevationLayerDataSourceImpl(options);case jimu_core.hg5.OrientedImageryLayer:return new OrientImageryLayerDataSourceImpl(options);case jimu_core.hg5.SubtypeGroupLayer:return new SubtypeGroupLayerDataSourceImpl(options);case jimu_core.hg5.SubtypeSublayer:return new SubtypeSublayerDataSourceImpl(options);case jimu_core.hg5.VectorTileService:return new VectorTileServiceDataSourceImpl(options);case jimu_core.hg5.GeoJSON:return new GeoJSONDataSourceImpl(options);case jimu_core.hg5.KML:return new KMLDataSourceImpl(options);case jimu_core.hg5.WFS:return new WFSDataSourceImpl(options);case jimu_core.hg5.WMS:return new WMSDataSourceImpl(options);case jimu_core.hg5.WMTS:return new WMTSDataSourceImpl(options);case jimu_core.hg5.SceneLayer:return new SceneLayerDataSourceImpl(options);case jimu_core.hg5.SimpleLocal:return new SimpleLocalDataSourceImpl(options);case jimu_core.hg5.BuildingSceneLayer:return new BuildingSceneLayerDataSourceImpl(options);case jimu_core.hg5.BuildingComponentSubLayer:return new BuildingComponentSubLayerDataSourceImpl(options);case jimu_core.hg5.BuildingGroupSubLayer:return new BuildingGroupSubLayerDataSourceImpl(options);case jimu_core.hg5.Map:return new MapDataSourceImpl(options);case jimu_core.hg5.WebMap:return new WebMapDataSourceImpl(options);case jimu_core.hg5.WebScene:return new WebSceneDataSourceImpl(options);default:throw`Unhandled case: ${dsType}`}}};try{FeatureServiceDataSourceImpl.displayName="FeatureServiceDataSourceImpl",FeatureServiceDataSourceImpl.__docgenInfo={description:"Data source from a feature service, which may contain multiple child data sources.",displayName:"FeatureServiceDataSourceImpl",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["../jimu-data-source/index.tsx#FeatureServiceDataSourceImpl"]={docgenInfo:FeatureServiceDataSourceImpl.__docgenInfo,name:"FeatureServiceDataSourceImpl",path:"../jimu-data-source/index.tsx#FeatureServiceDataSourceImpl"})}catch(__react_docgen_typescript_loader_error){}try{GroupLayerDataSourceImpl.displayName="GroupLayerDataSourceImpl",GroupLayerDataSourceImpl.__docgenInfo={description:"Data source from group layer in a map service, or group in map viewer/scene viewer, or feature collection item which contains multiple layers.\nGroup layer data source may contain multiple child data sources.",displayName:"GroupLayerDataSourceImpl",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["../jimu-data-source/index.tsx#GroupLayerDataSourceImpl"]={docgenInfo:GroupLayerDataSourceImpl.__docgenInfo,name:"GroupLayerDataSourceImpl",path:"../jimu-data-source/index.tsx#GroupLayerDataSourceImpl"})}catch(__react_docgen_typescript_loader_error){}try{MapServiceDataSourceImpl.displayName="MapServiceDataSourceImpl",MapServiceDataSourceImpl.__docgenInfo={description:"Data source from a map service, which may contain multiple child data sources.",displayName:"MapServiceDataSourceImpl",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["../jimu-data-source/index.tsx#MapServiceDataSourceImpl"]={docgenInfo:MapServiceDataSourceImpl.__docgenInfo,name:"MapServiceDataSourceImpl",path:"../jimu-data-source/index.tsx#MapServiceDataSourceImpl"})}catch(__react_docgen_typescript_loader_error){}try{SceneServiceDataSourceImpl.displayName="SceneServiceDataSourceImpl",SceneServiceDataSourceImpl.__docgenInfo={description:"Data source from a scene service, which may contain multiple child data sources.",displayName:"SceneServiceDataSourceImpl",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["../jimu-data-source/index.tsx#SceneServiceDataSourceImpl"]={docgenInfo:SceneServiceDataSourceImpl.__docgenInfo,name:"SceneServiceDataSourceImpl",path:"../jimu-data-source/index.tsx#SceneServiceDataSourceImpl"})}catch(__react_docgen_typescript_loader_error){}try{AbstractDataSource.displayName="AbstractDataSource",AbstractDataSource.__docgenInfo={description:"Include the common implementations for data source.",displayName:"AbstractDataSource",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["../jimu-data-source/index.tsx#AbstractDataSource"]={docgenInfo:AbstractDataSource.__docgenInfo,name:"AbstractDataSource",path:"../jimu-data-source/index.tsx#AbstractDataSource"})}catch(__react_docgen_typescript_loader_error){}try{AbstractLayerFolderDataSource.displayName="AbstractLayerFolderDataSource",AbstractLayerFolderDataSource.__docgenInfo={description:"* Common operations for folder-like services, such as feature service, scene service, map service, group layer, etc, are grouped in this class.\nplease see {@link SupportedLayerServiceTypes} to find supported layer service types.",displayName:"AbstractLayerFolderDataSource",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["../jimu-data-source/index.tsx#AbstractLayerFolderDataSource"]={docgenInfo:AbstractLayerFolderDataSource.__docgenInfo,name:"AbstractLayerFolderDataSource",path:"../jimu-data-source/index.tsx#AbstractLayerFolderDataSource"})}catch(__react_docgen_typescript_loader_error){}try{AbstractDataRecord.displayName="AbstractDataRecord",AbstractDataRecord.__docgenInfo={description:"Include the common implementations for data record.",displayName:"AbstractDataRecord",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["../jimu-data-source/index.tsx#AbstractDataRecord"]={docgenInfo:AbstractDataRecord.__docgenInfo,name:"AbstractDataRecord",path:"../jimu-data-source/index.tsx#AbstractDataRecord"})}catch(__react_docgen_typescript_loader_error){}try{ItemMixinImpl.displayName="ItemMixinImpl",ItemMixinImpl.__docgenInfo={description:"",displayName:"ItemMixinImpl",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["../jimu-data-source/index.tsx#ItemMixinImpl"]={docgenInfo:ItemMixinImpl.__docgenInfo,name:"ItemMixinImpl",path:"../jimu-data-source/index.tsx#ItemMixinImpl"})}catch(__react_docgen_typescript_loader_error){}try{JSAPILayerMixinImpl.displayName="JSAPILayerMixinImpl",JSAPILayerMixinImpl.__docgenInfo={description:"",displayName:"JSAPILayerMixinImpl",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["../jimu-data-source/index.tsx#JSAPILayerMixinImpl"]={docgenInfo:JSAPILayerMixinImpl.__docgenInfo,name:"JSAPILayerMixinImpl",path:"../jimu-data-source/index.tsx#JSAPILayerMixinImpl"})}catch(__react_docgen_typescript_loader_error){}try{SetDataSourceMixinImpl.displayName="SetDataSourceMixinImpl",SetDataSourceMixinImpl.__docgenInfo={description:"",displayName:"SetDataSourceMixinImpl",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["../jimu-data-source/index.tsx#SetDataSourceMixinImpl"]={docgenInfo:SetDataSourceMixinImpl.__docgenInfo,name:"SetDataSourceMixinImpl",path:"../jimu-data-source/index.tsx#SetDataSourceMixinImpl"})}catch(__react_docgen_typescript_loader_error){}}}]);