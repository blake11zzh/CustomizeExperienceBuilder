/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.32/esri/copyright.txt for details.
*/
import t from"../../../core/Error.js";import e from"../../../core/Logger.js";import{isPromiseLike as r}from"../../../core/promiseUtils.js";import{isLoadedSharedTemplate as o,isSharedFeatureTemplate as n,isSharedGroupTemplate as i,isSharedPresetTemplate as s}from"../../templateUtils.js";import{createFeatureServiceEdit as p,createPresetServiceEdit as a}from"./support/createServiceEdit.js";import{calculateExtent as l,groupEditsByLayer as m}from"./support/executorUtils.js";import{getBuilder as u}from"./support/getBuilder.js";import{isPoint as c}from"../../../geometry/support/jsonUtils.js";const f=()=>e.getLogger("esri.editing.sharedTemplates.executor.createTemplateExecutor");async function d(e){if(!o(e))throw new t("template-executor:template-not-loaded","The template must be loaded before it can be executed.");if(n(e))return h(e);if(i(e))return y(e);if(s(e))return x(e);throw new t("template-executor:unsupported-template-type","The template type is not supported.")}function h(t){return e=>{const r=[],o=[];p({geometry:e,template:t,edits:r,relationships:o});const n=l(r);return{edits:m(r),relationships:o,primary:r[0]??null,featureExtent:n,rotationPoint:n?.center??null}}}async function y(t){const e=await Promise.all(t.definition.allParts.map(g));return(o,n)=>{const i=[],s=[],p=()=>{const t=l(i);return{edits:m(i),relationships:s,primary:i[0]??null,featureExtent:t,rotationPoint:t?.center??null}};if(null==o)return f().warn("No geometry provided to group template executor. Result will be empty."),p();const a=e.map((e=>e({edits:i,mode:n,parentTemplate:t,relationships:s,shape:o}))).filter(r);return 0===a.length?p():Promise.all(a).then((()=>p()))}}async function g(t){const e=await u(t.builderType);return r=>e.execute({...r,templatePart:t})}function x(e){return(r,o,n=0)=>{if(!c(r))throw new t("template-executor:invalid-input-geometry","The input goemetry for a preset template must be a point.");const i=[],s=[],p=a({geometry:r,template:e,edits:i,relationships:s,rotation:n,mode:o});return{edits:m(i),relationships:s,primary:i[0]??null,featureExtent:l(i),rotationPoint:p}}}export{d as createTemplateExecutor};
