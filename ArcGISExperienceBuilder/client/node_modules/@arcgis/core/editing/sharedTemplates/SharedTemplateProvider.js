/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.32/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../request.js";import r from"../../core/Accessor.js";import{makeHandle as o}from"../../core/handleUtils.js";import{getOrCreateMapValue as s}from"../../core/MapUtils.js";import{abortMaybe as a}from"../../core/maybe.js";import{onAbort as i,throwIfAborted as n,createAbortError as l,throwIfAbortError as c,createResolver as p}from"../../core/promiseUtils.js";import{watch as m}from"../../core/reactiveUtils.js";import{property as d}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/RandomLCG.js";import{subclass as f}from"../../core/accessorSupport/decorators/subclass.js";import{isSharedPresetTemplate as u,isSharedFeatureTemplate as h}from"../templateUtils.js";import{SharedTemplateMissingTemplatesError as y,SharedTemplateLayerResolverError as v,SharedTemplateRequestError as w,SharedTemplateLayerUnavailableError as S}from"./support/sharedTemplateErrors.js";import{isFeatureLayer as g,isSubtypeGroupLayer as b}from"../../layers/support/layerUtils.js";const _=new Map;function j(e,t){return s(_,e,(()=>{const r=new R({layerResolver:t?.layerResolver??U(e),makeSharedTemplateFromJSON:t.makeSharedTemplateFromJSON,view:e});return e.addHandles(o((()=>{_.delete(e),r.destroy()}))),r}))}let R=class extends r{constructor(e){super(e),this._abortController=null,this._cache=new Map,this._pending=new Map,this.layerResolver=null,this.makeSharedTemplateFromJSON=null,this.view=null}initialize(){this.addHandles(m((()=>this.view.spatialReference),(()=>this._reset())))}destroy(){this._abortController=a(this._abortController)}async getTemplates({templateIds:e,featureService:t,signal:r}){const o=this._cache,s=this._pending,a=[],l=new Set,c=new Set,p=Symbol();for(const i of new Set(e)){const e=k(t,i);if(o.has(e))a.push(o.get(e));else if(s.has(e)){const t=s.get(e);t.subscribers.add(p),c.add(t)}else l.add(i),s.set(e,C())}if(a.length===e.length)return a;const m=()=>{for(const{subscribers:e}of c)e.delete(p)},d=i(r,m);try{const e=await this._loadTemplates({templateIds:Array.from(l),featureService:t,signal:r}),o=await Promise.all(Array.from(c).map((({resolver:e})=>e.promise)));a.push(...e),a.push(...o)}catch(f){m();for(const e of l){const r=k(t,e),o=s.get(r);o?.resolver.reject(f),s.delete(r)}throw f}finally{d?.remove()}return n(r),a}async _loadTemplates({templateIds:e,featureService:t,signal:r}){if(0===e.length)return[];const o=this._cache,s=this._pending,a=this._abortController=new AbortController,n=i(r,(()=>{for(const r of e){if(I(s.get(k(t,r))))return}a.abort()})),c=await T({featureService:t,templateIds:e,signal:a.signal,spatialReference:this.view.spatialReference});if(c.length<e.length)throw new y(e,c);const p=await Promise.all(c.map((e=>this._makeTemplate({json:e,featureService:t}))));for(const i of p){const e=k(t,i.templateId),a=s.get(e);!r?.aborted||I(a)?(o.set(e,i),a?.resolver.resolve(i)):a?.resolver.reject(l()),s.delete(e)}return n?.remove(),p}async _makeTemplate({json:e,featureService:t}){const{view:r}=this,o=this.makeSharedTemplateFromJSON(e);o.featureService=t,o.view=r;const{layerIds:s,subtypeCode:a}=o;try{o.layer=await this.layerResolver({featureService:t,layerIds:s,subtypeCode:a})}catch(i){throw new v(o.templateId,i)}if(u(o)&&o.definition){o.definition.spatialReference=r.spatialReference;for(const e of o.definition.allParts)e.geometry&&(e.geometry.spatialReference=r.spatialReference)}if(h(o)&&o.definition?.defaultValues){const e=o.definition.defaultValues,t={},{fieldsIndex:r}=o.layer;for(const s in o.definition.defaultValues)t[r.get(s)?.name??s]=e[s];o.definition.defaultValues=t}return o}_reset(){this._abortController?.abort(),this._cache.clear(),this._pending.clear()}};async function T({templateIds:e,featureService:r,spatialReference:o,signal:s}){const a=`${r.url}/sharedTemplates/templates`,i=await t(a,{query:{f:"json",outSR:o,ids:e.join(",")},signal:s}).catch((t=>{throw c(t),new w(e,t)}));return i.data?.templates??[]}function I(e){return null!=e&&e.subscribers.size>0}function C(){return{resolver:p(),subscribers:new Set}}function k(e,t){return`${e.url}/${t}`}function O(e){return g(e)||b(e)}function U(e){return async({featureService:t,layerIds:r})=>{const o=new Set(r),{allLayers:s,allTables:a}=e.map,i=s.concat(a).find((e=>e.url===t.url&&O(e)&&o.has(e.layerId)));if(null==i)throw new S(r);return i}}e([d()],R.prototype,"_abortController",void 0),e([d()],R.prototype,"_cache",void 0),e([d()],R.prototype,"_pending",void 0),e([d({constructOnly:!0})],R.prototype,"layerResolver",void 0),e([d({constructOnly:!0})],R.prototype,"makeSharedTemplateFromJSON",void 0),e([d({constructOnly:!0})],R.prototype,"view",void 0),R=e([f("esri.editing.sharedTemplates.SharedTemplateProvider")],R);export{R as SharedTemplateProvider,j as getSharedTemplateProvider};
