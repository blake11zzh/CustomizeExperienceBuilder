/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.32/esri/copyright.txt for details.
*/
import{Z as e}from"../chunks/languageUtils.js";import t from"../core/Logger.js";import{getOrCreateMapValue as r}from"../core/MapUtils.js";import{throwIfAborted as n}from"../core/promiseUtils.js";import{addMaybe as i}from"../core/SetUtils.js";import{isFeatureTemplateDefinition as o,isGroupTemplateDefinition as s,isPresetTemplateDefinition as a}from"./sharedTemplates/templateDefinitions/templateDefinitionUtils.js";import{isSubtypeGroupLayer as l,isFeatureLayer as f}from"../layers/support/layerUtils.js";import{getServices as u}from"../undoredo/support/Services.js";const p=()=>t.getLogger("esri.editing.templateUtils");function c(e){return null!=e&&"prototype"in e}function m(e){return d(e)&&!("definition"in e)}function y(e){return d(e)&&"definition"in e}function d(e){return null!=e&&"templateId"in e}function g(e){return y(e)&&"feature"===e?.type&&(null==e.definition||o(e.definition))}function w(e){return y(e)&&"group"===e?.type&&(null==e.definition||s(e.definition))}function A(e){return y(e)&&"preset"===e?.type&&(null==e.definition||a(e.definition))}function h(e){return y(e)&&null!=e?.definition}const j=e=>{if(null==e||"object"!=typeof e)return[];return[..."templates"in e&&Array.isArray(e.templates)?e.templates:[],..."types"in e&&Array.isArray(e.types)?e.types.flatMap((e=>e.templates)):[]]};async function v(e,t,r){if(null==t)return e.map((e=>({layer:e,templates:j(e)})));const i=await M(e,t);n(r);const o=new Map,s=Array.from(i).map((e=>S({serviceInfo:e,out:o,signal:r,view:t}))),a=await Promise.allSettled(s);for(const n of a.filter((e=>"rejected"===e.status)))p().warn("Failed to fetch shared templates for service. Will use standard templates if available.",n.reason);return e.map((e=>({layer:e,templates:o.get(e)??j(e)})))}async function S({serviceInfo:e,out:t,signal:r}){const{featureService:i,layersAndTables:o}=e,s=await b({featureService:i,layers:o.toArray(),signal:r});n(r);for(const[n,a]of s.entries())if(0!==a.length)if(l(n)){const e=L(a),r=[],i=e.get(1/0)??r;for(const o of n.sublayers){const n=e.get(o.subtypeCode)??r;t.set(o,[...n,...i])}}else t.set(n,a)}async function b({featureService:e,layers:t,signal:n}){if(!e.capabilities?.editing.supportsSharedTemplates)return new Map;const i=new Map(t.map((e=>[e.layerId,e]))),o=await e.querySharedTemplates({query:{layers:Array.from(i.keys())},requestOptions:{signal:n}}),s=new Map;for(const a of o)for(const e of a.layerIds)i.has(e)&&r(s,i.get(e),(()=>[])).push(a);return s}async function M(e,t){const r=await u(t).load(),n=new Set;for(const o of e)i(n,U(r,o));return await Promise.all(Array.from(n).map((e=>e.featureService.load()))),n}function U(t,r){return e(r)&&r.parent?t.tablesAndLayersLookup.get(r.parent):f(r)?t.tablesAndLayersLookup.get(r):null}function L(e){const t=new Map;for(const n of e)r(t,n.subtypeCode??1/0,(()=>[])).push(n);return t}export{j as getAllStandardFeatureTemplatesForLayer,U as getServiceInfoForLayer,v as getTemplatesForLayers,h as isLoadedSharedTemplate,g as isSharedFeatureTemplate,w as isSharedGroupTemplate,A as isSharedPresetTemplate,y as isSharedTemplate,m as isSharedTemplateMetadata,d as isSharedTemplateOrMetadata,c as isStandardFeatureTemplate};
