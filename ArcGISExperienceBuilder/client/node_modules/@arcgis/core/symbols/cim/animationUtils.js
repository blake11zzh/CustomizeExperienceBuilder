/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.32/esri/copyright.txt for details.
*/
import t from"../../core/Logger.js";import{animationDebugFlags as e}from"./animationDebugFlags.js";import{defaultCIMValues as r}from"./defaultCIMValues.js";import{AnimatedSymbolRepeatType as n,AnimatedSymbolEasingType as o}from"./enums.js";import{getExtent as i}from"./SDFHelper.js";import{getProcessParam as a,getValue as s,getSize as m}from"./utils.js";import{TimeOrigin as l}from"../../views/2d/engine/webgl/animations/instructions.js";function c(t,e,r){return{transform:P(t,e,r.transform),fromColor:b(t,e,r.fromColor),toColor:g(t,e,r.toColor),colorMix:I(t,e,r.colorMix),toOpacity:T(t,e,r.toOpacity),opacityMix:h(t,e,r.opacityMix),hasAnimations:r.hasAnimations||!!e.animations&&e.animations.length>0}}function f(t){return!e.forceStaticPath&&(e.forceAnimatedPath||t.hasAnimations)}function p(e,r,n){if("CIMCharacterMarker"===r.type)return t.getLogger("animationUtils").error("#handleMarker()","CIM character markers do not support animations"),n;const o=a(e,r,"OffsetX"),i=a(e,r,"OffsetY");if("CIMPictureMarker"===r.type)return{...n,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!0,translation:D([o,i]),rotation:D(0),scale:D(a(e,r,"Size")),parent:n.transform}};const s=r.frame,m=s.ymax-s.ymin;return{...n,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:D([o,i]),rotation:D(0),scale:D({type:"Process",op:"Divide",left:a(e,r,"Size"),right:m}),parent:n.transform}}}function u(t,e){let r=0,n=0;const o="Absolute"!==t.anchorPointUnits;return t.anchorPoint&&(r=-t.anchorPoint.x,n=-t.anchorPoint.y),{...e,transform:{type:"AnimatedTransform",relativeTranslation:o,absoluteScale:!1,translation:D([r,n]),rotation:D(0),scale:D(1),parent:e.transform}}}function y(t,e){return"Absolute"===t.anchorPointUnits?e:u(t,e)}function C(t,e){return"Absolute"!==t.anchorPointUnits?e:u(t,e)}function M(t,e,r){return{...t,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:D([e,r]),rotation:D(0),scale:D(1),parent:t.transform}}}function S(t,e){const r=e?.5*-(e.xmin+e.xmax):0,n=e?.5*-(e.ymin+e.ymax):0;let o=0,a=0;if("x"in t&&"y"in t)o=t.x+r,a=t.y+n;else{const e=i(t);if(e){o=(e[0]+e[2])/2+r,a=(e[1]+e[3])/2+n}}return[o,a]}function d(t,e){switch(e.type){case"CIMPictureMarker":case"CIMVectorMarker":return a(t,e,"Rotation")}return 0}function A(t,e){switch(e.type){case"CIMPointSymbol":case"CIMVectorMarker":return[1,1,1,1];case"CIMSolidStroke":case"CIMSolidFill":return a(t,e,"Color");case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":return a(t,e,"TintColor")}return[1,1,1,1]}function P(t,e,r){return{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:O(t,e),rotation:v(t,e),scale:x(t,e),parent:r}}function b(t,e,r){return{type:"AnimatedColor",color:D(A(t,e)),opacity:D(1),parent:r}}function g(t,e,r){const{animations:n}=e;let o=A(t,e);const i=n?.filter((t=>"CIMSymbolAnimationColor"===t.type))[0];return i&&(o=a(t,i,"ToColor")),{type:"AnimatedColor",color:D(o),opacity:D(1),parent:r}}function I(t,e,r){const{animations:n}=e,o=n?.filter((t=>"CIMSymbolAnimationColor"===t.type))[0];return o?{type:"AnimatedColor",color:D([1,1,1,1]),opacity:{from:0,to:1,timing:k(t,o?.animatedSymbolProperties)},parent:[1,1,1,1]}:r}function T(t,e,r){const{animations:n}=e;let o=D(1);const i=n?.filter((t=>"CIMSymbolAnimationTransparency"===t.type))[0];if(i){o=D({type:"Process",op:"Transparency",value:a(t,i,"ToTransparency")})}return{type:"AnimatedColor",color:D([1,1,1,1]),opacity:o,parent:r}}function h(t,e,r){const{animations:n}=e,o=n?.filter((t=>"CIMSymbolAnimationTransparency"===t.type))[0];return o?{type:"AnimatedColor",color:D([1,1,1,1]),opacity:{from:0,to:1,timing:k(t,o?.animatedSymbolProperties)},parent:[1,1,1,1]}:r}function k(t,e){if(!e)return{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:l.Local,repeatType:n.Loop,easing:o.Linear,playAnimation:1,reverseAnimation:0};const i=a(t,e,"Duration");let m;if(a(t,e,"RandomizeStartTime")){m={type:"Process",op:"Random",min:0,max:i,seed:a(t,e,"RandomizeStartSeed")}}else m=a(t,e,"StartTimeOffset");const c=a(t,e,"RepeatDelay"),f=a(t,e,"PlayAnimation"),p=a(t,e,"ReverseAnimation"),u=s(e.repeatType,r.CIMAnimatedSymbolProperties.repeattype);return{duration:i,startTimeOffset:m,repeatDelay:c,timeOriginSelector:u===n.None?l.Local:l.Global,repeatType:u,easing:s(e.easing,r.CIMAnimatedSymbolProperties.easing),playAnimation:f,reverseAnimation:p}}function x(t,e){const{animations:r}=e;if("CIMPictureMarker"!==e.type&&"CIMVectorMarker"!==e.type&&"CIMPointSymbol"!==e.type)return D(1);let n;n="CIMPictureMarker"===e.type||"CIMVectorMarker"===e.type?a(t,e,"Size"):m(e)||10;const o=r?.filter((t=>"CIMSymbolAnimationScale"===t.type))[0];if(!o){const e=r?.filter((t=>"CIMSymbolAnimationSize"===t.type))[0];if(!e)return D(1);return{from:1,to:{type:"Process",op:"Divide",left:a(t,e,"ToSize"),right:n},timing:k(t,e.animatedSymbolProperties)}}return{from:1,to:a(t,o,"ScaleFactor"),timing:k(t,o.animatedSymbolProperties)}}function O(t,e){const{animations:r}=e,n=r?.filter((t=>"CIMSymbolAnimationOffset"===t.type))[0];if(!n)return D([0,0]);return{from:[0,0],to:[a(t,n,"OffsetX"),a(t,n,"OffsetY")],timing:k(t,n.animatedSymbolProperties)}}function v(t,e){const{animations:r}=e,n=d(t,e),o=r?.filter((t=>"CIMSymbolAnimationRotation"===t.type))[0];if(!o)return D(n);const i=a(t,o,"ToRotation");return{from:n,to:{type:"Process",op:"Cond",condition:a(t,o,"RotateClockwise"),ifTrue:{type:"Process",op:"Add",left:-2*Math.PI,right:i},ifFalse:i},timing:k(t,o.animatedSymbolProperties)}}function D(t){return{from:t,to:t,timing:{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:l.Local,repeatType:n.Loop,easing:o.Linear,playAnimation:1,reverseAnimation:0}}}function L(t){if(null==t)return!1;if("object"!=typeof t)return!1;if(t.animations&&Array.isArray(t.animations)&&t.animations.length>0)return!0;for(const e in t)if(L(t[e]))return!0;return!1}export{L as checkForAnimations,c as getAnimationParams,S as getFrameTranslation,D as getStaticParam,C as handleAbsoluteAnchor,u as handleAnchor,p as handleMarker,y as handleRelativeAnchor,f as shouldUseAnimatedPath,M as translate};
